# Agent Trading System - Complete Information Flow Documentation

## Table of Contents
1. [System Overview](#1-system-overview)
2. [Agent Architecture](#2-agent-architecture)
3. [Complete Information Flow](#3-complete-information-flow)
4. [Phase-by-Phase Breakdown](#4-phase-by-phase-breakdown)
5. [Data Structures](#5-data-structures)
6. [Memory System](#6-memory-system)
7. [Tool Calling Flow](#7-tool-calling-flow)
8. [Position Context System](#8-position-context-system)
9. [Prompt Injection Points](#9-prompt-injection-points)
10. [File Reference](#10-file-reference)

---

## 1. System Overview

### 1.1 High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        MAGELLAN TRADING SYSTEM                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Frontend   â”‚â”€â”€â”€â–¶â”‚  API Layer   â”‚â”€â”€â”€â–¶â”‚   Trading    â”‚â”€â”€â”€â–¶â”‚    OKX     â”‚ â”‚
â”‚  â”‚  (React/TS)  â”‚    â”‚  (FastAPI)   â”‚    â”‚   Meeting    â”‚    â”‚  Exchange  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                   â”‚                   â”‚                    â”‚       â”‚
â”‚         â”‚                   â”‚                   â–¼                    â”‚       â”‚
â”‚         â”‚                   â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚       â”‚
â”‚         â”‚                   â”‚         â”‚  Agent Roundtable â”‚          â”‚       â”‚
â”‚         â”‚                   â”‚         â”‚  (5 Phases)       â”‚          â”‚       â”‚
â”‚         â”‚                   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚       â”‚
â”‚         â”‚                   â”‚                   â”‚                    â”‚       â”‚
â”‚         â–¼                   â–¼                   â–¼                    â–¼       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         SHARED SERVICES                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  Redis  â”‚  â”‚ LLM GW  â”‚  â”‚ Memory  â”‚  â”‚Position â”‚  â”‚ Paper/Live  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  Store  â”‚  â”‚ Service â”‚  â”‚  Store  â”‚  â”‚ Monitor â”‚  â”‚   Trader    â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Core Components

| Component | File Location | Purpose |
|-----------|---------------|---------|
| TradingMeeting | `app/core/trading/trading_meeting.py` | Orchestrates 5-phase trading decision process |
| Agent | `app/core/roundtable/agent.py` | Base agent class with LLM and tool support |
| PositionContext | `app/core/trading/position_context.py` | Current position state for prompt injection |
| AgentMemory | `app/core/trading/agent_memory.py` | Historical performance and learning |
| PositionMonitor | `app/core/trading/position_monitor.py` | Real-time position tracking |
| TradingTools | `app/core/trading/trading_tools.py` | Market data and analysis tools |

---

## 2. Agent Architecture

### 2.1 Agent Roster

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           AGENT ROUNDTABLE                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚     LEADER      â”‚â—€â”€â”€â”€â”€â”€â”€â”€ Moderates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  RISK ASSESSOR  â”‚       â”‚
â”‚  â”‚   (Moderator)   â”‚                              â”‚                 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â”‚ Coordinates                                                      â”‚
â”‚           â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                        ANALYST PANEL                                â”‚     â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”‚
â”‚  â”‚  â”‚  Technical   â”‚ â”‚    Macro     â”‚ â”‚  Sentiment   â”‚ â”‚   Quant    â”‚ â”‚     â”‚
â”‚  â”‚  â”‚   Analyst    â”‚ â”‚  Economist   â”‚ â”‚   Analyst    â”‚ â”‚ Strategist â”‚ â”‚     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚                         â”‚ TRADE EXECUTOR  â”‚                                  â”‚
â”‚                         â”‚ (Phase 5 Only)  â”‚                                  â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Agent Details

| Agent ID | Name | Role | Tools | Phase Active |
|----------|------|------|-------|--------------|
| `TechnicalAnalyst` | Technical Analyst | K-line patterns, technical indicators | `get_btc_price`, `get_technical_indicators`, `get_funding_rate` | 1, 2 |
| `MacroEconomist` | Macro Economist | Macro economy, monetary policy | `web_search`, `get_market_news` | 1, 2 |
| `SentimentAnalyst` | Sentiment Analyst | Market sentiment, capital flow | `get_fear_greed_index`, `get_social_sentiment` | 1, 2 |
| `QuantStrategist` | Quant Strategist | Quantitative metrics, statistics | `get_technical_indicators`, `get_historical_data` | 1, 2 |
| `RiskAssessor` | Risk Assessor | Risk evaluation, position sizing | None (advisory) | 3 |
| `Leader` | Meeting Moderator | Synthesize opinions, form consensus | None (summary) | 4 |
| `TradeExecutor` | Trade Executor | Execute trading decisions | `open_long`, `open_short`, `close_position`, `hold` | 5 |

---

## 3. Complete Information Flow

### 3.1 End-to-End Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              COMPLETE INFORMATION FLOW                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    START
                                      â”‚
                                      â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   1. TRIGGER (Scheduler/Manual)     â”‚
                    â”‚   - Every 4 hours (configurable)    â”‚
                    â”‚   - Manual trigger via API          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   2. CONTEXT GATHERING              â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚   â”‚ â€¢ Get current position        â”‚ â”‚
                    â”‚   â”‚ â€¢ Get account balance         â”‚ â”‚
                    â”‚   â”‚ â€¢ Get market price            â”‚ â”‚
                    â”‚   â”‚ â€¢ Build PositionContext       â”‚ â”‚
                    â”‚   â”‚ â€¢ Load agent memories         â”‚ â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                     â”‚
                    â–¼                                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Has Position = TRUE  â”‚           â”‚  Has Position = FALSE â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ Direction: LONG â”‚  â”‚           â”‚  â”‚ Free to open    â”‚  â”‚
        â”‚  â”‚ Entry: $98,000  â”‚  â”‚           â”‚  â”‚ new position    â”‚  â”‚
        â”‚  â”‚ P&L: +$500      â”‚  â”‚           â”‚  â”‚                 â”‚  â”‚
        â”‚  â”‚ Leverage: 5x    â”‚  â”‚           â”‚  â”‚                 â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                                     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘              PHASE 1: MARKET ANALYSIS                   â•‘
            â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â•‘
            â•‘  â”‚ Each analyst receives:                              â”‚â•‘
            â•‘  â”‚ â€¢ System prompt (role definition)                   â”‚â•‘
            â•‘  â”‚ â€¢ Position context summary                          â”‚â•‘
            â•‘  â”‚ â€¢ Agent memory context                              â”‚â•‘
            â•‘  â”‚ â€¢ Analysis prompt                                   â”‚â•‘
            â•‘  â”‚                                                     â”‚â•‘
            â•‘  â”‚ Each analyst:                                       â”‚â•‘
            â•‘  â”‚ 1. Calls tools to get market data                   â”‚â•‘
            â•‘  â”‚ 2. Analyzes data based on expertise                 â”‚â•‘
            â•‘  â”‚ 3. Outputs market analysis text                     â”‚â•‘
            â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                         â”‚
                                         â–¼
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘             PHASE 2: SIGNAL GENERATION                  â•‘
            â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â•‘
            â•‘  â”‚ Each analyst receives vote prompt:                  â”‚â•‘
            â•‘  â”‚ â€¢ Previous analysis context                         â”‚â•‘
            â•‘  â”‚ â€¢ Position context summary                          â”‚â•‘
            â•‘  â”‚ â€¢ Decision options matrix                           â”‚â•‘
            â•‘  â”‚ â€¢ JSON output requirements                          â”‚â•‘
            â•‘  â”‚                                                     â”‚â•‘
            â•‘  â”‚ Each analyst outputs JSON:                          â”‚â•‘
            â•‘  â”‚ {                                                   â”‚â•‘
            â•‘  â”‚   "direction": "long/short/hold",                   â”‚â•‘
            â•‘  â”‚   "confidence": 0-100,                              â”‚â•‘
            â•‘  â”‚   "leverage": 1-20,                                 â”‚â•‘
            â•‘  â”‚   "take_profit_percent": float,                     â”‚â•‘
            â•‘  â”‚   "stop_loss_percent": float,                       â”‚â•‘
            â•‘  â”‚   "reasoning": "..."                                â”‚â•‘
            â•‘  â”‚ }                                                   â”‚â•‘
            â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â•‘
            â•‘                                                         â•‘
            â•‘  Vote Collection:                                       â•‘
            â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â•‘
            â•‘  â”‚Technicalâ”‚  Macro  â”‚Sentimentâ”‚  Quant  â”‚             â•‘
            â•‘  â”‚  LONG   â”‚  LONG   â”‚  HOLD   â”‚  LONG   â”‚             â•‘
            â•‘  â”‚  75%    â”‚  70%    â”‚  55%    â”‚  80%    â”‚             â•‘
            â•‘  â”‚  6x     â”‚  5x     â”‚  3x     â”‚  8x     â”‚             â•‘
            â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                         â”‚
                                         â–¼
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘             PHASE 3: RISK ASSESSMENT                    â•‘
            â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â•‘
            â•‘  â”‚ Risk Assessor receives:                             â”‚â•‘
            â•‘  â”‚ â€¢ Vote summary (3 Long, 1 Hold)                     â”‚â•‘
            â•‘  â”‚ â€¢ Position context                                  â”‚â•‘
            â•‘  â”‚ â€¢ Risk context (liquidation distance, warnings)     â”‚â•‘
            â•‘  â”‚                                                     â”‚â•‘
            â•‘  â”‚ Risk Assessor evaluates:                            â”‚â•‘
            â•‘  â”‚ â€¢ Is entry direction justified?                     â”‚â•‘
            â•‘  â”‚ â€¢ Is leverage appropriate for confidence?           â”‚â•‘
            â•‘  â”‚ â€¢ Are TP/SL settings reasonable?                    â”‚â•‘
            â•‘  â”‚ â€¢ Does position size fit risk limits?               â”‚â•‘
            â•‘  â”‚                                                     â”‚â•‘
            â•‘  â”‚ Outputs: Risk assessment and recommendations        â”‚â•‘
            â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                         â”‚
                                         â–¼
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘            PHASE 4: CONSENSUS BUILDING                  â•‘
            â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â•‘
            â•‘  â”‚ Leader (Moderator) receives:                        â”‚â•‘
            â•‘  â”‚ â€¢ Full conversation history                         â”‚â•‘
            â•‘  â”‚ â€¢ Position context                                  â”‚â•‘
            â•‘  â”‚ â€¢ Decision guidance matrix                          â”‚â•‘
            â•‘  â”‚                                                     â”‚â•‘
            â•‘  â”‚ Leader summarizes:                                  â”‚â•‘
            â•‘  â”‚ â€¢ Expert consensus (3/4 bullish)                    â”‚â•‘
            â•‘  â”‚ â€¢ Key reasons from each expert                      â”‚â•‘
            â•‘  â”‚ â€¢ Risk assessment conclusions                       â”‚â•‘
            â•‘  â”‚ â€¢ Overall market judgment                           â”‚â•‘
            â•‘  â”‚ â€¢ Recommended strategy                              â”‚â•‘
            â•‘  â”‚ â€¢ Confidence level                                  â”‚â•‘
            â•‘  â”‚                                                     â”‚â•‘
            â•‘  â”‚ Outputs: Natural language meeting summary           â”‚â•‘
            â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                         â”‚
                                         â–¼
            â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
            â•‘             PHASE 5: TRADE EXECUTION                    â•‘
            â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â•‘
            â•‘  â”‚ TradeExecutor Agent receives:                       â”‚â•‘
            â•‘  â”‚ â€¢ Vote results (3 Long / 0 Short / 1 Hold)          â”‚â•‘
            â•‘  â”‚ â€¢ Position status                                   â”‚â•‘
            â•‘  â”‚ â€¢ Leader's meeting summary                          â”‚â•‘
            â•‘  â”‚                                                     â”‚â•‘
            â•‘  â”‚ TradeExecutor decides via Tool Calling:             â”‚â•‘
            â•‘  â”‚                                                     â”‚â•‘
            â•‘  â”‚ IF high consensus (3-4 votes same direction):       â”‚â•‘
            â•‘  â”‚   â†’ Call open_long() or open_short()                â”‚â•‘
            â•‘  â”‚ IF split opinions:                                  â”‚â•‘
            â•‘  â”‚   â†’ Call hold(reason="...")                         â”‚â•‘
            â•‘  â”‚ IF has opposite position:                           â”‚â•‘
            â•‘  â”‚   â†’ Call close_position() first                     â”‚â•‘
            â•‘  â”‚                                                     â”‚â•‘
            â•‘  â”‚ Tool calculates parameters from votes:              â”‚â•‘
            â•‘  â”‚ â€¢ confidence = weighted_average(votes.confidence)   â”‚â•‘
            â•‘  â”‚ â€¢ leverage = based_on_consensus_strength            â”‚â•‘
            â•‘  â”‚ â€¢ amount_percent = based_on_confidence              â”‚â•‘
            â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â•‘
            â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                         â”‚
                                         â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   6. TRADE EXECUTION RESULT         â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚   â”‚ TradingSignal:                â”‚ â”‚
                    â”‚   â”‚ â€¢ direction: "long"           â”‚ â”‚
                    â”‚   â”‚ â€¢ leverage: 6x                â”‚ â”‚
                    â”‚   â”‚ â€¢ amount_percent: 0.2 (20%)   â”‚ â”‚
                    â”‚   â”‚ â€¢ confidence: 75%             â”‚ â”‚
                    â”‚   â”‚ â€¢ entry_price: $98,500        â”‚ â”‚
                    â”‚   â”‚ â€¢ take_profit: $103,425       â”‚ â”‚
                    â”‚   â”‚ â€¢ stop_loss: $96,530          â”‚ â”‚
                    â”‚   â”‚ â€¢ reasoning: "..."            â”‚ â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                     â”‚
                    â–¼                                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Direction != "hold"  â”‚           â”‚  Direction == "hold"  â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ Execute trade   â”‚  â”‚           â”‚  â”‚ No trade action â”‚  â”‚
        â”‚  â”‚ via OKX/Paper   â”‚  â”‚           â”‚  â”‚                 â”‚  â”‚
        â”‚  â”‚ trader          â”‚  â”‚           â”‚  â”‚                 â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                                     â”‚
                    â–¼                                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
        â”‚  7. RECORD PREDICTIONSâ”‚                        â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                        â”‚
        â”‚  â”‚ For each agent: â”‚  â”‚                        â”‚
        â”‚  â”‚ â€¢ direction     â”‚  â”‚                        â”‚
        â”‚  â”‚ â€¢ confidence    â”‚  â”‚                        â”‚
        â”‚  â”‚ â€¢ reasoning     â”‚  â”‚                        â”‚
        â”‚  â”‚ â€¢ market_price  â”‚  â”‚                        â”‚
        â”‚  â”‚ â†’ PredictionStoreâ”‚ â”‚                        â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
                    â”‚                                     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   8. POSITION MONITORING            â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚   â”‚ PositionMonitor runs every    â”‚ â”‚
                    â”‚   â”‚ 60 seconds:                   â”‚ â”‚
                    â”‚   â”‚ â€¢ Check current price         â”‚ â”‚
                    â”‚   â”‚ â€¢ Calculate unrealized P&L    â”‚ â”‚
                    â”‚   â”‚ â€¢ Check TP/SL distance        â”‚ â”‚
                    â”‚   â”‚ â€¢ Detect position closed      â”‚ â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ When position closes
                                      â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   9. REFLECTION GENERATION          â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚   â”‚ For each agent:               â”‚ â”‚
                    â”‚   â”‚ 1. Retrieve prediction        â”‚ â”‚
                    â”‚   â”‚ 2. Compare with result        â”‚ â”‚
                    â”‚   â”‚ 3. Generate reflection (LLM)  â”‚ â”‚
                    â”‚   â”‚    â€¢ what_went_well           â”‚ â”‚
                    â”‚   â”‚    â€¢ what_went_wrong          â”‚ â”‚
                    â”‚   â”‚    â€¢ lessons_learned          â”‚ â”‚
                    â”‚   â”‚ 4. Update AgentMemory         â”‚ â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   10. MEMORY UPDATED                â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                    â”‚   â”‚ Each agent's memory now has:  â”‚ â”‚
                    â”‚   â”‚ â€¢ Updated win_rate            â”‚ â”‚
                    â”‚   â”‚ â€¢ Updated total_pnl           â”‚ â”‚
                    â”‚   â”‚ â€¢ New lessons_learned         â”‚ â”‚
                    â”‚   â”‚ â€¢ last_trade_summary          â”‚ â”‚
                    â”‚   â”‚ â€¢ current_focus               â”‚ â”‚
                    â”‚   â”‚                               â”‚ â”‚
                    â”‚   â”‚ This memory will be injected  â”‚ â”‚
                    â”‚   â”‚ into next meeting's prompts!  â”‚ â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                                    END
                              (Wait for next cycle)
```

---

## 4. Phase-by-Phase Breakdown

### 4.1 Phase 1: Market Analysis

#### Input
```python
# System message
agent_id: "system"
agent_name: "System"
content: "## Phase 1: Market Analysis\n\nAnalysts, please analyze current market conditions."

# For each analyst (TechnicalAnalyst, MacroEconomist, SentimentAnalyst, QuantStrategist)
prompt = f"""
{agent.system_prompt}

---
{memory_context}  # Injected from AgentMemory.get_context_for_prompt()
---

Please reference your historical performance and lessons learned...

{position_context.to_summary()}  # Current position status

{neutral_position_analysis_prompt}  # Anti-bias prompt

Please analyze the current BTC market...
"""
```

#### Tool Usage
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent            â”‚ Typical Tools Called                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TechnicalAnalyst â”‚ get_btc_price(), get_technical_indicators(),        â”‚
â”‚                  â”‚ get_funding_rate()                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MacroEconomist   â”‚ web_search("Fed policy"), get_market_news()         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SentimentAnalyst â”‚ get_fear_greed_index(), get_social_sentiment()      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ QuantStrategist  â”‚ get_technical_indicators(), get_historical_data()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Output
Each analyst produces a market analysis text (stored in message_bus)

---

### 4.2 Phase 2: Signal Generation

#### Input
```python
vote_prompt = f"""Based on the above analysis and real-time data...

{position_context.to_summary()}

{decision_options}  # From _get_decision_options_for_analysts()

âš ï¸ **IMPORTANT - Do NOT call decision tools**:
- You are in the "Signal Generation Phase" - only provide **text recommendations**

## ğŸ“‹ Output Requirements

```json
{{
  "direction": "long",
  "confidence": 75,
  "leverage": 6,
  "take_profit_percent": 5.0,
  "stop_loss_percent": 2.0,
  "reasoning": "Brief reasoning with specific data references"
}}
```
"""
```

#### Vote Parsing Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        VOTE PARSING FLOW                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Agent Response                                                          â”‚
â”‚       â”‚                                                                  â”‚
â”‚       â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚ _parse_vote_json()  â”‚â—€â”€â”€â”€â”€ Primary method (JSON parsing)             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚             â”‚                                                            â”‚
â”‚             â”œâ”€â”€â”€â”€â”€ Success â”€â”€â”€â”€â–¶ AgentVote created                      â”‚
â”‚             â”‚                                                            â”‚
â”‚             â–¼ Failure                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚_parse_vote_fallback â”‚â—€â”€â”€â”€â”€ Fallback (text pattern matching)          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚             â”‚                                                            â”‚
â”‚             â”œâ”€â”€â”€â”€â”€ Success â”€â”€â”€â”€â–¶ AgentVote created                      â”‚
â”‚             â”‚                                                            â”‚
â”‚             â–¼ Failure                                                    â”‚
â”‚       Vote not recorded                                                  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

JSON Extraction Strategies (in _extract_json_from_response):
1. ```json ... ``` code blocks
2. ``` ... ``` code blocks (without json tag)
3. Direct {"direction": ...} objects
4. Looser brace matching
```

#### Direction Normalization
```python
direction_map = {
    "long": "long", "åšå¤š": "long", "å¼€å¤š": "long", "buy": "long", "bullish": "long",
    "short": "short", "åšç©º": "short", "å¼€ç©º": "short", "sell": "short", "bearish": "short",
    "hold": "hold", "è§‚æœ›": "hold", "wait": "hold", "neutral": "hold",
    "close": "close", "å¹³ä»“": "close",
    "add_long": "add_long", "add_short": "add_short",
    "reverse": "reverse"
}
```

---

### 4.3 Phase 3: Risk Assessment

#### Input
```python
prompt = f"""Here are the expert voting results:

{votes_summary}
# Example:
# - TechnicalAnalyst: long (confidence 75%, leverage 6x)
# - MacroEconomist: long (confidence 70%, leverage 5x)
# - SentimentAnalyst: hold (confidence 55%, leverage 3x)
# - QuantStrategist: long (confidence 80%, leverage 8x)
#
# Summary: Long 3, Short 0, Hold 1

{position_context.to_summary()}

{risk_context}  # From _generate_risk_context()

Please evaluate the risk of this trade...

âš ï¸ **IMPORTANT**:
- You only need to provide **text recommendations** for risk assessment
- **Do NOT** call any decision tools
"""
```

#### Risk Context Generation
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       RISK CONTEXT STRUCTURE                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  No Position:                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ## ğŸ›¡ï¸ Risk Assessment Focus (No Position)                         â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ **Key Evaluation Points**:                                          â”‚ â”‚
â”‚  â”‚ 1. Is the entry direction well-justified?                           â”‚ â”‚
â”‚  â”‚ 2. Does the leverage match the confidence level?                    â”‚ â”‚
â”‚  â”‚ 3. Are TP/SL settings reasonable?                                   â”‚ â”‚
â”‚  â”‚ 4. Does the position size comply with risk management principles?   â”‚ â”‚
â”‚  â”‚ 5. Is current market volatility suitable for opening a position?    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  Has Position:                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ## ğŸ›¡ï¸ Risk Assessment Focus (Has LONG Position)                   â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ **Current Position Risk**:                                          â”‚ â”‚
â”‚  â”‚ - Risk Level: ğŸŸ¢ Safe / ğŸŸ¡ Warning / ğŸ”´ Danger                      â”‚ â”‚
â”‚  â”‚ - Distance to Liquidation: XX.X%                                    â”‚ â”‚
â”‚  â”‚ - Unrealized P&L: $XXX.XX (+X.XX%)                                  â”‚ â”‚
â”‚  â”‚ - Position Ratio: XX.X%                                             â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ **Risk Warnings**:                                                  â”‚ â”‚
â”‚  â”‚ âš ï¸ Near Take Profit (only X.X%)                                     â”‚ â”‚
â”‚  â”‚ ğŸš¨ Near Stop Loss (only X.X%)                                       â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ **Evaluation Points** (based on expert recommendation type):        â”‚ â”‚
â”‚  â”‚ ### If experts recommend "Continue long/Add"                        â”‚ â”‚
â”‚  â”‚ ### If experts recommend "Close Position"                           â”‚ â”‚
â”‚  â”‚ ### If experts recommend "Reverse"                                  â”‚ â”‚
â”‚  â”‚ ### If experts recommend "Hold"                                     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4.4 Phase 4: Consensus Building

#### Input
```python
prompt = f"""As the roundtable moderator, please comprehensively summarize...

{position_context.to_summary()}

{decision_guidance}  # From _generate_decision_guidance()

## Expert Opinion Summary
You have heard analysis from the following experts:
- Technical Analyst (TechnicalAnalyst): Candlestick patterns, technical indicators
- Macro Economist (MacroEconomist): Macro economy, monetary policy
- Sentiment Analyst (SentimentAnalyst): Market sentiment, capital flow
- Quant Strategist (QuantStrategist): Quantitative indicators, statistics
- Risk Assessor (RiskAssessor): Risk assessment and recommendations

## Your Task
As moderator, please:
1. **Summarize Expert Consensus**: How many bullish/bearish/neutral?
2. **Comprehensive Market Judgment**: Overall view
3. **Risk and Opportunity Assessment**: Main risks and opportunities
4. **Provide Meeting Conclusions**: Recommended strategy

## ğŸ“‹ Output Format
Please express your summary and recommendations freely...
"""
```

#### Decision Guidance Matrix
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DECISION GUIDANCE (Has LONG Position)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  **Current Position Status**: ğŸ“ˆ profit $XXX.XX (+X.XX%)                â”‚
â”‚                                                                          â”‚
â”‚  | Expert Consensus | Relation to Current long | Recommended Action |   â”‚
â”‚  |-----------------|--------------------------|-------------------|     â”‚
â”‚  | Majority short  | ğŸ”´ Opposite              | **Close or Reverse** |  â”‚
â”‚  | Majority long   | ğŸŸ¢ Same                  | Maintain or Add    |   â”‚
â”‚  | Split opinions  | âšª Unclear               | Consider closing   |   â”‚
â”‚  | Unanimous hold  | âšª Neutral               | Hold, tighter SL   |   â”‚
â”‚                                                                          â”‚
â”‚  âš ï¸ **Special Reminders**:                                               â”‚
â”‚  - If consensus opposite to position, **MUST consider closing**          â”‚
â”‚  - Do not avoid changes due to current P&L status                        â”‚
â”‚  - Holding duration should NOT be "sunk cost"                            â”‚
â”‚                                                                          â”‚
â”‚  **Prohibited Behaviors**:                                               â”‚
â”‚  - âŒ Do not force-find reasons to hold                                  â”‚
â”‚  - âŒ Do not ignore reversal recommendations                             â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4.5 Phase 5: Trade Execution

#### TradeExecutor Creation
```python
trade_executor = Agent(
    id="trade_executor",
    name="TradeExecutor",
    role="Trade Execution Specialist",
    system_prompt="""You are the Trade Executor...

You must call a tool to execute decisions. Available tools:
- open_long: Open long position (buy BTC)
- open_short: Open short position (sell BTC)
- close_position: Close current position
- hold: Hold/wait, no action

Decision Rules:
1. Experts 3-4 votes unanimous bullish â†’ Call open_long
2. Experts 3-4 votes unanimous bearish â†’ Call open_short
3. Experts split or unclear â†’ Call hold
4. Has opposite position to close â†’ Call close_position

You MUST call a tool based on meeting results!""",
    temperature=0.3
)
```

#### Execution Prompt
```python
prompt = f"""## Trade Execution Task

### 1. Expert Voting Results
**Summary**: {long_count} Long / {short_count} Short / {hold_count} Hold

  ğŸŸ¢ TechnicalAnalyst: Long
  ğŸŸ¢ MacroEconomist: Long
  âšª SentimentAnalyst: Hold
  ğŸŸ¢ QuantStrategist: Long

### 2. Current Position Status
{position_status}

### 3. Leader's Meeting Summary
{leader_summary}

---

### Your Task
Based on the above information, you **MUST call a tool** to execute the trading decision.

**Decision Rules (based on voting consensus level)**:
- High consensus (4-5 unanimous votes) â†’ Call open_long/open_short
- Moderate consensus (3 votes) â†’ Call open_long/open_short
- Weak consensus (2 votes) â†’ Call open_long/open_short
- Split opinions or unclear â†’ Call hold(reason="...")
- Has opposite position to handle â†’ First call close_position()

**Output Format (must follow)**:
[USE_TOOL: tool_name(param=value, ...)]
"""
```

#### Tool Execution Flow
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     TRADE EXECUTOR TOOL FLOW                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  LLM Response                                                            â”‚
â”‚       â”‚                                                                  â”‚
â”‚       â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚ Check for native tool_calls (OpenAI) â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                 â”‚                                                        â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚       â”‚                   â”‚                                             â”‚
â”‚       â–¼                   â–¼                                             â”‚
â”‚  Has tool_calls      No tool_calls                                      â”‚
â”‚       â”‚                   â”‚                                             â”‚
â”‚       â”‚                   â–¼                                             â”‚
â”‚       â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚       â”‚           â”‚ Check for Legacy format:     â”‚                      â”‚
â”‚       â”‚           â”‚ [USE_TOOL: xxx(...)]         â”‚                      â”‚
â”‚       â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚       â”‚                          â”‚                                       â”‚
â”‚       â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚       â”‚              â”‚                       â”‚                          â”‚
â”‚       â”‚              â–¼                       â–¼                          â”‚
â”‚       â”‚         Has pattern            No pattern                       â”‚
â”‚       â”‚              â”‚                       â”‚                          â”‚
â”‚       â–¼              â–¼                       â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          Return hold signal                 â”‚
â”‚  â”‚ Execute tool function  â”‚          (no tool called)                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚              â”‚                                                           â”‚
â”‚              â–¼                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Tool functions (open_long, open_short, close_position, hold):      â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ 1. Calculate parameters from agent votes:                          â”‚ â”‚
â”‚  â”‚    - confidence = weighted_average(votes)                          â”‚ â”‚
â”‚  â”‚    - leverage = calculate_leverage(consensus_strength)             â”‚ â”‚
â”‚  â”‚    - amount_percent = calculate_amount(confidence, risk_limits)    â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ 2. Get current market price                                        â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ 3. Calculate TP/SL prices:                                         â”‚ â”‚
â”‚  â”‚    tp_price = entry_price * (1 + tp_percent)  # for long           â”‚ â”‚
â”‚  â”‚    sl_price = entry_price * (1 - sl_percent)  # for long           â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ 4. Execute via paper_trader.open_position() or okx_client          â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ 5. Create TradingSignal and store in execution_result              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â”‚                                                           â”‚
â”‚              â–¼                                                           â”‚
â”‚      Return TradingSignal                                                â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Parameter Calculation
```python
# Leverage calculation based on consensus
def calculate_leverage(votes, max_leverage):
    consensus_count = max(long_count, short_count)

    if consensus_count >= 4:  # High consensus
        base_leverage = max_leverage * 0.6
    elif consensus_count == 3:  # Moderate consensus
        base_leverage = max_leverage * 0.4
    else:  # Weak consensus
        base_leverage = max_leverage * 0.25

    # Adjust by average confidence
    avg_confidence = mean([v.confidence for v in matching_votes])
    confidence_factor = avg_confidence / 100

    final_leverage = max(1, min(max_leverage, int(base_leverage * confidence_factor)))
    return final_leverage

# Amount calculation
def calculate_amount_percent(confidence, leverage, risk_limits):
    base_percent = risk_limits.min_position_percent

    # Scale by confidence
    if confidence >= 80:
        base_percent = risk_limits.max_position_percent
    elif confidence >= 60:
        base_percent = (risk_limits.min_position_percent + risk_limits.max_position_percent) / 2

    # Reduce for high leverage
    if leverage > 10:
        base_percent *= 0.7

    return min(base_percent, risk_limits.max_position_percent)
```

---

## 5. Data Structures

### 5.1 TradingSignal
```python
@dataclass
class TradingSignal:
    direction: Literal["long", "short", "hold"]
    symbol: str = "BTC-USDT-SWAP"
    leverage: int  # 1-20
    amount_percent: float  # 0.0-1.0
    entry_price: float
    take_profit_price: float
    stop_loss_price: float
    confidence: int  # 0-100
    reasoning: str
    agents_consensus: Dict[str, str]  # {agent_name: direction}
    timestamp: datetime

    @property
    def risk_reward_ratio(self) -> float:
        """Calculate R:R ratio"""
        if self.direction == "long":
            risk = abs(self.entry_price - self.stop_loss_price)
            reward = abs(self.take_profit_price - self.entry_price)
        else:  # short
            risk = abs(self.stop_loss_price - self.entry_price)
            reward = abs(self.entry_price - self.take_profit_price)
        return reward / risk if risk > 0 else 0.0
```

### 5.2 AgentVote
```python
@dataclass
class AgentVote:
    agent_id: str
    agent_name: str
    direction: Literal["long", "short", "hold"]
    confidence: int  # 0-100
    reasoning: str
    suggested_leverage: int
    suggested_tp_percent: float
    suggested_sl_percent: float
```

### 5.3 PositionContext
```python
@dataclass
class PositionContext:
    # Basic Info
    has_position: bool
    current_position: Optional[dict]

    # Position Details
    direction: Optional[str]  # "long" or "short"
    entry_price: float
    current_price: float
    size: float
    leverage: int
    margin_used: float

    # P&L
    unrealized_pnl: float
    unrealized_pnl_percent: float

    # Risk Metrics
    liquidation_price: Optional[float]
    distance_to_liquidation_percent: float

    # TP/SL
    take_profit_price: Optional[float]
    stop_loss_price: Optional[float]
    distance_to_tp_percent: float
    distance_to_sl_percent: float

    # Account Status
    available_balance: float
    total_equity: float
    used_margin: float

    # Position Limits
    max_position_percent: float
    current_position_percent: float
    can_add_position: bool
    max_additional_amount: float

    # Holding Duration
    opened_at: Optional[datetime]
    holding_duration_hours: float

    def to_summary(self) -> str:
        """Generate human-readable summary for prompt injection"""
        # Returns formatted markdown string
```

### 5.4 AgentMemory
```python
@dataclass
class AgentMemory:
    agent_id: str
    agent_name: str

    # Statistics
    total_trades: int
    winning_trades: int
    losing_trades: int
    total_pnl: float
    win_rate: float
    average_pnl: float
    best_trade_pnl: float
    worst_trade_pnl: float

    # Streaks
    consecutive_wins: int
    consecutive_losses: int
    max_consecutive_wins: int
    max_consecutive_losses: int

    # Learning
    lessons_learned: List[str]
    recent_experiences: List[Dict]
    prediction_accuracy: Dict[str, float]
    strengths: List[str]
    weaknesses: List[str]

    # Reflection System
    recent_reflections: List[Dict]
    last_trade_summary: str
    current_focus: str
    common_mistakes: List[str]

    last_updated: datetime

    def get_context_for_prompt(self) -> str:
        """Generate memory context for system prompt injection"""
        # Returns formatted markdown string
```

---

## 6. Memory System

### 6.1 Memory Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          MEMORY SYSTEM FLOW                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚  â•‘                    DURING TRADING MEETING                          â•‘ â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â”‚
â”‚  â•‘                                                                     â•‘ â”‚
â”‚  â•‘  1. Load Agent Memory                                              â•‘ â”‚
â”‚  â•‘     â”‚                                                              â•‘ â”‚
â”‚  â•‘     â–¼                                                              â•‘ â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘ â”‚
â”‚  â•‘  â”‚ memory = await memory_store.get_memory(agent_id, agent_name)â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ memory_context = memory.get_context_for_prompt()             â”‚  â•‘ â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘ â”‚
â”‚  â•‘     â”‚                                                              â•‘ â”‚
â”‚  â•‘     â–¼                                                              â•‘ â”‚
â”‚  â•‘  2. Inject into System Prompt                                      â•‘ â”‚
â”‚  â•‘     â”‚                                                              â•‘ â”‚
â”‚  â•‘     â–¼                                                              â•‘ â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘ â”‚
â”‚  â•‘  â”‚ enhanced_system_prompt = f"""                                â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ {base_system_prompt}                                         â”‚  â•‘ â”‚
â”‚  â•‘  â”‚                                                              â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ ---                                                          â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ {memory_context}                                             â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ ---                                                          â”‚  â•‘ â”‚
â”‚  â•‘  â”‚                                                              â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ Please reference your historical performance...              â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ """                                                          â”‚  â•‘ â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘ â”‚
â”‚  â•‘                                                                     â•‘ â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                          â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚  â•‘                    AFTER TRADE OPENED                              â•‘ â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â”‚
â”‚  â•‘                                                                     â•‘ â”‚
â”‚  â•‘  3. Record Agent Predictions                                       â•‘ â”‚
â”‚  â•‘     â”‚                                                              â•‘ â”‚
â”‚  â•‘     â–¼                                                              â•‘ â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘ â”‚
â”‚  â•‘  â”‚ for agent_vote in self._agent_votes:                         â”‚  â•‘ â”‚
â”‚  â•‘  â”‚     prediction = AgentPrediction(                            â”‚  â•‘ â”‚
â”‚  â•‘  â”‚         agent_id=agent_vote.agent_id,                        â”‚  â•‘ â”‚
â”‚  â•‘  â”‚         agent_name=agent_vote.agent_name,                    â”‚  â•‘ â”‚
â”‚  â•‘  â”‚         trade_id=position_id,                                â”‚  â•‘ â”‚
â”‚  â•‘  â”‚         direction=agent_vote.direction,                      â”‚  â•‘ â”‚
â”‚  â•‘  â”‚         confidence=agent_vote.confidence,                    â”‚  â•‘ â”‚
â”‚  â•‘  â”‚         reasoning=agent_vote.reasoning,                      â”‚  â•‘ â”‚
â”‚  â•‘  â”‚         market_price=entry_price                             â”‚  â•‘ â”‚
â”‚  â•‘  â”‚     )                                                        â”‚  â•‘ â”‚
â”‚  â•‘  â”‚     await prediction_store.save_prediction(prediction)       â”‚  â•‘ â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘ â”‚
â”‚  â•‘                                                                     â•‘ â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                          â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚  â•‘                    AFTER POSITION CLOSED                           â•‘ â”‚
â”‚  â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â”‚
â”‚  â•‘                                                                     â•‘ â”‚
â”‚  â•‘  4. Generate Reflections                                           â•‘ â”‚
â”‚  â•‘     â”‚                                                              â•‘ â”‚
â”‚  â•‘     â–¼                                                              â•‘ â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘ â”‚
â”‚  â•‘  â”‚ predictions = await prediction_store.get_predictions(trade_id)â”‚ â•‘ â”‚
â”‚  â•‘  â”‚                                                              â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ for prediction in predictions:                               â”‚  â•‘ â”‚
â”‚  â•‘  â”‚     reflection = await generator.generate_reflection(        â”‚  â•‘ â”‚
â”‚  â•‘  â”‚         prediction, trade_result                             â”‚  â•‘ â”‚
â”‚  â•‘  â”‚     )                                                        â”‚  â•‘ â”‚
â”‚  â•‘  â”‚     # reflection contains:                                   â”‚  â•‘ â”‚
â”‚  â•‘  â”‚     # - summary                                              â”‚  â•‘ â”‚
â”‚  â•‘  â”‚     # - what_went_well                                       â”‚  â•‘ â”‚
â”‚  â•‘  â”‚     # - what_went_wrong                                      â”‚  â•‘ â”‚
â”‚  â•‘  â”‚     # - lessons_learned                                      â”‚  â•‘ â”‚
â”‚  â•‘  â”‚     # - next_time_action                                     â”‚  â•‘ â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘ â”‚
â”‚  â•‘     â”‚                                                              â•‘ â”‚
â”‚  â•‘     â–¼                                                              â•‘ â”‚
â”‚  â•‘  5. Update Agent Memory                                            â•‘ â”‚
â”‚  â•‘     â”‚                                                              â•‘ â”‚
â”‚  â•‘     â–¼                                                              â•‘ â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘ â”‚
â”‚  â•‘  â”‚ memory = await memory_store.get_memory(agent_id)             â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ memory.add_reflection(reflection)                            â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ # Updates:                                                   â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ # - total_trades, winning_trades, losing_trades              â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ # - total_pnl, win_rate, average_pnl                         â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ # - best_trade_pnl, worst_trade_pnl                          â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ # - consecutive_wins/losses                                  â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ # - lessons_learned                                          â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ # - last_trade_summary                                       â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ # - current_focus                                            â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ # - common_mistakes                                          â”‚  â•‘ â”‚
â”‚  â•‘  â”‚ await memory_store.save_memory(memory)                       â”‚  â•‘ â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘ â”‚
â”‚  â•‘                                                                     â•‘ â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Memory Context Structure (Injected into Prompts)

```markdown
## ğŸ“Š Last Trade Review
âœ… Last trade: Long BTC, Profit $245.50 (+3.2%)
Lesson: Wait for confirmation before entry

## âš ï¸ Current Focus
Be more cautious with high leverage in volatile markets

## ğŸ“ Lessons You've Learned
- High confidence predictions can also be wrong
- Wait for clearer signals before committing
- Reduce position size in uncertain conditions

## ğŸ“ˆ Your Trading Performance
- Total Trades: 15
- Win Rate: 60.0%
- Total P&L: $1,234.56
- Average P&L: $82.30
- Current Win Streak: 2

## ğŸš« Mistakes to Avoid
- Over-leveraging in sideways markets
- Ignoring macro economic data

## âœ… Your Strengths
- High overall win rate
- Positive average P&L per trade

## ğŸ”§ Areas for Improvement
- Need better risk control for consecutive losses
```

### 6.3 Reflection Generation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      REFLECTION GENERATION FLOW                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Input:                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ AgentPrediction:                  â”‚  TradeResult:                   â”‚ â”‚
â”‚  â”‚ - direction: "long"               â”‚  - entry_price: $98,000         â”‚ â”‚
â”‚  â”‚ - confidence: 75%                 â”‚  - exit_price: $101,000         â”‚ â”‚
â”‚  â”‚ - reasoning: "RSI oversold..."    â”‚  - pnl: +$600                   â”‚ â”‚
â”‚  â”‚ - market_price: $98,500           â”‚  - close_reason: "tp"           â”‚ â”‚
â”‚  â”‚ - key_factors: ["RSI", "MACD"]    â”‚  - holding_hours: 18.5          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  LLM Prompt:                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ You are {agent_name}, please reflect on this trade:                â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ ## Your Prediction at the Time                                      â”‚ â”‚
â”‚  â”‚ - Direction: Long                                                   â”‚ â”‚
â”‚  â”‚ - Confidence: 75%                                                   â”‚ â”‚
â”‚  â”‚ - Reasoning: RSI oversold...                                        â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ ## Actual Result                                                    â”‚ â”‚
â”‚  â”‚ - Entry Price: $98,000                                              â”‚ â”‚
â”‚  â”‚ - Exit Price: $101,000                                              â”‚ â”‚
â”‚  â”‚ - P&L: +$600                                                        â”‚ â”‚
â”‚  â”‚                                                                     â”‚ â”‚
â”‚  â”‚ ## Please Answer:                                                   â”‚ â”‚
â”‚  â”‚ 1. Your prediction was correct - Why?                               â”‚ â”‚
â”‚  â”‚ 2. What judgments were correct?                                     â”‚ â”‚
â”‚  â”‚ 3. What judgments were wrong?                                       â”‚ â”‚
â”‚  â”‚ 4. What lessons did you learn?                                      â”‚ â”‚
â”‚  â”‚ 5. What would you do differently next time?                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  Output (TradeReflection):                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ {                                                                   â”‚ â”‚
â”‚  â”‚   "summary": "Prediction correct, RSI signal was reliable",        â”‚ â”‚
â”‚  â”‚   "what_went_well": ["Entry timing based on RSI", "TP hit"],       â”‚ â”‚
â”‚  â”‚   "what_went_wrong": ["Could have held longer"],                   â”‚ â”‚
â”‚  â”‚   "lessons_learned": ["Trust RSI oversold signals"],               â”‚ â”‚
â”‚  â”‚   "next_time_action": "Consider trailing stop for bigger gains"    â”‚ â”‚
â”‚  â”‚ }                                                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Tool Calling Flow

### 7.1 Native Tool Calling (OpenAI Format)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NATIVE TOOL CALLING FLOW                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  1. Agent._call_llm() with tools defined                                â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ LLM Response (OpenAI Format):                                       â”‚ â”‚
â”‚  â”‚ {                                                                   â”‚ â”‚
â”‚  â”‚   "choices": [{                                                     â”‚ â”‚
â”‚  â”‚     "message": {                                                    â”‚ â”‚
â”‚  â”‚       "content": "Let me analyze...",                               â”‚ â”‚
â”‚  â”‚       "tool_calls": [{                                              â”‚ â”‚
â”‚  â”‚         "id": "call_abc123",                                        â”‚ â”‚
â”‚  â”‚         "type": "function",                                         â”‚ â”‚
â”‚  â”‚         "function": {                                               â”‚ â”‚
â”‚  â”‚           "name": "get_btc_price",                                  â”‚ â”‚
â”‚  â”‚           "arguments": "{}"                                         â”‚ â”‚
â”‚  â”‚         }                                                           â”‚ â”‚
â”‚  â”‚       }]                                                            â”‚ â”‚
â”‚  â”‚     }                                                               â”‚ â”‚
â”‚  â”‚   }]                                                                â”‚ â”‚
â”‚  â”‚ }                                                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  2. Detect tool_calls in response                                       â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  3. Execute each tool:                                                  â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ tool_result = await agent.tools[tool_name].execute(**tool_args)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  4. Collect results                                                     â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  5. Follow-up LLM call with tool results:                              â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ follow_up_messages = [                                              â”‚ â”‚
â”‚  â”‚   {"role": "system", "content": system_prompt},                     â”‚ â”‚
â”‚  â”‚   {"role": "user", "content": original_prompt},                     â”‚ â”‚
â”‚  â”‚   {"role": "assistant", "content": initial_response},               â”‚ â”‚
â”‚  â”‚   {"role": "user", "content": f"Tool results:\n{results}\n\n..."}   â”‚ â”‚
â”‚  â”‚ ]                                                                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  6. Final response with analysis based on real data                    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 Legacy Tool Calling (Text Pattern)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LEGACY TOOL CALLING FLOW                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Pattern: [USE_TOOL: tool_name(param1=value1, param2=value2)]           â”‚
â”‚                                                                          â”‚
â”‚  Example:                                                                â”‚
â”‚  [USE_TOOL: open_long(leverage=6, amount_percent=0.2, confidence=75)]   â”‚
â”‚                                                                          â”‚
â”‚  Regex Pattern:                                                          â”‚
â”‚  r'\[USE_TOOL:\s*(\w+)\s*\(([^)]*)\)\]'                                 â”‚
â”‚                                                                          â”‚
â”‚  Execution:                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ match = re.search(pattern, content)                                 â”‚ â”‚
â”‚  â”‚ if match:                                                           â”‚ â”‚
â”‚  â”‚     tool_name = match.group(1)  # "open_long"                       â”‚ â”‚
â”‚  â”‚     params_str = match.group(2) # "leverage=6, amount_percent=0.2"  â”‚ â”‚
â”‚  â”‚     params = parse_params(params_str)                               â”‚ â”‚
â”‚  â”‚     result = await tools[tool_name](**params)                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 Available Tools

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         TOOL REGISTRY                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Market Data Tools (TradingToolkit):                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Tool Name          â”‚ Description                                  â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ get_btc_price      â”‚ Get current BTC price                        â”‚  â”‚
â”‚  â”‚ get_market_data    â”‚ Get detailed market data (24h change, vol)   â”‚  â”‚
â”‚  â”‚ get_technical_     â”‚ Get RSI, MACD, Bollinger Bands, EMAs         â”‚  â”‚
â”‚  â”‚   indicators       â”‚                                              â”‚  â”‚
â”‚  â”‚ get_funding_rate   â”‚ Get perpetual funding rate                   â”‚  â”‚
â”‚  â”‚ get_fear_greed_    â”‚ Get market fear/greed index                  â”‚  â”‚
â”‚  â”‚   index            â”‚                                              â”‚  â”‚
â”‚  â”‚ web_search         â”‚ Search web for news/analysis                 â”‚  â”‚
â”‚  â”‚ get_market_news    â”‚ Get latest crypto news                       â”‚  â”‚
â”‚  â”‚ get_social_        â”‚ Get social media sentiment                   â”‚  â”‚
â”‚  â”‚   sentiment        â”‚                                              â”‚  â”‚
â”‚  â”‚ get_historical_    â”‚ Get historical price data                    â”‚  â”‚
â”‚  â”‚   data             â”‚                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â”‚  Trading Execution Tools (TradeExecutor):                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Tool Name          â”‚ Description                                  â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ open_long          â”‚ Open long position                           â”‚  â”‚
â”‚  â”‚                    â”‚ Params: leverage, amount_percent, confidence â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ open_short         â”‚ Open short position                          â”‚  â”‚
â”‚  â”‚                    â”‚ Params: leverage, amount_percent, confidence â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ close_position     â”‚ Close current position                       â”‚  â”‚
â”‚  â”‚                    â”‚ Params: reasoning                            â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ hold               â”‚ Hold/wait, no action                         â”‚  â”‚
â”‚  â”‚                    â”‚ Params: reason                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Position Context System

### 8.1 Position Context Generation

```python
async def _get_position_context(self) -> PositionContext:
    """Build complete position context for prompt injection"""

    # 1. Get current position from trader
    position = await self.toolkit.paper_trader.get_position()

    # 2. Get account balance
    balance = await self.toolkit.paper_trader.get_account()

    if not position:
        # No position
        return PositionContext(
            has_position=False,
            available_balance=balance.available_balance,
            total_equity=balance.total_equity,
            max_position_percent=self.config.risk_limits.max_position_percent
        )

    # 3. Calculate derived metrics
    current_price = await self.toolkit._get_market_price()

    # Distance to liquidation
    if position.direction == "long":
        distance_to_liq = ((current_price - position.liquidation_price)
                          / current_price * 100)
    else:
        distance_to_liq = ((position.liquidation_price - current_price)
                          / current_price * 100)

    # Distance to TP/SL
    if position.take_profit_price:
        if position.direction == "long":
            dist_to_tp = ((position.take_profit_price - current_price)
                         / current_price * 100)
        else:
            dist_to_tp = ((current_price - position.take_profit_price)
                         / current_price * 100)

    # 4. Calculate position capacity
    position_value = position.size * current_price
    max_position_value = balance.total_equity * self.config.risk_limits.max_position_percent
    current_position_percent = position_value / balance.total_equity
    can_add = current_position_percent < self.config.risk_limits.max_position_percent
    max_additional = max_position_value - position_value if can_add else 0

    # 5. Build PositionContext
    return PositionContext(
        has_position=True,
        direction=position.direction,
        entry_price=position.entry_price,
        current_price=current_price,
        size=position.size,
        leverage=position.leverage,
        margin_used=position.margin,
        unrealized_pnl=position.unrealized_pnl,
        unrealized_pnl_percent=position.unrealized_pnl_percent,
        liquidation_price=position.liquidation_price,
        distance_to_liquidation_percent=distance_to_liq,
        take_profit_price=position.take_profit_price,
        stop_loss_price=position.stop_loss_price,
        distance_to_tp_percent=dist_to_tp,
        distance_to_sl_percent=dist_to_sl,
        available_balance=balance.available_balance,
        total_equity=balance.total_equity,
        used_margin=balance.used_margin,
        max_position_percent=self.config.risk_limits.max_position_percent,
        current_position_percent=current_position_percent,
        can_add_position=can_add,
        max_additional_amount=max_additional,
        opened_at=position.opened_at,
        holding_duration_hours=(datetime.now() - position.opened_at).total_seconds() / 3600
    )
```

### 8.2 Position Summary Output (to_summary)

```markdown
# When has_position = False:

ğŸ“Š **Current Position Status**: No Position
- Available Balance: $10,000.00 USDT
- Total Equity: $10,000.00 USDT
- Status: âœ… Free to open new position


# When has_position = True (LONG example):

ğŸ“Š **Current Position Status**: Has Position (LONG)

### Position Details
- Direction: **LONG** (5x leverage)
- Entry Price: $98,000.00
- Current Price: $99,500.00
- Position Size: 0.051020 BTC
- Margin Used: $1,000.00 USDT

### Profit & Loss
- ğŸ“ˆ Unrealized P&L: $76.53 USDT (+1.53%)

### Take Profit / Stop Loss
- Take Profit: $103,000.00 (distance: +3.52%)
- Stop Loss: $95,500.00 (distance: -4.02%)

### Risk Metrics
- Liquidation Price: $82,000.00
- Distance to Liquidation: 17.6% (ğŸŸ¡ Warning)

### Account Status
- Available Balance: $8,500.00 USDT
- Total Equity: $10,076.53 USDT
- Used Margin: $1,000.00 USDT

### Position Management
- Current Position: 10.0% / 30.0%
- Status: âœ… Can add more
- Can Add: $2,022.96 USDT

### Holding Duration
- Opened At: 2024-12-07 10:30:45
- Duration: 5.5 hours
```

---

## 9. Prompt Injection Points

### 9.1 Complete Prompt Assembly

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PROMPT INJECTION POINTS                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  SYSTEM PROMPT LAYER:                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. base_system_prompt (from Agent definition)                       â”‚ â”‚
â”‚  â”‚    â†“                                                                â”‚ â”‚
â”‚  â”‚ 2. memory_context (from AgentMemory.get_context_for_prompt())       â”‚ â”‚
â”‚  â”‚    - Last trade review                                              â”‚ â”‚
â”‚  â”‚    - Current focus                                                  â”‚ â”‚
â”‚  â”‚    - Lessons learned                                                â”‚ â”‚
â”‚  â”‚    - Trading performance                                            â”‚ â”‚
â”‚  â”‚    - Mistakes to avoid                                              â”‚ â”‚
â”‚  â”‚    - Strengths/weaknesses                                           â”‚ â”‚
â”‚  â”‚    â†“                                                                â”‚ â”‚
â”‚  â”‚ 3. memory_instruction                                               â”‚ â”‚
â”‚  â”‚    "Please reference your historical performance..."                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â”‚  USER PROMPT LAYER:                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 4. conversation_history (previous messages in meeting)              â”‚ â”‚
â”‚  â”‚    â†“                                                                â”‚ â”‚
â”‚  â”‚ 5. position_context.to_summary()                                    â”‚ â”‚
â”‚  â”‚    - Current position status                                        â”‚ â”‚
â”‚  â”‚    - P&L information                                                â”‚ â”‚
â”‚  â”‚    - Risk metrics                                                   â”‚ â”‚
â”‚  â”‚    - Account status                                                 â”‚ â”‚
â”‚  â”‚    â†“                                                                â”‚ â”‚
â”‚  â”‚ 6. phase_specific_prompt                                            â”‚ â”‚
â”‚  â”‚    - Phase 1: Analysis request                                      â”‚ â”‚
â”‚  â”‚    - Phase 2: Vote prompt + decision options                        â”‚ â”‚
â”‚  â”‚    - Phase 3: Vote summary + risk context                           â”‚ â”‚
â”‚  â”‚    - Phase 4: Decision guidance                                     â”‚ â”‚
â”‚  â”‚    - Phase 5: Execution prompt                                      â”‚ â”‚
â”‚  â”‚    â†“                                                                â”‚ â”‚
â”‚  â”‚ 7. anti_bias_prompts (conditional)                                  â”‚ â”‚
â”‚  â”‚    - neutral_position_analysis_prompt                               â”‚ â”‚
â”‚  â”‚    - decision_options_for_analysts                                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 Injection Point File Locations

| Injection Point | File | Method |
|-----------------|------|--------|
| Base System Prompt | `trading_agents.py` | Agent definition |
| Memory Context | `agent_memory.py` | `AgentMemory.get_context_for_prompt()` |
| Position Summary | `position_context.py` | `PositionContext.to_summary()` |
| Phase 1 Analysis | `trading_meeting.py` | `_run_market_analysis_phase()` |
| Phase 2 Vote | `trading_meeting.py` | `_run_signal_generation_phase()` |
| Phase 3 Risk | `trading_meeting.py` | `_run_risk_assessment_phase()` |
| Phase 4 Consensus | `trading_meeting.py` | `_run_consensus_phase()` |
| Phase 5 Execution | `trading_meeting.py` | `_build_execution_prompt()` |
| Decision Options | `trading_meeting.py` | `_get_decision_options_for_analysts()` |
| Risk Context | `trading_meeting.py` | `_generate_risk_context()` |
| Decision Guidance | `trading_meeting.py` | `_generate_decision_guidance()` |
| Anti-bias Prompt | `trading_meeting.py` | `_get_neutral_position_analysis_prompt()` |

---

## 10. File Reference

### 10.1 Core Trading Files

```
backend/services/report_orchestrator/app/core/trading/
â”œâ”€â”€ trading_meeting.py      # Main orchestrator (5 phases)
â”œâ”€â”€ trading_agents.py       # Agent definitions and prompts
â”œâ”€â”€ trading_tools.py        # Market data tools (TradingToolkit)
â”œâ”€â”€ position_context.py     # Position state for prompt injection
â”œâ”€â”€ position_monitor.py     # Real-time position tracking
â”œâ”€â”€ agent_memory.py         # Memory system (predictions, reflections)
â”œâ”€â”€ trade_executor.py       # Trade execution logic
â”œâ”€â”€ trade_executor_agent.py # TradeExecutor agent implementation
â”œâ”€â”€ paper_trader.py         # Paper trading implementation
â”œâ”€â”€ okx_client.py           # OKX API client
â””â”€â”€ okx_trader.py           # OKX trading implementation
```

### 10.2 Supporting Files

```
backend/services/report_orchestrator/app/
â”œâ”€â”€ models/
â”‚   â””â”€â”€ trading_models.py   # TradingSignal, Position, etc.
â”œâ”€â”€ core/
â”‚   â””â”€â”€ roundtable/
â”‚       â”œâ”€â”€ agent.py        # Base Agent class
â”‚       â”œâ”€â”€ tool.py         # FunctionTool class
â”‚       â””â”€â”€ meeting.py      # Base meeting class
â””â”€â”€ api/
    â””â”€â”€ trading_routes.py   # API endpoints
```

### 10.3 Configuration

```
backend/services/report_orchestrator/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ trading_config.yaml # Trading configuration
â””â”€â”€ .env                    # Environment variables
    # MAX_LEVERAGE=20
    # MAX_POSITION_PERCENT=30
    # MIN_POSITION_PERCENT=10
    # MIN_CONFIDENCE=60
    # SCHEDULER_INTERVAL_HOURS=4
```

---

## Appendix A: Message Flow Example

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SAMPLE MEETING MESSAGE FLOW                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

[System] ## Phase 1: Market Analysis
         Analysts, please analyze current market conditions.

[TechnicalAnalyst] Based on my analysis using get_btc_price() and
                  get_technical_indicators():
                  - Current price: $98,500
                  - RSI(14): 45 (neutral)
                  - MACD: Bullish crossover forming
                  - Support at $97,000, resistance at $100,000

                  Technical outlook: Cautiously bullish with momentum
                  building for a breakout above $100,000.

[MacroEconomist] Based on web_search("Fed policy crypto"):
                - Fed maintaining rates, dovish stance expected
                - Institutional inflows continue
                - Bitcoin ETF seeing positive flows

                Macro environment supportive for crypto growth.

[SentimentAnalyst] Based on get_fear_greed_index():
                  - Fear & Greed Index: 65 (Greed)
                  - Social sentiment: Positive
                  - Funding rates: Slightly positive

                  Sentiment is bullish but not extreme.

[QuantStrategist] Based on statistical analysis:
                 - 30-day volatility: 2.5% (moderate)
                 - Price above 50-day EMA
                 - Volume increasing

                 Quantitative signals favor long positions.

[System] ## Phase 2: Signal Generation
         Experts, please provide your trading recommendations.

[TechnicalAnalyst] ```json
                  {
                    "direction": "long",
                    "confidence": 72,
                    "leverage": 5,
                    "take_profit_percent": 5.0,
                    "stop_loss_percent": 2.5,
                    "reasoning": "MACD crossover with support holding"
                  }
                  ```

[MacroEconomist] ```json
                {
                  "direction": "long",
                  "confidence": 68,
                  "leverage": 4,
                  "take_profit_percent": 6.0,
                  "stop_loss_percent": 3.0,
                  "reasoning": "Favorable macro environment"
                }
                ```

[SentimentAnalyst] ```json
                  {
                    "direction": "hold",
                    "confidence": 55,
                    "leverage": 2,
                    "take_profit_percent": 4.0,
                    "stop_loss_percent": 2.0,
                    "reasoning": "Sentiment positive but greed high"
                  }
                  ```

[QuantStrategist] ```json
                 {
                   "direction": "long",
                   "confidence": 75,
                   "leverage": 6,
                   "take_profit_percent": 5.5,
                   "stop_loss_percent": 2.0,
                   "reasoning": "Strong quantitative signals"
                 }
                 ```

[System] ## Phase 3: Risk Assessment
         Risk Manager, please evaluate the trading risks.

[RiskAssessor] Risk Assessment:

              Vote Summary: 3 Long / 0 Short / 1 Hold

              Risk Evaluation:
              - Consensus is moderate (3/4 bullish)
              - Average confidence: 67.5%
              - Recommended leverage: 4-5x (moderate)

              Recommendation: APPROVE with following adjustments:
              - Leverage: 5x (conservative end)
              - Position size: 20% of equity
              - TP: $103,425 (5%)
              - SL: $96,530 (2%)

              Risk/Reward ratio: 2.5:1 (acceptable)

[System] ## Phase 4: Consensus Building
         Moderator, please summarize and provide conclusions.

[Leader] Meeting Summary:

        Expert Consensus: 3 of 4 experts are bullish (75%)
        - TechnicalAnalyst: Long (MACD crossover)
        - MacroEconomist: Long (favorable macro)
        - SentimentAnalyst: Hold (greed concern)
        - QuantStrategist: Long (strong quant signals)

        Key Agreement Points:
        - Technical setup is favorable
        - Macro environment supportive
        - Price momentum building

        Key Concern:
        - SentimentAnalyst notes greed index is elevated

        Comprehensive Assessment:
        The market shows moderate bullish signals across
        technical, macro, and quantitative dimensions.

        Recommendation:
        Open a conservative LONG position with 5x leverage
        and 20% position size. Set TP at 5% and SL at 2%.

        Confidence: ~70%

[System] ## Phase 5: Trade Execution
         Trade Executor is analyzing and making decisions...

[TradeExecutor] Based on the meeting:
               - 3/4 experts bullish
               - Risk assessment approved
               - Leader recommends LONG

               [USE_TOOL: open_long(leverage=5, amount_percent=0.2)]

[TradeExecutor] ## TradeExecutor Final Decision

               **Decision**: LONG
               **Leverage**: 5x
               **Position**: 20%
               **Confidence**: 70%

               **Take Profit**: $103,425.00
               **Stop Loss**: $96,530.00

               **Reasoning**: Moderate bullish consensus with
               favorable technical and macro conditions.

[TradeExecutor] âœ… Trade Executed

               Decision: LONG
               Leverage: 5x
               Position: 20%

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Appendix B: Configuration Reference

### B.1 Risk Limits

```python
class RiskLimits:
    max_leverage: int = 20          # MAX_LEVERAGE env var
    max_position_percent: float = 0.30   # 30% max position
    min_position_percent: float = 0.10   # 10% min position
    max_daily_loss_percent: float = 0.10 # 10% daily loss limit
    consecutive_loss_limit: int = 3      # Max consecutive losses
    cooldown_hours: int = 24             # Cooldown after losses
    min_confidence: int = 60             # Min confidence to trade
```

### B.2 Trading Config

```python
class TradingConfig:
    analysis_interval_hours: int = 4   # SCHEDULER_INTERVAL_HOURS
    symbol: str = "BTC-USDT-SWAP"     # TRADING_SYMBOL
    initial_capital: float = 10000.0
    risk_limits: RiskLimits
    enabled: bool = True
    demo_mode: bool = False           # OKX_DEMO_MODE

    # Dynamic parameters
    default_tp_percent: float = 5.0
    default_sl_percent: float = 2.0
```

---

*Document Version: 1.0*
*Last Updated: 2024-12-07*
*Author: Magellan Trading System*
