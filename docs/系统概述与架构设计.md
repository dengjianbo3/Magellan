# 麦哲伦计划：系统概述与架构设计

## 1. 执行摘要

本文档旨在全面概述“AI投资分析Agent”（麦哲伦计划）V2版本的现状，详细阐述其核心产品理念、端到端用户旅程、底层系统架构以及驱动分析工作的多智能体协作模型。本系统的核心目标，是将传统的、静态的报告生成过程，转变为一种动态的、交互式的、由人类用户与AI专家团队共同完成的分析合作模式。

---

## 2. 核心产品理念

V2系统建立在三大核心原则之上，旨在提供专业且值得信赖的用户体验：

*   **秩序感与透明度 (Order & Transparency):** 用户面对的不应是一个“黑箱”。系统需要将AI思考过程的每一步都进行可视化，将“等待”变为“监督”。这一理念通过“The Foundry”工作台界面实现，其形态类似于CI/CD流水线。
*   **逻辑严谨性与可控性 (Logical Rigor & Controllability):** 系统的设计旨在传递一种缜密和智能的感觉。在关键节点，工作流会暂停并请求**人工干预 (Human-in-the-Loop)**，以确保分析的准确性，并给予用户最终的控制权。
*   **完整性与交互性 (Completeness & Interactivity):** 最终的交付物不是一份静态的PDF，而是一个动态的、多维度的**“交互式报告”**。这个仪表盘不仅提供结论，还展示了底层数据、可交互的图表以及用于进一步探索的工具（如“Agent助手”）。

---

## 3. 端到端用户旅程

核心用户流程已经通过端到端测试验证，它完整地体现了产品的核心体验。

1.  **在“The Foundry”中启动分析:** 用户进入主视图 `ChatView`（即“The Foundry”工作台）。AI会向用户问好，并提示输入一个公司名称或股票代码（例如，“Apple”）。

2.  **实时工作流可视化:** 提交后，系统会建立一个WebSocket连接。UI界面不会显示一个简单的加载动画，而是开始实时地、一步步地渲染Agent团队的工作日志：
    *   `[运行中] 正在获取用户画像...`
    *   `[成功] 用户画像已加载。`
    *   `[运行中] 正在为'Apple'获取公开数据...`

3.  **人工干预节点1：歧义消除:** `DataCollectorAgent`（数据收集Agent）判断出“Apple”是一个有歧义的词。后端发送一条 `hitl_required` 消息。工作流暂停，前端会向用户展示选项（例如，“苹果公司 (AAPL)” vs “苹果酒店信托 (APLE)”）。

4.  **工作流继续:** 用户点击他们的选择（例如，“AAPL”）。前端通过WebSocket将这个选择发送回后端。后端恢复工作流，同时UI会反映出这个过程：
    *   `[运行中] 正在为AAPL获取已确认的数据...`
    *   `[成功] 数据获取成功。`
    *   `[运行中] 正在使用Gemini生成初步分析...`
    *   `[成功] ...`
    *   `[运行中] 正在为图表获取财务摘要...`
    *   `[成功] ...`
    *   `[运行中] 正在生成关键追问问题...`
    *   `[成功] ...`

5.  **人工干预节点2：关键提问与报告生成:** 在初步分析完成后，后端发送一条 `hitl_follow_up_required` 消息。UI会向用户展示两个选项：
    *   **“立即查看报告”**
    *   “输入回答以深度分析”

6.  **查看“交互式报告”:** 用户点击“立即查看报告”。应用会导航到 `InteractiveReportView` 视图。这是一个三栏式仪表盘：
    *   **左栏:** 可点击的报告章节大纲（例如，“初步分析”、“财务分析”）。
    *   **中栏:** 报告的主要内容，包括初步分析的文本和一份可交互的ECharts财务图表（`<canvas>`元素）。
    *   **右栏:** “Agent助手”，其中展示了由AI生成的关键追问问题。

---

## 4. 系统架构

本系统被设计为一套容器化的微服务，通过WebSocket和REST API的组合进行通信。

### a. 高阶架构图

```
[ 前端 (Vue 3) ] <--- (WebSocket / REST) ---> [ API网关 (通过Docker网络隐式实现) ]
                                                               |
                               +-------------------------------+-------------------------------+
                               |                               |                               |
[ report_orchestrator ] <--> [ user_service ] <--> [ public_data_service ] <--> [ llm_gateway ] ... 等
 (WebSocket, 业务逻辑)         (用户画像)           (yfinance API)             (Gemini API)
```

### b. 前端

*   **框架:** Vue 3 (使用Vite和TypeScript)。
*   **UI库:** Element Plus。
*   **图表库:** ECharts。
*   **核心组件:**
    *   `ChatView.vue`: 实现“The Foundry”工作台界面，管理WebSocket通信，并渲染实时任务流。
    *   `InteractiveReportView.vue`: 实现三栏式的“交互式报告”仪表盘，并包含ECharts财务图表。
*   **通信:** 主要通过WebSocket与 `report_orchestrator` 进行通信以处理主分析流程。对于文件上传等其他功能，则使用标准的REST API调用（通过Axios）。

### c. 后端微服务

所有服务都通过Docker进行容器化，并由 `docker-compose.yml` 文件管理。它们都使用Python及FastAPI框架构建。

*   **`report_orchestrator`:** 系统的“大脑”。它管理核心的分析工作流，通过WebSocket与前端通信，并调用其他微服务来完成具体任务。
*   **`user_service`:** 管理用户画像和偏好设置（例如，投资风格、风险偏好）。
*   **`public_data_service`:** 使用 `yfinance` 库获取公开市场数据和财务摘要。
*   **`llm_gateway`:** 一个专用的服务，作为所有语言模型任务（调用Google Gemini Pro）的统一网关。
*   **解析器服务 (`pdf_parser`, `excel_parser`, `word_parser`):** 一套用于从不同格式文档中提取文本和数据的服务。
*   **`file_service`:** 处理用户上传文件的存储和管理。

### d. 通信协议

*   **主工作流:** 核心的分析旅程通过与 `report_orchestrator` 建立的持久化 **WebSocket** 连接 (`/ws/start_analysis`) 进行处理。这保证了实时的、双向的通信，是实现任务列表实时更新和人工干预节点的关键。
*   **辅助操作:** 标准的 **REST API** 用于处理无状态的请求，例如文件上传 (`/generate_full_report`) 或获取用户数据。

---

## 5. 多智能体协作模型

后端逻辑正从一个简单的脚本演变为一个复杂的多智能体系统。`report_orchestrator` 扮演着总控Agent的角色，指挥一个由多个专家Agent组成的团队。

*   **`OrchestratorAgent` (总控Agent, 位于 `report_orchestrator` 内部):** 管理整个分析图谱的状态。它按顺序调用其他Agent，管理人工干预的暂停节点，并在各个步骤之间路由数据。

*   **`DataCollectorAgent` (数据收集Agent):**
    *   **职责:** 收集所有必需的原始数据。
    *   **工具 (微服务):** 使用 `public_data_service` 获取市场数据，并可使用各类解析器服务处理用户上传的文件。

*   **`AnalysisAgent` (分析Agent):**
    *   **职责:** 将原始数据转化为初步的洞察和摘要。
    *   **工具 (微服务):** 主要使用 `llm_gateway` 进行推理，并使用 `public_data_service` 获取财务图表数据。

*   **`RiskAgent` (风险评估Agent, 隐式):**
    *   **职责:** 从风险规避的角度，生成具有批判性和洞察力的追问问题。
    *   **工具 (微服务):** 使用 `llm_gateway`，并根据用户的画像定制一个特殊的系统提示(System Prompt)。
