# AI 投资报告 Agent - V2 开发计划

## 核心思想：分层实现，体验驱动

本计划旨在将我们的产品从一个功能性的MVP，演进为一个采用“多智能体协作图”架构、并拥有“智能工作站”体验的V2版本。我们将严格遵循“后端Agent核心 -> 前端可视化 -> 交互式报告”的顺序分层构建。

---

### **阶段一：后端改造 - 构建Agentic核心**

**目标：** 将后端从简单的微服务调用模式，升级为由Google Vertex AI驱动的、真正的多智能体架构。此阶段结束时，后端应能通过API，接收一个请求，在Vertex AI上执行一个包含多个步骤的Agent工作流，并返回一个包含所有步骤结果的结构化JSON。

*   **Sprint 1: “Hello, Agent” - 核心连接与认证**
    1.  **任务1 (后端/DevOps):** 配置Google Cloud认证。在我们的后端环境中（无论是本地还是Docker），建立与Vertex AI的安全认证连接。
    2.  **任务2 (后端):** 在Vertex AI Agent Builder中，**手动**创建一个最简单的“数据收集Agent”。为其配置一个工具：我们现有的`public_data_service`。
    3.  **任务3 (后端):** 重构 `report_orchestrator` 服务。移除旧的chat逻辑，创建一个新的 `/start_analysis` 端点。这个端点将接收用户请求，并调用Vertex AI Agent Builder的API来启动我们刚刚创建的Agent工作流。
    4.  **里程碑测试：** **通过API工具（如Postman）调用 `/start_analysis` 端点，传入一个股票代码，应能成功触发Vertex AI上的Agent，该Agent调用`public_data_service`，并将最终结果返回给Orchestrator。这个测试将验证我们与Google Cloud原生Agent架构的端到端连通性。**

---

### **阶段二：前端重构 - “The Foundry”工作台可视化**

**目标：** 构建全新的“智能工作站”前端，并完美地将后端Agent的思考过程可视化，实现您设计的“流程状态监视器”体验。

*   **Sprint 2: “智能驾驶舱”UI搭建**
    1.  **任务1 (前端):** 实现“双核驱动”的主应用框架。创建包含左侧导航栏（“智能探索”、“深度报告”）和右侧主工作区的 `App.vue` 布局。
    2.  **任务2 (前端):** 创建“智能探索舱”的核心UI (`ChatView.vue`)。重点是构建用于展示“任务节点 (Task Node)”的组件，该组件应包含“运行中/成功/失败/暂停”等不同状态的视觉样式。
    3.  **任务3 (前端):** 实现前端“伪流式”渲染逻辑。前端在调用API后，将一次性收到包含所有步骤结果的JSON。前端将通过延时（setTimeout），有节奏地、一步步地将这些任务节点动态地渲染到界面上，从而在视觉上完美模拟出Agent“正在思考”的过程。
    4.  **里程碑测试：** **使用一个模拟的、包含多个步骤的JSON数据，前端应能完整、流畅地渲染出整个“流程状态监视器”的动画效果。**

*   **Sprint 3: 前后端连接与真实流程可视化**
    1.  **任务1 (前端):** 将“智能探索舱”的输入框与后端的 `/start_analysis` 端点连接。
    2.  **任务2 (后端):** 扩展 `Orchestrator` 和Vertex AI中的Agent。使其工作流至少包含三个步骤（如：数据收集、初步分析、生成洞察），并将每一步的结果都记录下来，最终返回一个包含完整步骤记录的JSON。
    3.  **里程碑测试：** **在前端输入一个股票代码，点击发送后，界面上应能真实地、分步骤地可视化后端Agent执行数据收集、分析、生成洞察的全过程。**

---

### **阶段三：核心交互 - 实现Human-in-the-Loop**

**目标：** 将“人工干预”作为核心功能融入我们的工作流，实现产品的“可控性”和“缜密感”。

*   **Sprint 4: 实现“歧义消除”与“深度报告”视图**
    1.  **任务1 (后端):** 在Vertex AI Agent Builder中，为`DataCollectorAgent`之后的工作流节点添加一个“暂停”条件。`Orchestrator`在检测到此暂停状态后，应向前端返回一个包含“HITL_REQUIRED”状态和选项的响应。
    2.  **任务2 (前端):** 在“智能探索舱”中，开发用于处理“歧义消除”的UI（如弹窗或行内选项），并将用户的选择发送回后端以“恢复”工作流。
    3.  **任务3 (前端):** 开发“深度报告生成器”的核心UI (`ReportView.vue`)。实现股票代码输入、多文件上传功能，并将其连接到后端的 `/generate_full_report` 端点（此端点现在将触发一个完整的、无暂停的Agent工作流）。
    4.  **里程碑测试：** **1. 输入一个有歧义的公司名，前端应能正确弹出确认选项。2. 在“深度报告”视图中，上传文件并点击生成，后端应能完整执行一次分析并返回结果。**

---

### **阶段四：最终交付 - “交互式报告”仪表盘**

**目标：** 打造最终的、专业的三栏式报告仪表盘，交付“完整感”，并集成“合理追问”这一核心亮点功能。

*   **Sprint 5: “交互式报告”UI与最终集成**
    1.  **任务1 (前端):** 开发“交互式报告”的三栏式仪表盘UI。重点是左侧的导航大纲、中间的可交互图表/表格，以及右侧的“Agent助手”工具栏。
    2.  **任务2 (后端):** 在Vertex AI中，实现“合理追问”的HITL节点。在核心分析完成后，工作流暂停，并通过`Orchestrator`向前端返回初步报告内容和“关键追问问题”列表。
    3.  **任务3 (前端):** 在“智能探索舱”中，当收到“合理追问”的HITL事件时，界面上应出现相应的提示和选项，允许用户“立即查看报告”或“输入回答”。
    4.  **任务4 (前端):** 当用户选择“立即查看报告”时，应用路由到“交互式报告”视图，并将数据显示在仪表盘中。
    5.  **里程碑测试：** **用户完成一次完整的分析流程，在“智能探索舱”中看到“合理追问”的提示，点击“查看报告”后，能成功跳转到三栏式仪表盘，并看到所有已生成的分析内容被正确地展示出来。至此，V2的MVP核心功能完全闭环。**

---

### **阶段五：实现真正的“交互式报告”**

**目标：** 将静态的报告升级为功能强大的交互式仪表盘，提升产品的专业性和可用性。

*   **Sprint 6: 交互式内容与即时反馈**
    1.  **任务1 (前端):** 在`InteractiveReportView.vue`中，引入图表库（如 ECharts），将报告主体中的静态文本数据替换为可交互的图表和可排序的表格。
    2.  **任务2 (后端):** 扩展`/generate_full_report`和`/continue_analysis`端点，使其能够返回生成图表和表格所需的结构化JSON数据，而不仅仅是格式化的字符串。
    3.  **任务3 (后端):** 创建一个新的API端点（例如`/get_instant_feedback`），该端点接收用户在“Agent助手”中输入的新信息和当前报告的上下文。
    4.  **任务4 (前端):** 将“Agent助手”中的“即时反馈”输入框与新的API端点连接，实现动态分析与报告更新。
    5.  **里程碑测试：** **最终报告仪表盘应能正确显示交互式图表。用户在右侧助手栏输入信息后，应能看到Agent给出的即时反馈。**

---

### **阶段六：优化“The Foundry”工作台体验**

**目标：** 将前端的“流程状态监视器”从“伪流式”升级为实时更新，完美匹配“控制室”的设计理念。

*   **Sprint 7: 实时工作流可视化**
    1.  **任务1 (后端):** 重构`report_orchestrator`的核心通信机制，引入WebSocket或Server-Sent Events (SSE)，以取代一次性的HTTP响应。
    2.  **任务2 (后端):** `OrchestratorAgent`在执行工作流时，应通过WebSocket/SSE连接，向前端实时推送更细粒度的子任务状态更新（例如，“文件解析完成”、“财务数据抓取中…”）。
    3.  **任务3 (前端):** 改造`ChatView.vue`以建立和监听WebSocket/SSE连接。UI现在将根据收到的实时事件，动态地、逐条地更新任务列表，实现真正的CI/CD流水线式视觉效果。
    4.  **里程碑测试：** **在前端点击生成报告后，任务列表不再是一次性加载，而是随着后端Agent的实际工作进度，逐条、实时地显示状态更新。**

---

### **阶段七：构建“Persona”用户画像系统**

**目标：** 引入用户画像功能，实现报告的个性化定制，完成产品“严谨、专业”调性的最后一块拼图。

*   **Sprint 8: 用户画像设定与应用**
    1.  **任务1 (前端):** 创建一个独立的视图，用于实现“首次登录的引导式问卷 (Onboarding Wizard)”。
    2.  **任务2 (后端):** 创建一个新的`user_service`（或在现有服务中扩展），用于存储和管理用户的偏好设置（投资风格、报告模板等）。
    3.  **任务3 (后端):** 将用户偏好设置整合进`OrchestratorAgent`的核心逻辑中。Agent在生成分析和撰写报告时，必须调用`user_service`获取用户画像，并据此调整分析的侧重点和最终报告的排版风格。
    4.  **里程碑测试：** **完成问卷设置后，再次生成报告。报告的投资建议部分应明确体现用户的投资风格（例如，“基于您的‘保守型’偏好…”），报告的结构应符合用户选择的模板。**