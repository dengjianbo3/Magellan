# Project Magellan: System Overview & Architecture

## 1. Executive Summary

This document provides a comprehensive overview of the AI Investment Agent (Project Magellan) in its current V2 state. It details the core product philosophy, the end-to-end user journey, the underlying system architecture, and the multi-agent collaboration model that powers the analysis. The primary goal of this system is to transform the process of investment analysis from a static, report-generation task into a dynamic, interactive partnership between a human user and a team of specialized AI agents.

---

## 2. Core Product Philosophy

The V2 system is built on three core principles designed to deliver a professional and trustworthy user experience:

*   **Order & Transparency:** The user should not be presented with a "black box." The system visualizes every step of the AI's thinking process, turning "waiting" into "supervising." This is achieved through the "Foundry" interface, which resembles a CI/CD pipeline.
*   **Logical Rigor & Controllability:** The system is designed to feel meticulous and intelligent. At critical junctures, the workflow pauses and asks for human intervention (Human-in-the-Loop), ensuring accuracy and giving the user ultimate control.
*   **Completeness & Interactivity:** The final deliverable is not a static PDF but a dynamic, multi-faceted "Interactive Report." This dashboard provides not just conclusions, but also the underlying data, interactive charts, and tools for further exploration, such as the "Agent Assistant."

---

## 3. The End-to-End User Journey

The primary user flow has been validated by end-to-end testing and encapsulates the core product experience.

1.  **Initiation in "The Foundry":** The user navigates to the main `ChatView` ("The Foundry"). They are greeted by the AI and prompted to enter a company name or stock ticker (e.g., "Apple").

2.  **Real-time Workflow Visualization:** Upon submission, the system initiates a WebSocket connection. The UI does not show a simple spinner; instead, it begins rendering a real-time log of the agent team's work, step-by-step:
    *   `[Running] Fetching user persona...`
    *   `[Success] Persona loaded.`
    *   `[Running] Fetching public data for 'Apple'...`

3.  **HITL Node 1: Ambiguity Resolution:** The `DataCollectorAgent` determines that "Apple" is an ambiguous term. The backend sends a `hitl_required` message. The workflow pauses, and the frontend presents the user with choices (e.g., "Apple Inc. (AAPL)" vs. "Apple Hospitality REIT (APLE)").

4.  **Workflow Continuation:** The user clicks their choice (e.g., "AAPL"). The frontend sends this selection back through the WebSocket. The backend resumes the workflow, and the UI reflects this:
    *   `[Running] Fetching confirmed data for AAPL...`
    *   `[Success] Successfully retrieved data.`
    *   `[Running] Generating initial analysis with Gemini...`
    *   `[Success] ...`
    *   `[Running] Fetching financial summary for chart...`
    *   `[Success] ...`
    *   `[Running] Generating key follow-up questions...`
    *   `[Success] ...`

5.  **HITL Node 2: Key Questions & Report Generation:** After the preliminary analysis is complete, the backend sends a `hitl_follow_up_required` message. The UI presents the user with two options:
    *   **"立即查看报告" (View Report Now)**
    *   "输入回答以深度分析" (Enter Answers for Deeper Analysis)

6.  **Viewing "The Interactive Report":** The user clicks "立即查看报告". The application navigates to the `InteractiveReportView`. This view is a three-column dashboard:
    *   **Left Pane:** A clickable outline of the report sections (e.g., "Preliminary Analysis," "Financial Analysis").
    *   **Center Pane:** The main report content, including the initial analysis text and an interactive ECharts financial chart (`<canvas>` element).
    *   **Right Pane:** The "Agent Assistant," which displays the key follow-up questions generated by the AI.

---

## 4. System Architecture

The system is designed as a set of containerized microservices that communicate via a combination of WebSockets and REST APIs.

### a. High-Level Diagram

```
[ Frontend (Vue 3) ] <--- (WebSocket / REST) ---> [ API Gateway (Implicit via Docker Network) ]
                                                               |
                               +-------------------------------+-------------------------------+
                               |                               |                               |
[ report_orchestrator ] <--> [ user_service ] <--> [ public_data_service ] <--> [ llm_gateway ] ... etc
 (WebSocket, Logic)         (User Persona)         (yfinance API)             (Gemini API)
```

### b. Frontend

*   **Framework:** Vue 3 with Vite and TypeScript.
*   **UI Library:** Element Plus.
*   **Charting:** ECharts.
*   **Key Components:**
    *   `ChatView.vue`: Implements "The Foundry" interface, manages WebSocket communication, and renders the real-time task flow.
    *   `InteractiveReportView.vue`: Implements the three-column "Interactive Report" dashboard, including the ECharts financial chart.
*   **Communication:** Primarily communicates with the `report_orchestrator` via a WebSocket connection for the main analysis workflow. Uses standard REST API calls (via Axios) for other functionalities like file uploads.

### c. Backend Microservices

All services are containerized with Docker and managed via `docker-compose.yml`. They are built using Python with the FastAPI framework.

*   **`report_orchestrator`:** The brain of the system. It manages the core analysis workflow, communicates with the frontend via WebSockets, and calls other microservices to fulfill tasks.
*   **`user_service`:** Manages user profiles and personas (e.g., investment style, risk tolerance).
*   **`public_data_service`:** Fetches public market data and financial summaries using the `yfinance` library.
*   **`llm_gateway`:** A dedicated service that acts as a gateway to the Google Gemini Pro model for all language-based tasks.
*   **Parser Services (`pdf_parser`, `excel_parser`, `word_parser`):** A suite of services responsible for extracting text and data from various document formats.
*   **`file_service`:** Handles the storage and management of user-uploaded files.

### d. Communication Protocol

*   **Primary Workflow:** The main analysis journey is handled over a persistent **WebSocket** connection (`/ws/start_analysis`) with the `report_orchestrator`. This allows for real-time, bidirectional communication, which is essential for the live-updating task list and HITL nodes.
*   **Auxiliary Operations:** Standard **REST APIs** are used for stateless requests, such as file uploads (`/generate_full_report`) or fetching user data.

---

## 5. Multi-Agent Collaboration Model

The backend logic is evolving from a simple script into a sophisticated multi-agent system. The `report_orchestrator` acts as the master agent, directing a team of specialized agents.

*   **`OrchestratorAgent` (within `report_orchestrator`):** Manages the overall state of the analysis graph. It calls other agents in sequence, manages the HITL pauses, and routes data between steps.

*   **`DataCollectorAgent`:**
    *   **Responsibility:** Gathers all necessary raw data.
    *   **Tools (Microservices):** Uses `public_data_service` for market data and will use the various parser services for user-uploaded files.

*   **`AnalysisAgent`:**
    *   **Responsibility:** Converts raw data into initial insights and summaries.
    *   **Tools (Microservices):** Primarily uses `llm_gateway` for reasoning and `public_data_service` for financial chart data.

*   **`RiskAgent` (Implicit):**
    *   **Responsibility:** Generates critical and insightful follow-up questions from a risk-averse perspective.
    *   **Tools (Microservices):** Uses `llm_gateway` with a specialized system prompt tailored to the user's persona.
