# AI 投资报告 Agent - V2 后端设计文档

## 1. 核心范式转移：从“线性工作流”到“多智能体协作图”

V2 版本的核心架构，将从一个简单的、由 Orchestrator 顺序调用微服务的线性模式，演进为一个由 **`OrchestratorAgent` (总控Agent)** 管理的**多智能体协作图 (Multi-Agent Graph)**。

这个图定义了一个有状态、可循环、支持中断和人工干预（Human-in-the-Loop）的复杂工作流。我们的目标不再是“一次性”生成报告，而是通过一个可被观察和干预的流程，与用户共同“探索”并“构建”一份报告。

**我们将采用 `LangGraph` 或 `CrewAI` 这样的框架来实现这个图。**

**核心工作流图 (High-Level Graph Flow):**
```
[用户初始请求]
      |
      V
[OrchestratorAgent: 启动]
      |
      V
[DataCollectorAgent: 收集数据]
      |
      V
[HITL 节点 1: 歧义消除 (等待用户确认)]
      |
      V
[并行执行] -> [AnalysisAgent: 核心分析]
      |------> [CaseStudyAgent: 案例研究]
      |
      V
[RiskAgent: 风险评估]
      |
      V
[HITL 节点 2: 合理追问 (等待用户反馈)]
      |
      V
[InvestmentAgent: (可选) 综合评估]
      |
      V
[ScribeAgent: 撰写与排版]
      |
      V
[最终报告呈现]
```

---

## 2. 专家Agent团队与微服务工具的映射

我们的微服务将不再被直接调用，而是作为“工具 (Tools)”被各个“专家Agent”使用。

### a. OrchestratorAgent (总控Agent)
*   **职责:** 整个图的管理者。负责调用其他Agent，管理整个工作流的状态，并在定义的节点暂停以等待人工输入。
*   **实现:** 它将是后端一个新的、核心的Python应用，使用 `LangGraph` 库来定义和执行状态图。

### b. DataCollectorAgent (数据收集Agent)
*   **职责:** 收集所有原始数据。
*   **映射的微服务工具:**
    *   `public_data_service`: 用于获取公开市场数据。
    *   `file_service`, `pdf_parser`, `excel_parser`, `word_parser`: 用于处理用户上传的文档。
    *   (新增) `web_search_service`: 用于抓取行业新闻、政策风险等非结构化网络信息。

### c. AnalysisAgent (核心分析Agent)
*   **职责:** 将原始数据转化为初步的分析洞察。
*   **映射的微服务工具:**
    *   `llm_gateway`: 用于核心的语言模型推理。
    *   `visualization_service`: 用于根据数据生成图表。
    *   (新增) `code_interpreter_service`: 一个安全的沙箱环境，用于执行Python代码，进行复杂的数据处理和财务指标计算。

### d. CaseStudyAgent (案例研究Agent)
*   **职责:** 寻找可对标的成功与失败案例。
*   **映射的微服务工具:**
    *   `llm_gateway`: 用于初步的案例搜索。
    *   (新增) `vector_db_service`: 用于在内部知识库或预置的全球案例库中进行语义搜索。

### e. RiskAgent (风险评估Agent)
*   **职责:** 专职进行“偏保守”的风险评估。
*   **实现:** 此Agent的System Prompt将被特殊设计，以引导其进行批判性、保守性的思考。
*   **映射的微服务工具:** `llm_gateway`。

### f. InvestmentAgent (投资建议Agent)
*   **职责:** 在接收到用户的“合理追问”反馈后，进行综合评估，并结合用户画像给出个性化建议。
*   **映射的微服务工具:** `llm_gateway`, `user_service`。

### g. ScribeAgent (报告撰写Agent)
*   **职责:** 最终的“呈现者”。负责将所有专家Agent生成的结构化信息，按照模板进行专业、精美的排版。
*   **映射的微服务工具:** `llm_gateway` (用于润色和格式化)。

---

## 3. Human-in-the-Loop (HITL) 关键节点设计

HITL 是 V2 架构的核心功能，是产品“缜密感”和“互动性”的体现。

### 节点 1: 歧义消除 (Ambiguity Resolution)
*   **触发:** `DataCollectorAgent` 完成初步信息收集后。
*   **后端逻辑:** `OrchestratorAgent` 检查收集结果。如果发现多个可能的实体（如“苹果公司” vs “苹果唱片”），则将工作流状态置为 `PAUSED`，并通过WebSocket向前端推送一个包含选项的 `HITL_REQUIRED` 事件。
*   **前端交互:** UI收到事件后，从“生成中...”变为一个选择框，等待用户确认。
*   **流程恢复:** 用户确认后，前端将选择结果发送回后端。`OrchestratorAgent` 更新状态，并继续执行图的下一个节点。

### 节点 2: “合理追问”互动 (Follow-up Question Interaction)
*   **触发:** `RiskAgent` 完成初步风险评估后。
*   **后端逻辑:** `OrchestratorAgent` 调用 `llm_gateway` 生成“合理追问”问题列表。然后，将工作流状态置为 `PAUSED`，并将已有的分析摘要和追问问题列表，通过WebSocket推送给前端。
*   **前端交互:** UI在一个专门的模块中展示初步结论和追问列表，并提供一个输入框让用户填写“对方的回答”。
*   **流程恢复:**
    *   **用户跳过:** 前端发送“跳过”指令，`OrchestratorAgent` 直接调用 `ScribeAgent` 生成最终报告。
    *   **用户输入回答:** 前端将回答内容发送给后端。`OrchestratorAgent` 将此回答作为新信息，重新调用 `InvestmentAgent` 进行一轮“综合评估”，然后再调用 `ScribeAgent`。

---

## 4. 前端设计：从“对话框”到“智能分析工作站”

产品的核心竞争力不在于AI本身，而在于**“体验”**——即“秩序感、完整感、逻辑缜密”。一个简单的对话框传递的是“即时、随意、聊天”的感觉，而我们的产品需要传递的是“专业、严谨、协同”的调性。用户不是在“聊天”，而是在“监督一个专家团队完成一项严谨的工作”。

因此，界面设计的核心将从“对话框”转向“工作台 (Workbench)”或“控制室 (Control Room)”。

*   **技术栈:** `Vue 3 (Vite + TypeScript)`
*   **核心调性:**
    *   **专业 (Professional):** 界面简洁、干净，使用清晰的排版和中性色调（如深蓝、灰色、白色）。
    *   **透明 (Transparent):** 用户必须能清晰地看到AI的工作流程与状态。
    *   **可控 (Controllable):** 用户在关键节点必须能进行干预。
    *   **数据驱动 (Data-Dense):** 界面需要承载丰富的图表和表格，而不只有文字。

---

### **界面一：首次登录的 "Persona (用户画像)" 设定**

*   **目的:** 实现“符合自己的阅读习惯”和“投资人风格匹配”。
*   **形态:** 一个优雅的、3-5步的引导式问卷 (Onboarding Wizard)。
*   **设计:**
    1.  **欢迎页:** “欢迎使用AI投资分析助手。为了给您提供最缜密的报告，请花1分钟告诉我们您的偏好。”
    2.  **投资风格:** “您的投资风格更偏向？” (选项：价值型、成长型、趋势型、保守型等)。
    3.  **信息偏好:** “您在阅读报告时，最先关注的是？” (选项：最终结论、财务数据、风险评估、市场分析等)。
    4.  **报告模板:** “您偏好的报告样式？” (选项：高管摘要 (简要)、深度分析 (长篇)、数据优先 (表格和图表在前))。
*   **价值:** 从一开始就向用户传递了“个性化”和“严谨”的信号。

---

### **界面二：核心交互 "The Foundry" (工作台)**

*   **目的:** 完美体现“秩序感”和“逻辑缜密”，将Agent的工作流实时可视化，取代简单的“生成中…”加载条。
*   **形态:** 一个“流程状态监视器”，类似CI/CD流水线（如GitHub Actions）。
*   **设计:** 当用户提交分析任务后，主界面将实时、动态地展示多智能体协作图的每一个执行节点和子任务：
    ```
    [启动] 任务已创建：分析“XX公司”

    [运行中] DataCollectorAgent:
        [✓] 已解析用户上传的3个文件。
        [运行中] 正在抓取公开财务数据...
        [✓] 已获取最新行业新闻。

    [已暂停 - 需您介入] Human-in-the-Loop:
        => 弹窗：“我们找到了2家公司，请确认您指的是：[XX科技有限公司 (A股)] / [XX国际集团 (港股)]”

    [运行中] AnalysisAgent:
        [运行中] 正在生成公司简介...
        [✓] 行业分析(饼图)已生成。
        [✓] 财务分析(表格)已生成。

    [运行中] CaseStudyAgent:
        [✓] 已找到2个成功案例，1个失败案例。

    [已暂停 - 需您介入] Human-in-the-Loop (核心功能):
        => 提示：“初步分析已完成。我们已生成‘关键追问问题’。您可以：
            A. [立即查看报告]
            B. (推荐) [输入您已知的答案，进行更深入的综合评估]”

    [运行中] ScribeAgent:
        [运行中] 正在按您的“深度分析”模板排版...

    [已完成] 报告已生成。
    ```
*   **价值:**
    *   完美地展示了AI的“推理逻辑合理缜密程度”。
    *   将“等待”变成了“监督”，解决了用户对生成速度的焦虑。
    *   将HITL（人工干预）无缝地融入了产品核心功能，使其成为一个亮点而非中断。

---

### **界面三：最终交付 "The Report" (交互式报告)**

*   **目的:** 交付“完整感”，并提供强大的交互和辅助决策工具。
*   **形态:** 一个专业的三栏式仪表板 (Dashboard)，而非静态PDF。

#### **1. 左栏 (报告大纲 - 导航栏)**
*   **功能:** 提供可点击的报告章节导航（公司简介、行业分析、财务分析、案例分析、风险评估、投资建议等），方便用户快速跳转。

#### **2. 中栏 (报告主体 - 内容区)**
*   **交互式内容:**
    *   **图表:** 可交互的图表，鼠标悬停时显示详细数据。
    *   **表格:** 可排序、可筛选的嵌入式数据表格。
*   **合规与溯源:**
    *   每一份数据和结论旁都有一个小的 `(i)` 图标，点击可显示“数据来源：用户上传的 a.xlsx”或“来源：yfinance API”，确保透明度和可信度。

#### **3. 右栏 (Agent助手 - 工具栏)**
*   **“关键追问”模块 (会议助手):**
    *   以卡片形式，清晰列出为用户准备的、应在会议中向目标公司提出的关键市场和财务问题。
    *   例如：“贵司提到...，但这如何应对...的政策风险？”
*   **即时反馈:**
    *   提供一个输入框，让用户可以随时输入“对方的回答”。
    *   Agent将基于新信息给出即时反馈或动态更新报告的相关章节。
*   **投资建议:**
    *   **风格匹配:** 明确提示“基于您的‘保守型’Persona...”。
    *   **打分卡:** 以结构化方式呈现关键指标的评分（如：市场潜力：8/10，财务健康：6/10）。
    *   **最终结论:** 明确给出 PASS / BUY / WATCH 的结论和核心理由。

*   **价值:**
    *   “三栏式”布局是专业工具（如VS Code）的标准，本身就极具“秩序感”。
    *   将报告从“只读”的静态文档，变成了“可用”的动态工作台。
    *   将核心的“合理追问”功能，从报告的一个小章节，提升为了一个常驻的、可交互的助手工具，极大地放大了其价值。

---
## 5. V2 系统架构图 (Google Cloud 原生版)

```
[ 前端 (Vue 3) ] <---- (WebSocket / REST) ----> [ API 网关 (Cloud Gateway) ]
                                                               |
                                                               | (HTTP Trigger)
                                                               V
+-----------------------------------------------------------------------------------------+
|                      核心业务逻辑 (运行在 Cloud Run / Cloud Functions)                      |
|                                                                                         |
|  +-----------------------------------------------------------------------------------+  |
|  |             Orchestrator (业务逻辑层，调用 Vertex AI Agent Builder)             |  |
|  +-----------------------------------------------------------------------------------+  |
|                                        |                                                |
|                                 (API 调用)                                                |
|                                        V                                                |
+-----------------------------------------------------------------------------------------+
|                            Google AI Studio (Vertex AI) 平台                            |
|                                                                                         |
|   +--------------------------+     +-----------------------+     +------------------+   |
|   |   Vertex AI Agent Builder  | --> |  Vertex AI Gemini API | --> | Vertex AI Search |   |
|   | (多智能体图、状态机、HITL) |     | (LLM 推理)            |     | (向量数据库/RAG) |   |
|   +--------------------------+     +-----------------------+     +------------------+   |
|                                                                                         |
+-----------------------------------------------------------------------------------------+
```
