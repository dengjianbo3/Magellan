# Magellan ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
3. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
4. [åç«¯æ¶æ„](#åç«¯æ¶æ„)
5. [å‰ç«¯æ¶æ„](#å‰ç«¯æ¶æ„)
6. [äº§å“åŠŸèƒ½](#äº§å“åŠŸèƒ½)
7. [å‰åç«¯å¯¹æ¥](#å‰åç«¯å¯¹æ¥)
8. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
9. [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)
10. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®åç§°
**Magellan AI Investment Analysis Platform**ï¼ˆéº¦å“²ä¼¦AIæŠ•èµ„åˆ†æå¹³å°ï¼‰

### é¡¹ç›®å®šä½
é¢å‘æŠ•èµ„æœºæ„çš„AIé©±åŠ¨å°½è°ƒåˆ†æå¹³å°ï¼Œæ”¯æŒ5ç§æŠ•èµ„åœºæ™¯çš„æ™ºèƒ½åˆ†æå’ŒæŠ¥å‘Šç”Ÿæˆã€‚

### æ ¸å¿ƒä»·å€¼
- **æ™ºèƒ½åŒ–**ï¼šå¤šAgentååŒå·¥ä½œï¼Œè‡ªåŠ¨åŒ–å®Œæˆå¤æ‚çš„æŠ•èµ„åˆ†æ
- **åœºæ™¯åŒ–**ï¼šé’ˆå¯¹ä¸åŒæŠ•èµ„é˜¶æ®µå®šåˆ¶åˆ†ææµç¨‹
- **å®æ—¶æ€§**ï¼šWebSocketå®æ—¶åé¦ˆåˆ†æè¿›åº¦
- **ä¸“ä¸šæ€§**ï¼šåŸºäºè¡Œä¸šæœ€ä½³å®è·µçš„åˆ†ææ¡†æ¶

### æ”¯æŒçš„æŠ•èµ„åœºæ™¯
1. **Early Stage Investment** (æ—©æœŸæŠ•èµ„å°½è°ƒ)
2. **Growth Investment** (æˆé•¿æœŸæŠ•èµ„å°½è°ƒ)
3. **Public Market Investment** (äºŒçº§å¸‚åœºæŠ•èµ„åˆ†æ)
4. **Alternative Investment** (å¦ç±»æŠ•èµ„å°½è°ƒ)
5. **Industry Research** (è¡Œä¸šç ”ç©¶)

---

## æŠ€æœ¯æ ˆ

### å‰ç«¯æŠ€æœ¯æ ˆ
```
æ ¸å¿ƒæ¡†æ¶ï¼š
- Vue 3 (Composition API)
- Vue Router 4
- Vite 4

UIæ¡†æ¶ï¼š
- TailwindCSS 3
- Material Symbols Icons

çŠ¶æ€ç®¡ç†ï¼š
- Composables (useLanguage, useToast)
- SessionManager (localStorage)

é€šä¿¡ï¼š
- WebSocket (åŸç”Ÿ)
- Fetch API
```

### åç«¯æŠ€æœ¯æ ˆ
```
æ ¸å¿ƒæ¡†æ¶ï¼š
- FastAPI (Python 3.11+)
- Uvicorn (ASGIæœåŠ¡å™¨)

Agentæ¡†æ¶ï¼š
- ReWOO Architecture
- Custom Agent Registry

å¤–éƒ¨æœåŠ¡ï¼š
- LLM Gateway (LLMè°ƒç”¨ç»Ÿä¸€ç½‘å…³)
- SEC Edgar API (ä¸Šå¸‚å…¬å¸æ•°æ®)
- Perplexity API (å®æ—¶æœç´¢)

æ•°æ®åº“ï¼š
- PostgreSQL (æŒä¹…åŒ–å­˜å‚¨)
- Redis (ç¼“å­˜å’Œä¼šè¯)

æ¶ˆæ¯é˜Ÿåˆ—ï¼š
- Kafka (æœåŠ¡é—´é€šä¿¡ã€æ¶ˆæ¯æŒä¹…åŒ–)
- Zookeeper (Kafka åè°ƒ)
- Kafka UI (æ¶ˆæ¯ç›‘æ§) - http://localhost:8080
```

### åŸºç¡€è®¾æ–½
```
å®¹å™¨åŒ–ï¼š
- Docker
- Docker Compose

åå‘ä»£ç†ï¼š
- Nginx

ç›‘æ§ï¼š
- Prometheus
- Grafana
```

---

## ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·æµè§ˆå™¨                            â”‚
â”‚                     (Vue 3 + TailwindCSS)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†• HTTP/WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Nginx (8080)                         â”‚
â”‚                    (åå‘ä»£ç† + é™æ€èµ„æº)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                      â”‚
        â†“                                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend Dev   â”‚                  â”‚  Backend API    â”‚
â”‚  Vite Server    â”‚                  â”‚  FastAPI:8000   â”‚
â”‚  (å¼€å‘æ¨¡å¼)      â”‚                  â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â†•
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                                          â”‚
                  â†“                                          â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  LLM Gateway    â”‚                      â”‚  External APIs  â”‚
        â”‚  (OpenAI/Claude)â”‚                      â”‚  - SEC Edgar    â”‚
        â”‚                 â”‚                      â”‚  - Perplexity   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†•                                          â†•
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   PostgreSQL    â”‚                      â”‚      Redis      â”‚
        â”‚   (æ•°æ®æŒä¹…åŒ–)   â”‚                      â”‚    (ä¼šè¯ç¼“å­˜)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæµç¨‹

```
ç”¨æˆ·æ“ä½œ â†’ åœºæ™¯é€‰æ‹© â†’ é…ç½®åˆ†æ â†’ å¯åŠ¨åˆ†æ
                                    â†“
                            åˆ›å»ºSession & WebSocketè¿æ¥
                                    â†“
                            Orchestratoråè°ƒAgents
                                    â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â†“                             â†“
            Agentså¹¶è¡Œ/ä¸²è¡Œæ‰§è¡Œ              å®æ—¶æ¨é€è¿›åº¦
                    â†“                             â†“
            è°ƒç”¨LLM & External APIs          å‰ç«¯æ›´æ–°UI
                    â†“                             â†“
                ç”Ÿæˆåˆ†æç»“æœ                   æ˜¾ç¤ºAgentçŠ¶æ€
                    â†“                             â†“
                æ±‡æ€»æœ€ç»ˆæŠ¥å‘Š   â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   å®Œæˆé€šçŸ¥
                    â†“
                ä¿å­˜ & è¿”å›
```

---

## åç«¯æ¶æ„

### ç›®å½•ç»“æ„

```
backend/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ report_orchestrator/
â”‚       â””â”€â”€ app/
â”‚           â”œâ”€â”€ main.py                      # FastAPIåº”ç”¨å…¥å£
â”‚           â”œâ”€â”€ api/
â”‚           â”‚   â”œâ”€â”€ v1/                      # API V1 (å·²åºŸå¼ƒ)
â”‚           â”‚   â””â”€â”€ v2/                      # API V2 (å½“å‰ç‰ˆæœ¬)
â”‚           â”‚       â”œâ”€â”€ analysis.py          # åˆ†ææ¥å£
â”‚           â”‚       â””â”€â”€ websocket.py         # WebSocketæ¥å£
â”‚           â”œâ”€â”€ core/
â”‚           â”‚   â”œâ”€â”€ agent_registry.py        # Agentæ³¨å†Œä¸­å¿ƒ â­
â”‚           â”‚   â”œâ”€â”€ agent_event_bus.py       # Agentäº‹ä»¶æ€»çº¿
â”‚           â”‚   â”œâ”€â”€ intent_recognizer.py     # æ„å›¾è¯†åˆ«
â”‚           â”‚   â”œâ”€â”€ dd_state_machine.py      # çŠ¶æ€æœº
â”‚           â”‚   â”œâ”€â”€ orchestrators/           # åœºæ™¯ç¼–æ’å™¨
â”‚           â”‚   â”‚   â”œâ”€â”€ base_orchestrator.py
â”‚           â”‚   â”‚   â”œâ”€â”€ early_stage_orchestrator.py
â”‚           â”‚   â”‚   â”œâ”€â”€ growth_investment_orchestrator.py
â”‚           â”‚   â”‚   â”œâ”€â”€ public_market_orchestrator.py
â”‚           â”‚   â”‚   â”œâ”€â”€ alternative_investment_orchestrator.py
â”‚           â”‚   â”‚   â””â”€â”€ industry_research_orchestrator.py
â”‚           â”‚   â””â”€â”€ roundtable/              # Agentå®ç°
â”‚           â”‚       â”œâ”€â”€ agent.py             # åŸºç¡€Agentç±» â­
â”‚           â”‚       â”œâ”€â”€ market_analysis_agent.py
â”‚           â”‚       â”œâ”€â”€ team_analysis_agent.py
â”‚           â”‚       â””â”€â”€ ...
â”‚           â”œâ”€â”€ agents/                      # æ—§ç‰ˆAgent (é€æ­¥åºŸå¼ƒ)
â”‚           â”œâ”€â”€ models/
â”‚           â”‚   â”œâ”€â”€ analysis_models.py       # æ•°æ®æ¨¡å‹
â”‚           â”‚   â””â”€â”€ report_models.py
â”‚           â””â”€â”€ utils/
â”‚               â”œâ”€â”€ llm_client.py
â”‚               â””â”€â”€ data_fetcher.py
â””â”€â”€ test_*.py                                # æµ‹è¯•è„šæœ¬
```

### æ ¸å¿ƒæ¨¡å—è¯¦è§£

#### 1. Agent Registryï¼ˆAgentæ³¨å†Œä¸­å¿ƒï¼‰â­

**æ–‡ä»¶**ï¼š`app/core/agent_registry.py`

**èŒè´£**ï¼š
- ç»Ÿä¸€ç®¡ç†æ‰€æœ‰Agentçš„åˆ›å»ºå’Œé…ç½®
- æä¾›AgentæŸ¥è¯¢å’Œå®ä¾‹åŒ–æ¥å£
- æ”¯æŒåŠ¨æ€Agentæ³¨å†Œ

**æ ¸å¿ƒæ¥å£**ï¼š
```python
class AgentRegistry:
    @classmethod
    def register_agent(cls, agent_id: str, agent_class, config: dict)

    @classmethod
    def get_agent(cls, agent_id: str, session_id: str, **kwargs) -> Agent

    @classmethod
    def list_agents(cls) -> List[str]
```

**å·²æ³¨å†Œçš„Agents**ï¼š
```python
AGENTS = {
    "market_analyst": MarketAnalysisAgent,
    "team_analyst": TeamAnalysisAgent,
    "financial_expert": FinancialAnalysisAgent,
    "risk_analyst": RiskAnalysisAgent,
    "tech_specialist": TechAnalysisAgent,
    "industry_researcher": IndustryResearchAgent,
    # ... æ›´å¤š
}
```

#### 2. AgentåŸºç±»ï¼ˆReWOOæ¶æ„ï¼‰â­

**æ–‡ä»¶**ï¼š`app/core/roundtable/agent.py`

**æ¶æ„**ï¼šåŸºäºReWOO (Reasoning WithOut Observation) æ¨¡å¼

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```python
class Agent:
    async def analyze(self, context: Dict[str, Any]) -> Dict[str, Any]:
        """æ‰§è¡Œåˆ†æçš„ä¸»æ–¹æ³•"""
        # 1. æ„å»ºæç¤ºè¯
        # 2. è°ƒç”¨LLM
        # 3. è§£æå·¥å…·è°ƒç”¨
        # 4. æ‰§è¡Œå·¥å…·
        # 5. è¿”å›ç»“æœ

    async def _call_llm(self, messages: List[Dict]) -> Dict:
        """è°ƒç”¨LLM Gateway"""

    def _execute_tool(self, tool_name: str, params: str) -> str:
        """æ‰§è¡Œå·¥å…·è°ƒç”¨"""
```

**å·¥å…·ç³»ç»Ÿ**ï¼š
```python
tools = {
    "search_company_info": "æœç´¢å…¬å¸ä¿¡æ¯",
    "get_financial_data": "è·å–è´¢åŠ¡æ•°æ®",
    "analyze_market_trend": "åˆ†æå¸‚åœºè¶‹åŠ¿",
    # ...
}
```

**LLMè°ƒç”¨æ ¼å¼**ï¼š
```python
# è¯·æ±‚æ ¼å¼
{
    "messages": [
        {"role": "system", "content": "..."},
        {"role": "user", "content": "..."}
    ],
    "model": "gpt-4",
    "temperature": 0.7
}

# å“åº”æ ¼å¼ï¼ˆæ”¯æŒä¸¤ç§ï¼‰
# æ ¼å¼1: Dict
{
    "choices": [
        {
            "message": {
                "role": "assistant",
                "content": "åˆ†æç»“æœ..."
            }
        }
    ]
}

# æ ¼å¼2: String
"åˆ†æç»“æœ..."
```

#### 3. Orchestratorï¼ˆåœºæ™¯ç¼–æ’å™¨ï¼‰

**æ–‡ä»¶**ï¼š`app/core/orchestrators/base_orchestrator.py`

**èŒè´£**ï¼š
- å®šä¹‰åˆ†æåœºæ™¯çš„workflow
- åè°ƒå¤šä¸ªAgentçš„æ‰§è¡Œé¡ºåº
- ç®¡ç†åˆ†æçŠ¶æ€å’Œè¿›åº¦
- å‘é€WebSocketæ¶ˆæ¯

**åŸºç±»æ–¹æ³•**ï¼š
```python
class BaseOrchestrator:
    async def execute(self) -> Dict[str, Any]:
        """æ‰§è¡Œåˆ†æä¸»æµç¨‹"""
        # 1. éªŒè¯ç›®æ ‡
        await self._validate_target()

        # 2. è·å–workflow
        workflow = self._get_workflow()

        # 3. æ‰§è¡Œæ­¥éª¤
        for step in workflow:
            await self._execute_step(step)
            await self._send_progress()

        # 4. ç”ŸæˆæŠ¥å‘Š
        report = await self._synthesize_report()
        return report
```

**Workflowå®šä¹‰**ï¼š
```python
def _get_workflow(self) -> List[Dict]:
    if self.depth == AnalysisDepth.QUICK:
        return [
            {
                "id": "market_check",
                "name": "å¸‚åœºè§„æ¨¡æ£€æŸ¥",
                "agent": "market_analyst",
                "estimated_duration": 60
            },
            # ...
        ]
```

**å…·ä½“Orchestratorç¤ºä¾‹**ï¼š

1. **EarlyStageOrchestrator** - æ—©æœŸæŠ•èµ„
   - é‡ç‚¹ï¼šå›¢é˜Ÿè¯„ä¼°ã€äº§å“éªŒè¯ã€å¸‚åœºæœºä¼š
   - Agents: team_analyst, product_analyst, market_analyst

2. **IndustryResearchOrchestrator** - è¡Œä¸šç ”ç©¶
   - é‡ç‚¹ï¼šå¸‚åœºè§„æ¨¡ã€ç«äº‰æ ¼å±€ã€è¶‹åŠ¿åˆ†æ
   - Agents: market_analyst, industry_researcher, tech_specialist

#### 4. WebSocketé€šä¿¡

**æ–‡ä»¶**ï¼š`app/api/v2/websocket.py`

**è¿æ¥æµç¨‹**ï¼š
```python
@router.websocket("/ws/v2/analysis/{session_id}")
async def analysis_websocket(websocket: WebSocket, session_id: str):
    await websocket.accept()

    # æ³¨å†Œè¿æ¥
    connection_manager.register(session_id, websocket)

    try:
        # æ¥æ”¶åˆå§‹è¯·æ±‚
        request_data = await websocket.receive_json()

        # åˆ›å»ºå¹¶æ‰§è¡ŒOrchestrator
        orchestrator = create_orchestrator(request_data, websocket)
        result = await orchestrator.execute()

        # å‘é€å®Œæˆæ¶ˆæ¯
        await websocket.send_json({
            "type": "complete",
            "data": result
        })
    except Exception as e:
        await websocket.send_json({
            "type": "error",
            "message": str(e)
        })
    finally:
        connection_manager.disconnect(session_id)
```

**æ¶ˆæ¯ç±»å‹**ï¼š
```python
MESSAGE_TYPES = {
    "workflow_start": "å·¥ä½œæµå¼€å§‹",
    "step_start": "æ­¥éª¤å¼€å§‹",
    "step_progress": "æ­¥éª¤è¿›åº¦",
    "step_complete": "æ­¥éª¤å®Œæˆ",
    "agent_event": "Agentäº‹ä»¶",
    "status_update": "çŠ¶æ€æ›´æ–°",
    "error": "é”™è¯¯",
    "complete": "åˆ†æå®Œæˆ",
    "ping": "å¿ƒè·³è¯·æ±‚",
    "pong": "å¿ƒè·³å“åº”"
}
```

---

## å‰ç«¯æ¶æ„

### ç›®å½•ç»“æ„

```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ App.vue                          # æ ¹ç»„ä»¶
â”‚   â”œâ”€â”€ main.js                          # åº”ç”¨å…¥å£
â”‚   â”œâ”€â”€ router/
â”‚   â”‚   â””â”€â”€ index.js                     # è·¯ç”±é…ç½®
â”‚   â”œâ”€â”€ views/                           # é¡µé¢çº§ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ DashboardView.vue            # ä»ªè¡¨æ¿
â”‚   â”‚   â”œâ”€â”€ AnalysisWizardView.vue       # åˆ†æå‘å¯¼ â­
â”‚   â”‚   â”œâ”€â”€ AgentsView.vue               # Agentç®¡ç†
â”‚   â”‚   â”œâ”€â”€ ReportsView.vue              # æŠ¥å‘Šåˆ—è¡¨
â”‚   â”‚   â””â”€â”€ SettingsView.vue             # è®¾ç½®
â”‚   â”œâ”€â”€ components/                      # ç»„ä»¶åº“
â”‚   â”‚   â”œâ”€â”€ layout/                      # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ MainLayout.vue
â”‚   â”‚   â”‚   â”œâ”€â”€ Sidebar.vue
â”‚   â”‚   â”‚   â””â”€â”€ Navbar.vue
â”‚   â”‚   â”œâ”€â”€ dashboard/                   # ä»ªè¡¨æ¿ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ StatCard.vue
â”‚   â”‚   â”‚   â””â”€â”€ RecentSessions.vue
â”‚   â”‚   â””â”€â”€ analysis/                    # åˆ†æç›¸å…³ç»„ä»¶ â­
â”‚   â”‚       â”œâ”€â”€ ScenarioSelection.vue    # åœºæ™¯é€‰æ‹©
â”‚   â”‚       â”œâ”€â”€ UnifiedAnalysisForm.vue  # ç»Ÿä¸€åˆ†æè¡¨å•
â”‚   â”‚       â”œâ”€â”€ AnalysisProgress.vue     # åˆ†æè¿›åº¦ â­
â”‚   â”‚       â””â”€â”€ StepResultCard.vue       # æ­¥éª¤ç»“æœå¡ç‰‡
â”‚   â”œâ”€â”€ composables/                     # ç»„åˆå¼å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ useLanguage.js               # å›½é™…åŒ–
â”‚   â”‚   â””â”€â”€ useToast.js                  # æç¤ºæ¶ˆæ¯
â”‚   â”œâ”€â”€ services/                        # æœåŠ¡å±‚ â­
â”‚   â”‚   â”œâ”€â”€ analysisServiceV2.js         # åˆ†ææœåŠ¡V2 â­
â”‚   â”‚   â””â”€â”€ sessionManager.js            # ä¼šè¯ç®¡ç†
â”‚   â””â”€â”€ i18n/                            # å›½é™…åŒ–èµ„æº
â”‚       â”œâ”€â”€ zh.js
â”‚       â””â”€â”€ en.js
â”œâ”€â”€ public/
â”œâ”€â”€ index.html
â”œâ”€â”€ vite.config.js
â”œâ”€â”€ tailwind.config.js
â””â”€â”€ package.json
```

### æ ¸å¿ƒæ¨¡å—è¯¦è§£

#### 1. åˆ†æå‘å¯¼æµç¨‹ â­

**æ–‡ä»¶**ï¼š`src/views/AnalysisWizardView.vue`

**ä¸‰æ­¥æµç¨‹**ï¼š
```
Step 0: åœºæ™¯é€‰æ‹© (ScenarioSelection)
   â†“
Step 1: é…ç½®åˆ†æ (UnifiedAnalysisForm)
   â†“
Step 2: åˆ†æè¿›åº¦ (AnalysisProgress)
```

**çŠ¶æ€ç®¡ç†**ï¼š
```javascript
const currentStep = ref(0)           // å½“å‰æ­¥éª¤
const selectedScenario = ref(null)   // é€‰ä¸­çš„åœºæ™¯
const targetConfig = ref({})         // ç›®æ ‡é…ç½®
const analysisConfig = ref({         // åˆ†æé…ç½®
  depth: 'quick',
  timeframe: '1Y',
  focus_areas: [],
  language: 'zh'
})
const sessionId = ref(null)          // ä¼šè¯ID
```

**å…³é”®é€»è¾‘**ï¼š
```javascript
async function handleAnalysisStart(data) {
  // 1. å…ˆç§»åˆ°è¿›åº¦é¡µï¼ˆé‡è¦ï¼ï¼‰
  currentStep.value = 2

  // 2. ç­‰å¾…ç»„ä»¶mount
  await new Promise(resolve => setTimeout(resolve, 100))

  // 3. è°ƒç”¨APIå¯åŠ¨åˆ†æ
  const result = await analysisServiceV2.startAnalysis(request)
  sessionId.value = result.sessionId

  // 4. ä¿å­˜ä¼šè¯
  sessionManager.saveSession({...})
}
```

**ä¸ºä»€ä¹ˆè¦å…ˆç§»åˆ°è¿›åº¦é¡µï¼Ÿ**
- AnalysisProgressç»„ä»¶éœ€è¦å…ˆmount
- mountæ—¶ä¼šæ³¨å†ŒWebSocketæ¶ˆæ¯ç›‘å¬å™¨
- é¿å…é”™è¿‡æ—©æœŸçš„workflow_startæ¶ˆæ¯

#### 2. åˆ†æè¿›åº¦ç»„ä»¶ â­

**æ–‡ä»¶**ï¼š`src/components/analysis/AnalysisProgress.vue`

**å¸ƒå±€ç»“æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Header (é¡¹ç›®å + å–æ¶ˆ)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        Overall Progress Bar (æ€»è¿›åº¦)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Stats (å‰©ä½™æ—¶é—´ | æ´»è·ƒAgents | å¼€å§‹æ—¶é—´) â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AI Agent Status â”‚  Analysis Results    â”‚
â”‚  (å·¦ä¾§é¢æ¿)       â”‚  (å³ä¾§é¢æ¿)           â”‚
â”‚                  â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Agent 1 â”‚    â”‚  â”‚ Step 1      â”‚    â”‚
â”‚  â”‚ Agent 2 â”‚    â”‚  â”‚  - Result   â”‚    â”‚
â”‚  â”‚ Agent 3 â”‚    â”‚  â”‚ Step 2      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  - Running  â”‚    â”‚
â”‚                  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒçŠ¶æ€**ï¼š
```javascript
const workflow = ref([])              // å·¥ä½œæµæ­¥éª¤
const agents = computed(() => {...})  // AgentçŠ¶æ€ï¼ˆä»workflowè®¡ç®—ï¼‰
const overallProgress = ref(0)        // æ€»è¿›åº¦
const analysisStatus = ref('running') // åˆ†æçŠ¶æ€
```

**WebSocketæ¶ˆæ¯å¤„ç†**ï¼š
```javascript
onMounted(() => {
  // 1. åˆ·æ–°æ¶ˆæ¯ç¼“å†²åŒºï¼ˆé‡è¦ï¼ï¼‰
  analysisServiceV2.flushMessageBuffer()

  // 2. æ³¨å†Œæ¶ˆæ¯ç›‘å¬
  analysisServiceV2.on('workflow_start', handleWorkflowStart)
  analysisServiceV2.on('step_start', handleStepStart)
  analysisServiceV2.on('step_complete', handleStepComplete)
  analysisServiceV2.on('agent_event', handleAgentEvent)
  analysisServiceV2.on('complete', handleComplete)
  analysisServiceV2.on('error', handleError)
})

onUnmounted(() => {
  // æ¸…ç†ç›‘å¬å™¨
  analysisServiceV2.off('workflow_start', handleWorkflowStart)
  // ...
})
```

**æ¶ˆæ¯å¤„ç†å‡½æ•°**ï¼š
```javascript
function handleWorkflowStart(message) {
  // åˆå§‹åŒ–workflow
  workflow.value = message.data.steps.map((s, index) => {
    // æ£€æµ‹å¹¶ç¿»è¯‘i18n key
    let displayName = s.name
    if (displayName && displayName.includes('.')) {
      displayName = t(displayName)
    }

    return {
      id: s.id,
      name: displayName,
      agent: s.agent,
      status: 'pending',
      progress: 0
    }
  })
}

function handleStepComplete(message) {
  // æ›´æ–°æ­¥éª¤çŠ¶æ€
  const step = workflow.value.find(s => s.id === message.data.step_id)
  if (step) {
    step.status = 'success'
    step.result = message.data.result
  }

  // æ›´æ–°æ€»è¿›åº¦
  const completed = workflow.value.filter(s => s.status === 'success').length
  overallProgress.value = Math.round((completed / workflow.value.length) * 100)
}
```

#### 3. åˆ†ææœåŠ¡V2 â­

**æ–‡ä»¶**ï¼š`src/services/analysisServiceV2.js`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. å¯åŠ¨åˆ†æï¼ˆREST APIï¼‰
2. WebSocketè¿æ¥ç®¡ç†
3. æ¶ˆæ¯ç¼“å†²å’Œé‡æ”¾
4. å¿ƒè·³æœºåˆ¶
5. è‡ªåŠ¨é‡è¿

**å…³é”®å®ç°**ï¼š

```javascript
class AnalysisServiceV2 {
  constructor() {
    this.ws = null
    this.sessionId = null
    this.messageHandlers = new Map()
    this.messageBuffer = []           // æ¶ˆæ¯ç¼“å†²åŒº â­
    this.isBuffering = true           // ç¼“å†²å¼€å…³
    this.reconnectAttempts = 0
    this.maxReconnectAttempts = 10
    this.connectionState = 'disconnected'
  }

  // å¯åŠ¨åˆ†æ
  async startAnalysis(request) {
    // 1. è°ƒç”¨REST API
    const response = await fetch(`${API_BASE}/api/v2/analysis/start`, {
      method: 'POST',
      body: JSON.stringify(request)
    })
    const data = await response.json()
    this.sessionId = data.session_id

    // 2. è¿æ¥WebSocket
    await this._connectWebSocket(request)

    return {
      sessionId: data.session_id,
      estimatedDuration: data.estimated_duration
    }
  }

  // WebSocketè¿æ¥
  async _connectWebSocket(request) {
    const wsUrl = `ws://localhost:8000/ws/v2/analysis/${this.sessionId}`
    this.ws = new WebSocket(wsUrl)

    this.ws.onopen = () => {
      this._setConnectionState('connected')
      this._startHeartbeat()
      this.ws.send(JSON.stringify(request))
    }

    this.ws.onmessage = (event) => {
      const message = JSON.parse(event.data)
      this._handleMessage(message)
    }

    this.ws.onclose = (event) => {
      this._stopHeartbeat()
      if (event.code !== 1000 && this.reconnectAttempts < this.maxReconnectAttempts) {
        // æŒ‡æ•°é€€é¿é‡è¿
        const backoffDelay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 16000)
        setTimeout(() => this._connectWebSocket(request), backoffDelay)
      }
    }
  }

  // æ¶ˆæ¯å¤„ç† â­
  _handleMessage(message) {
    // 1. å¤„ç†å¿ƒè·³
    if (message.type === 'pong') {
      this.lastHeartbeat = Date.now()
      return
    }

    // 2. å¦‚æœæ­£åœ¨ç¼“å†²ï¼Œå­˜å‚¨é‡è¦æ¶ˆæ¯
    if (this.isBuffering && this._isImportantMessage(message.type)) {
      this.messageBuffer.push(message)
      return
    }

    // 3. åˆ†å‘æ¶ˆæ¯ç»™handlers
    this._dispatchMessage(message)
  }

  // é‡è¦æ¶ˆæ¯åˆ¤æ–­
  _isImportantMessage(type) {
    return [
      'workflow_start',
      'step_start',
      'step_complete',
      'agent_event',
      'status_update',
      'error',
      'complete'
    ].includes(type)
  }

  // åˆ·æ–°æ¶ˆæ¯ç¼“å†²åŒº â­
  flushMessageBuffer() {
    this.isBuffering = false
    const messages = [...this.messageBuffer]
    this.messageBuffer = []

    messages.forEach(message => {
      this._dispatchMessage(message)
    })
  }

  // å¿ƒè·³æœºåˆ¶
  _startHeartbeat() {
    this.heartbeatInterval = setInterval(() => {
      if (this.ws && this.ws.readyState === WebSocket.OPEN) {
        this.ws.send(JSON.stringify({ type: 'ping' }))
      }
    }, 10000) // æ¯10ç§’ä¸€æ¬¡
  }
}
```

**ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯ç¼“å†²ï¼Ÿ**

é—®é¢˜åœºæ™¯ï¼š
```
æ—¶é—´çº¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
        â”‚        â”‚         â”‚         â”‚
    startAnalysis  â†’  workflow_start arrives
                   ç»„ä»¶æœªmountï¼Œç›‘å¬å™¨æœªæ³¨å†Œ
                   âŒ æ¶ˆæ¯ä¸¢å¤±ï¼
```

è§£å†³æ–¹æ¡ˆï¼š
```
æ—¶é—´çº¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
        â”‚        â”‚         â”‚         â”‚
    startAnalysis  â†’  workflow_start  â†’  ç»„ä»¶mount
                   å­˜å…¥buffer           åˆ·æ–°buffer
                   âœ… æ¶ˆæ¯ä¿ç•™ï¼        âœ… é‡æ”¾æ¶ˆæ¯ï¼
```

#### 4. ä¼šè¯ç®¡ç†

**æ–‡ä»¶**ï¼š`src/services/sessionManager.js`

**åŠŸèƒ½**ï¼š
- ä¿å­˜åˆ†æä¼šè¯åˆ°localStorage
- åŠ è½½å†å²ä¼šè¯
- æ”¯æŒä¼šè¯æ¢å¤

```javascript
class SessionManager {
  saveSession(session) {
    const sessions = this.getSessions()
    sessions[session.sessionId] = {
      ...session,
      savedAt: Date.now()
    }
    localStorage.setItem('analysis_sessions', JSON.stringify(sessions))
  }

  getSession(sessionId) {
    const sessions = this.getSessions()
    return sessions[sessionId]
  }

  getSessions() {
    const data = localStorage.getItem('analysis_sessions')
    return data ? JSON.parse(data) : {}
  }
}
```

---

## äº§å“åŠŸèƒ½

### 5å¤§æŠ•èµ„åœºæ™¯

#### 1. æ—©æœŸæŠ•èµ„å°½è°ƒ (Early Stage DD)

**é€‚ç”¨å¯¹è±¡**ï¼š
- å¤©ä½¿è½®ã€Pre-Aã€Aè½®é¡¹ç›®
- åˆ›ä¸šå…¬å¸ï¼ˆ0-3å¹´ï¼‰

**åˆ†æé‡ç‚¹**ï¼š
- å›¢é˜ŸèƒŒæ™¯ï¼ˆ40%ï¼‰
- äº§å“éªŒè¯ï¼ˆ30%ï¼‰
- å¸‚åœºæœºä¼šï¼ˆ20%ï¼‰
- é£é™©æ‰«æï¼ˆ10%ï¼‰

**Quickæ¨¡å¼Workflow**ï¼š
```python
[
    {"id": "team_check", "name": "å›¢é˜ŸèƒŒæ™¯æ£€æŸ¥", "agent": "team_evaluator"},
    {"id": "product_validation", "name": "äº§å“éªŒè¯", "agent": "tech_specialist"},
    {"id": "market_opportunity", "name": "å¸‚åœºæœºä¼š", "agent": "market_analyst"},
    {"id": "red_flag_scan", "name": "çº¢æ——æ‰«æ", "agent": "risk_assessor"}
]
```

**è¾“å…¥å­—æ®µ**ï¼š
```json
{
  "company_name": "å…¬å¸åç§°",
  "founders": ["åˆ›å§‹äºº1", "åˆ›å§‹äºº2"],
  "product_description": "äº§å“æè¿°",
  "target_market": "ç›®æ ‡å¸‚åœº",
  "funding_round": "èèµ„è½®æ¬¡",
  "valuation": "ä¼°å€¼"
}
```

#### 2. æˆé•¿æœŸæŠ•èµ„å°½è°ƒ (Growth Investment DD)

**é€‚ç”¨å¯¹è±¡**ï¼š
- Bè½®ã€Cè½®åŠä»¥å
- å·²æœ‰ä¸€å®šè§„æ¨¡çš„å…¬å¸

**åˆ†æé‡ç‚¹**ï¼š
- å•†ä¸šæ¨¡å¼ï¼ˆ30%ï¼‰
- è´¢åŠ¡å¥åº·ï¼ˆ30%ï¼‰
- å¸‚åœºåœ°ä½ï¼ˆ25%ï¼‰
- å¢é•¿æ½œåŠ›ï¼ˆ15%ï¼‰

**Quickæ¨¡å¼Workflow**ï¼š
```python
[
    {"id": "business_model", "name": "å•†ä¸šæ¨¡å¼åˆ†æ"},
    {"id": "financial_health", "name": "è´¢åŠ¡å¥åº·æ£€æŸ¥"},
    {"id": "market_position", "name": "å¸‚åœºåœ°ä½è¯„ä¼°"},
    {"id": "growth_potential", "name": "å¢é•¿æ½œåŠ›åˆ†æ"}
]
```

#### 3. äºŒçº§å¸‚åœºæŠ•èµ„åˆ†æ (Public Market Investment)

**é€‚ç”¨å¯¹è±¡**ï¼š
- ä¸Šå¸‚å…¬å¸
- äºŒçº§å¸‚åœºè‚¡ç¥¨

**åˆ†æé‡ç‚¹**ï¼š
- åŸºæœ¬é¢åˆ†æï¼ˆ35%ï¼‰
- ä¼°å€¼åˆ†æï¼ˆ30%ï¼‰
- å¸‚åœºæƒ…ç»ªï¼ˆ20%ï¼‰
- æŠ€æœ¯é¢ï¼ˆ15%ï¼‰

**æ•°æ®æ¥æº**ï¼š
- SEC Edgar APIï¼ˆè´¢æŠ¥ã€å…¬å‘Šï¼‰
- Yahoo Financeï¼ˆè‚¡ä»·ã€è´¢åŠ¡æ•°æ®ï¼‰
- News APIï¼ˆæ–°é—»èˆ†æƒ…ï¼‰

#### 4. å¦ç±»æŠ•èµ„å°½è°ƒ (Alternative Investment DD)

**é€‚ç”¨å¯¹è±¡**ï¼š
- æˆ¿åœ°äº§
- ç§å‹Ÿè‚¡æƒ
- å¯¹å†²åŸºé‡‘
- å…¶ä»–å¦ç±»èµ„äº§

**åˆ†æé‡ç‚¹**ï¼š
- èµ„äº§è´¨é‡ï¼ˆ40%ï¼‰
- ç°é‡‘æµï¼ˆ30%ï¼‰
- é£é™©å› ç´ ï¼ˆ20%ï¼‰
- é€€å‡ºè·¯å¾„ï¼ˆ10%ï¼‰

#### 5. è¡Œä¸šç ”ç©¶ (Industry Research)

**é€‚ç”¨å¯¹è±¡**ï¼š
- è¡Œä¸šè¶‹åŠ¿åˆ†æ
- ç»†åˆ†èµ›é“ç ”ç©¶
- ç«äº‰æ ¼å±€åˆ†æ

**åˆ†æé‡ç‚¹**ï¼š
- å¸‚åœºè§„æ¨¡ä¸å¢é•¿ï¼ˆ30%ï¼‰
- ç«äº‰æ ¼å±€ï¼ˆ25%ï¼‰
- æŠ€æœ¯è¶‹åŠ¿ï¼ˆ25%ï¼‰
- æŠ•èµ„æœºä¼šï¼ˆ20%ï¼‰

**è¾“å…¥å­—æ®µ**ï¼š
```json
{
  "industry_name": "è¡Œä¸šåç§°",
  "sub_sector": "ç»†åˆ†é¢†åŸŸï¼ˆå¯é€‰ï¼‰",
  "region": "åœ°åŸŸèŒƒå›´ï¼ˆchina/global/usï¼‰",
  "research_topic": "ç ”ç©¶ä¸»é¢˜ï¼ˆå¯é€‰ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰"
}
```

**è‡ªåŠ¨ç”Ÿæˆresearch_topicé€»è¾‘**ï¼š
```python
topic_parts = [industry_name]
if sub_sector:
    topic_parts.append(sub_sector)
if region:
    region_name = {'china': 'ä¸­å›½', 'global': 'å…¨çƒ', 'us': 'ç¾å›½'}
    topic_parts.append(f"{region_name[region]}å¸‚åœº")
else:
    topic_parts.append("å¸‚åœºåˆ†æ")

research_topic = " - ".join(topic_parts)
# ä¾‹å¦‚: "äººå·¥æ™ºèƒ½ - AIèŠ¯ç‰‡ - ä¸­å›½å¸‚åœº"
```

### 3ç§åˆ†ææ·±åº¦

#### Quick (å¿«é€Ÿåˆ¤æ–­)

**æ—¶é•¿**ï¼š3-5åˆ†é’Ÿ
**æ­¥éª¤**ï¼š4-5ä¸ªæ ¸å¿ƒæ­¥éª¤
**è¾“å‡º**ï¼š
- æŠ•èµ„å»ºè®®ï¼ˆBUY/PASS/FURTHER_DDï¼‰
- ç½®ä¿¡åº¦è¯„åˆ†
- å…³é”®å‘ç°
- çº¢æ——è­¦å‘Š

#### Standard (æ ‡å‡†åˆ†æ)

**æ—¶é•¿**ï¼š10-15åˆ†é’Ÿ
**æ­¥éª¤**ï¼š8-10ä¸ªè¯¦ç»†æ­¥éª¤
**è¾“å‡º**ï¼š
- Quickçš„æ‰€æœ‰å†…å®¹
- è¯¦ç»†åˆ†ææŠ¥å‘Š
- æ•°æ®å¯è§†åŒ–
- å¯¹æ¯”åˆ†æ

#### Comprehensive (æ·±åº¦å°½è°ƒ)

**æ—¶é•¿**ï¼š20-30åˆ†é’Ÿ
**æ­¥éª¤**ï¼š15-20ä¸ªå…¨é¢æ­¥éª¤
**è¾“å‡º**ï¼š
- Standardçš„æ‰€æœ‰å†…å®¹
- å¤–éƒ¨æ•°æ®éªŒè¯
- ä¸“å®¶æ„è§æ±‡æ€»
- å®Œæ•´æŠ•èµ„å¤‡å¿˜å½•

---

## å‰åç«¯å¯¹æ¥

### APIæ¥å£è§„èŒƒ

#### 1. å¯åŠ¨åˆ†æ

**æ¥å£**ï¼š`POST /api/v2/analysis/start`

**è¯·æ±‚**ï¼š
```json
{
  "project_name": "é¡¹ç›®åç§°",
  "scenario": "early_stage_dd",
  "target": {
    "company_name": "å…¬å¸å",
    "founders": ["åˆ›å§‹äºº"],
    ...
  },
  "config": {
    "depth": "quick",
    "timeframe": "1Y",
    "focus_areas": [],
    "language": "zh"
  }
}
```

**å“åº”**ï¼š
```json
{
  "session_id": "uuid-xxx-xxx",
  "scenario": "early_stage_dd",
  "depth": "quick",
  "estimated_duration": 300,
  "status": "created"
}
```

#### 2. è·å–åˆ†æçŠ¶æ€

**æ¥å£**ï¼š`GET /api/v2/analysis/{session_id}/status`

**å“åº”**ï¼š
```json
{
  "session_id": "uuid-xxx-xxx",
  "status": "running",
  "progress": 45,
  "current_step": "financial_health",
  "steps_completed": 2,
  "steps_total": 5
}
```

### WebSocketæ¶ˆæ¯æ ¼å¼

#### è¿æ¥

```javascript
ws://localhost:8000/ws/v2/analysis/{session_id}
```

#### æ¶ˆæ¯ç±»å‹

##### 1. workflow_start

```json
{
  "type": "workflow_start",
  "data": {
    "steps": [
      {
        "id": "team_check",
        "name": "earlyStage.teamEvaluation",
        "agent": "earlyStage.teamAnalysisAgent",
        "estimated_duration": 60
      }
    ],
    "total_steps": 5
  }
}
```

**å‰ç«¯å¤„ç†**ï¼š
- åˆå§‹åŒ–workflowæ•°ç»„
- æ£€æµ‹i18n keyï¼ˆåŒ…å«"."ï¼‰
- ç¿»è¯‘æˆä¸­æ–‡æ˜¾ç¤º

##### 2. step_start

```json
{
  "type": "step_start",
  "data": {
    "step_id": "team_check",
    "step_name": "å›¢é˜ŸèƒŒæ™¯æ£€æŸ¥",
    "agent": "team_analyst"
  }
}
```

##### 3. step_progress

```json
{
  "type": "step_progress",
  "data": {
    "step_id": "team_check",
    "progress": 50,
    "message": "æ­£åœ¨åˆ†æåˆ›å§‹äººèƒŒæ™¯..."
  }
}
```

##### 4. step_complete

```json
{
  "type": "step_complete",
  "data": {
    "step_id": "team_check",
    "status": "success",
    "result": {
      "score": 0.85,
      "summary": "å›¢é˜ŸèƒŒæ™¯ä¼˜ç§€ï¼Œåˆ›å§‹äººæœ‰ç›¸å…³è¡Œä¸šç»éªŒ",
      "details": {
        "founders_experience": "10å¹´+",
        "team_completeness": "å®Œæ•´",
        "key_strengths": ["æŠ€æœ¯èƒŒæ™¯å¼º", "è¡Œä¸šäººè„‰å¹¿"]
      }
    },
    "duration": 58
  }
}
```

##### 5. agent_event

```json
{
  "type": "agent_event",
  "data": {
    "agent": "team_analyst",
    "event": "tool_call",
    "tool": "search_linkedin",
    "message": "æ­£åœ¨æœç´¢åˆ›å§‹äººLinkedInä¿¡æ¯..."
  }
}
```

##### 6. complete

```json
{
  "type": "complete",
  "data": {
    "session_id": "uuid-xxx",
    "status": "success",
    "report": {
      "recommendation": "BUY",
      "confidence": 0.82,
      "summary": {...},
      "sections": {...}
    },
    "duration": 285
  }
}
```

##### 7. error

```json
{
  "type": "error",
  "message": "Agent execution failed",
  "details": {
    "agent": "financial_expert",
    "error": "TypeError: string indices must be integers",
    "step_id": "financial_health"
  }
}
```

##### 8. ping/pongï¼ˆå¿ƒè·³ï¼‰

```json
// å®¢æˆ·ç«¯å‘é€
{"type": "ping"}

// æœåŠ¡å™¨å“åº”
{"type": "pong"}
```

### æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·æ“ä½œ   â”‚
â”‚  é€‰æ‹©åœºæ™¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/v2/analysis/start    â”‚
â”‚  åˆ›å»ºsessionï¼Œè¿”å›session_id     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebSocketè¿æ¥                   â”‚
â”‚  ws://.../ws/v2/analysis/{id}   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¥æ”¶workflow_startæ¶ˆæ¯          â”‚
â”‚  å‰ç«¯åˆå§‹åŒ–workflow[]            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¾ªç¯æ¥æ”¶æ¶ˆæ¯ï¼š                  â”‚
â”‚  - step_start                   â”‚
â”‚  - step_progress                â”‚
â”‚  - agent_event                  â”‚
â”‚  - step_complete                â”‚
â”‚  æ›´æ–°UIçŠ¶æ€                      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¥æ”¶completeæ¶ˆæ¯                â”‚
â”‚  æ˜¾ç¤ºæœ€ç»ˆæŠ¥å‘Š                    â”‚
â”‚  ä¿å­˜åˆ°localStorage              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## éƒ¨ç½²æ¶æ„

### Docker Composeé…ç½®

```yaml
version: '3.8'

services:
  # åç«¯APIæœåŠ¡
  report_orchestrator:
    build: ./backend/services/report_orchestrator
    ports:
      - "8000:8000"
    environment:
      - LLM_GATEWAY_URL=http://llm_gateway:8001
      - DATABASE_URL=postgresql://user:pass@postgres:5432/magellan
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis
      - llm_gateway
    volumes:
      - ./backend:/usr/src/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # LLM Gateway
  llm_gateway:
    build: ./backend/services/llm_gateway
    ports:
      - "8001:8001"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

  # å‰ç«¯å¼€å‘æœåŠ¡å™¨
  frontend:
    build: ./frontend
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    command: npm run dev

  # PostgreSQLæ•°æ®åº“
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_USER=magellan
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=magellan
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  # Nginx (ç”Ÿäº§ç¯å¢ƒ)
  nginx:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./frontend/dist:/usr/share/nginx/html
    depends_on:
      - report_orchestrator

volumes:
  postgres_data:
```

### å¯åŠ¨å‘½ä»¤

```bash
# å¼€å‘ç¯å¢ƒ
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f report_orchestrator

# é‡å¯æœåŠ¡
docker-compose restart report_orchestrator

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# é‡æ–°æ„å»º
docker-compose build --no-cache
```

---

## å¼€å‘æŒ‡å—

### æ–°äººä¸Šæ‰‹æ­¥éª¤

#### 1. ç¯å¢ƒå‡†å¤‡

```bash
# å…‹éš†ä»£ç 
git clone <repository-url>
cd Magellan

# å®‰è£…åç«¯ä¾èµ–ï¼ˆå¯é€‰ï¼Œä½¿ç”¨Dockeråˆ™ä¸éœ€è¦ï¼‰
cd backend/services/report_orchestrator
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt

# å®‰è£…å‰ç«¯ä¾èµ–
cd ../../../frontend
npm install

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘.envï¼Œå¡«å…¥APIå¯†é’¥
```

#### 2. å¯åŠ¨æœåŠ¡

```bash
# æ–¹å¼1ï¼šä½¿ç”¨Docker Composeï¼ˆæ¨èï¼‰
docker-compose up -d

# æ–¹å¼2ï¼šæ‰‹åŠ¨å¯åŠ¨
# ç»ˆç«¯1 - åç«¯
cd backend/services/report_orchestrator
uvicorn app.main:app --reload --port 8000

# ç»ˆç«¯2 - å‰ç«¯
cd frontend
npm run dev

# ç»ˆç«¯3 - LLM Gateway
cd backend/services/llm_gateway
uvicorn app.main:app --reload --port 8001
```

#### 3. éªŒè¯éƒ¨ç½²

è®¿é—®ï¼š
- å‰ç«¯ï¼šhttp://localhost:5173
- åç«¯APIæ–‡æ¡£ï¼šhttp://localhost:8000/docs
- LLM Gatewayï¼šhttp://localhost:8001/docs

#### 4. å¼€å‘æµç¨‹

**æ·»åŠ æ–°Agent**ï¼š

1. åˆ›å»ºAgentç±»
```python
# backend/services/report_orchestrator/app/core/roundtable/my_agent.py
from .agent import Agent

class MyAgent(Agent):
    def __init__(self, session_id: str, **kwargs):
        super().__init__(
            name="MyAgent",
            session_id=session_id,
            system_prompt="ä½ æ˜¯ä¸€ä¸ª...",
            tools=["search_data", "analyze_trend"]
        )

    async def analyze(self, context: Dict[str, Any]) -> Dict[str, Any]:
        # å®ç°åˆ†æé€»è¾‘
        return await super().analyze(context)
```

2. æ³¨å†ŒAgent
```python
# backend/services/report_orchestrator/app/core/agent_registry.py
from .roundtable.my_agent import MyAgent

class AgentRegistry:
    AGENTS = {
        # ...
        "my_agent": MyAgent,
    }
```

3. åœ¨Orchestratorä¸­ä½¿ç”¨
```python
def _get_workflow(self):
    return [
        {
            "id": "my_step",
            "name": "æˆ‘çš„åˆ†ææ­¥éª¤",
            "agent": "my_agent",
            "estimated_duration": 60
        }
    ]
```

**æ·»åŠ æ–°åœºæ™¯**ï¼š

1. åˆ›å»ºOrchestrator
```python
# app/core/orchestrators/my_scenario_orchestrator.py
from .base_orchestrator import BaseOrchestrator

class MyScenarioOrchestrator(BaseOrchestrator):
    def __init__(self, session_id, request, websocket):
        super().__init__(
            scenario=InvestmentScenario.MY_SCENARIO,
            session_id=session_id,
            request=request,
            websocket=websocket
        )
```

2. æ³¨å†Œè·¯ç”±
```python
# app/api/v2/analysis.py
SCENARIO_ORCHESTRATORS = {
    # ...
    "my_scenario": MyScenarioOrchestrator
}
```

3. æ·»åŠ å‰ç«¯åœºæ™¯
```javascript
// frontend/src/components/analysis/ScenarioSelection.vue
const scenarios = [
  // ...
  {
    id: 'my_scenario',
    name: 'æˆ‘çš„åœºæ™¯',
    description: 'æè¿°...',
    icon: 'analytics'
  }
]
```

**è°ƒè¯•æŠ€å·§**ï¼š

```bash
# æŸ¥çœ‹åç«¯å®æ—¶æ—¥å¿—
docker-compose logs -f report_orchestrator

# æŸ¥çœ‹WebSocketæ¶ˆæ¯
# åœ¨æµè§ˆå™¨Consoleä¸­
window.ws = analysisServiceV2.ws
window.ws.addEventListener('message', (e) => {
  console.log('WS:', JSON.parse(e.data))
})

# æ£€æŸ¥Agentè¾“å‡º
# åœ¨agent.pyä¸­æ·»åŠ 
print(f"[Agent:{self.name}] ğŸ” DEBUG: {variable}")

# å‰ç«¯æŸ¥çœ‹ç¼“å†²æ¶ˆæ¯
console.log(analysisServiceV2.messageBuffer)
```

### ä»£ç è§„èŒƒ

**åç«¯**ï¼š
- éµå¾ªPEP 8
- ç±»å‹æ³¨è§£ï¼ˆType Hintsï¼‰
- Docstringï¼ˆGoogleé£æ ¼ï¼‰
- å¼‚æ­¥ä¼˜å…ˆï¼ˆasync/awaitï¼‰

**å‰ç«¯**ï¼š
- Vue 3 Composition API
- ç»„ä»¶å‘½åï¼šPascalCase
- æ–‡ä»¶å‘½åï¼škebab-case
- ä½¿ç”¨Composableså…±äº«é€»è¾‘

### æµ‹è¯•

```bash
# åç«¯å•å…ƒæµ‹è¯•
cd backend/services/report_orchestrator
pytest

# E2Eæµ‹è¯•
python test_phase3_e2e.py

# å‰ç«¯æµ‹è¯•ï¼ˆå¾…å®Œå–„ï¼‰
cd frontend
npm run test
```

---

## å¸¸è§é—®é¢˜

### Q1: WebSocketæ¶ˆæ¯ä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ

**åŸå› **ï¼šç»„ä»¶mountå‰æ¶ˆæ¯å·²åˆ°è¾¾

**è§£å†³**ï¼š
1. å‰ç«¯ä½¿ç”¨æ¶ˆæ¯ç¼“å†²æœºåˆ¶
2. ç»„ä»¶mountåè°ƒç”¨`flushMessageBuffer()`
3. ç¡®ä¿é‡è¦æ¶ˆæ¯ç±»å‹åœ¨ç¼“å†²åˆ—è¡¨ä¸­

### Q2: Agentåç§°æ˜¾ç¤ºè‹±æ–‡keyè€Œéä¸­æ–‡ï¼Ÿ

**åŸå› **ï¼š
1. åç«¯å‘é€äº†i18n key
2. å‰ç«¯æœªæ£€æµ‹å’Œç¿»è¯‘

**è§£å†³**ï¼š
```javascript
// æ£€æµ‹åŒ…å«"."çš„å­—ç¬¦ä¸²ä¸ºi18n key
if (name && name.includes('.')) {
  name = t(name)
}
```

### Q3: è´¢åŠ¡åˆ†ææŠ¥TypeErrorï¼Ÿ

**å½“å‰çŠ¶æ€**ï¼šå·²æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼Œå¾…æ”¶é›†æ•°æ®

**ä¸´æ—¶è§£å†³**ï¼š
- æ£€æŸ¥LLM Gatewayå“åº”æ ¼å¼
- ç¡®ä¿è¿”å›æ ‡å‡†dictæ ¼å¼

### Q4: æµè§ˆå™¨ç¼“å­˜å¯¼è‡´ä»£ç ä¸æ›´æ–°ï¼Ÿ

**è§£å†³**ï¼š
```bash
# æ–¹å¼1ï¼šç¡¬åˆ·æ–°
Cmd/Ctrl + Shift + R

# æ–¹å¼2ï¼šæ¸…é™¤ç¼“å­˜
# å¼€å‘è€…å·¥å…· â†’ Application â†’ Clear storage

# æ–¹å¼3ï¼šç¦ç”¨ç¼“å­˜
# å¼€å‘è€…å·¥å…· â†’ Network â†’ Disable cache
```

### Q5: Dockerå®¹å™¨ä»£ç ä¸æ›´æ–°ï¼Ÿ

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥volumeæŒ‚è½½
docker-compose config | grep volumes

# é‡å¯å®¹å™¨
docker-compose restart report_orchestrator

# é‡æ–°æ„å»º
docker-compose build --no-cache report_orchestrator
docker-compose up -d
```

### Q6: å¦‚ä½•æ·»åŠ æ–°çš„å·¥å…·(Tool)ï¼Ÿ

**æ­¥éª¤**ï¼š
1. åœ¨Agentç±»ä¸­å®šä¹‰å·¥å…·
```python
self.tools = {
    "my_tool": "å·¥å…·æè¿°"
}
```

2. å®ç°å·¥å…·æ–¹æ³•
```python
def _execute_tool(self, tool_name: str, params: str):
    if tool_name == "my_tool":
        return self._my_tool_impl(params)
    return super()._execute_tool(tool_name, params)

def _my_tool_impl(self, params: str):
    # å®ç°é€»è¾‘
    return "ç»“æœ"
```

3. LLMä¼šè‡ªåŠ¨è°ƒç”¨å·¥å…·
```
[USE_TOOL: my_tool(param1, param2)]
```

### Q7: å¦‚ä½•åˆ‡æ¢LLMæ¨¡å‹ï¼Ÿ

**é…ç½®**ï¼š
```python
# app/core/roundtable/agent.py
llm_response = await self._call_llm(
    messages,
    model="gpt-4",  # æˆ– "claude-3-opus"
    temperature=0.7
)
```

---

## é™„å½•

### ç›¸å…³æ–‡æ¡£

- [å½“å‰é—®é¢˜è®°å½•](./CURRENT_ISSUES.md)
- [APIæ–‡æ¡£](http://localhost:8000/docs)
- [å‰ç«¯å›½é™…åŒ–æŒ‡å—](./frontend/I18N_README.md)
- [è¯­è¨€åˆ‡æ¢æŒ‡å—](./frontend/LANGUAGE_SWITCH_GUIDE.md)

### æŠ€æœ¯æ ˆæ–‡æ¡£é“¾æ¥

- [Vue 3](https://vuejs.org/)
- [FastAPI](https://fastapi.tiangolo.com/)
- [TailwindCSS](https://tailwindcss.com/)
- [WebSocket API](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)

### ç‰ˆæœ¬å†å²

- **V3**: å®Œæ•´UIé‡æ„ï¼Œshadcn/uiä¸»é¢˜
- **V2**: 5åœºæ™¯æ”¯æŒï¼ŒAgent Registry
- **V1**: MVPç‰ˆæœ¬

---

**æœ€åæ›´æ–°**ï¼š2025-11-20
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ
**è”ç³»æ–¹å¼**ï¼š[å¾…å¡«å†™]
