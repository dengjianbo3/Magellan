# Magellan Trading System - å®Œæ•´æ¶æ„ä¸èƒ½åŠ›æ–‡æ¡£ v3.1

> **æ–‡æ¡£æ›´æ–°æ—¥æœŸ**: 2026-01-06
> **é€‚ç”¨ç‰ˆæœ¬**: dev åˆ†æ”¯ (LangGraph + ExecutorAgent å¢å¼ºç‰ˆ + ç”Ÿäº§ç¯å¢ƒæ”¯æŒ)

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
3. [äº¤æ˜“ç³»ç»Ÿè¯¦è§£](#äº¤æ˜“ç³»ç»Ÿè¯¦è§£)
4. [è§¦å‘å™¨ç³»ç»Ÿ (TriggerAgent)](#è§¦å‘å™¨ç³»ç»Ÿ-triggeragent)
5. [æ‰§è¡Œç³»ç»Ÿ (ExecutorAgent)](#æ‰§è¡Œç³»ç»Ÿ-executoragent)
6. [èµ„é‡‘è´¹ç‡æ„ŸçŸ¥ç³»ç»Ÿ](#èµ„é‡‘è´¹ç‡æ„ŸçŸ¥ç³»ç»Ÿ-funding-fee-system)
7. [LangGraph å·¥ä½œæµ](#langgraph-å·¥ä½œæµ)
8. [é‡æ„å˜æ›´è®°å½•](#é‡æ„å˜æ›´è®°å½•)
9. [æœªå®ç°ä¸ç§»é™¤çš„èƒ½åŠ›](#æœªå®ç°ä¸ç§»é™¤çš„èƒ½åŠ›)
10. [æ”¹è¿›å»ºè®®ä¸æœªæ¥è§„åˆ’](#æ”¹è¿›å»ºè®®ä¸æœªæ¥è§„åˆ’)
11. [å¿«é€Ÿå¼€å§‹æŒ‡å—](#å¿«é€Ÿå¼€å§‹æŒ‡å—)
12. [ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—](#ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—)
13. [Bug ä¿®å¤è®°å½•](#bug-ä¿®å¤è®°å½•-2026-01)
14. [å¸¸è§é—®é¢˜æ’æŸ¥](#å¸¸è§é—®é¢˜æ’æŸ¥)

---

## ç³»ç»Ÿæ¦‚è¿°

### é¡¹ç›®å®šä½

**Magellan** æ˜¯ä¸€ä¸ª AI é©±åŠ¨çš„åŠ å¯†è´§å¸äº¤æ˜“ç³»ç»Ÿï¼Œå…·æœ‰åŒé‡ç”¨é€”ï¼š

1. **æŠ•èµ„å°½è°ƒå¹³å°** - å¤šåœºæ™¯æŠ•èµ„åˆ†ææŠ¥å‘Šç”Ÿæˆ
2. **è‡ªåŠ¨äº¤æ˜“ç³»ç»Ÿ** - å¤š Agent åä½œçš„ BTC/USDT æ°¸ç»­åˆçº¦äº¤æ˜“

### æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | æè¿° |
|------|------|
| **å¤š Agent åä½œ** | 7+ ä¸“ä¸šåˆ†æ Agent (æŠ€æœ¯é¢ã€åŸºæœ¬é¢ã€é“¾ä¸Šæ•°æ®ç­‰) |
| **æ™ºèƒ½è§¦å‘** | TriggerAgent ç›‘æ§å¸‚åœºï¼Œæ™ºèƒ½å†³å®šä½•æ—¶å¯åŠ¨åˆ†æ |
| **LangGraph ç¼–æ’** | åŸºäºçŠ¶æ€æœºçš„å·¥ä½œæµï¼Œæ”¯æŒæ¡ä»¶åˆ†æ”¯å’Œé”™è¯¯æ¢å¤ |
| **ä»“ä½ç®¡ç†** | æ”¯æŒåŠ ä»“ã€å‡ä»“ã€åå‘æ“ä½œçš„æ™ºèƒ½ä»“ä½ç®¡ç† |
| **é£é™©æ§åˆ¶** | å¤šå±‚å®‰å…¨æ£€æŸ¥ (å¯åŠ¨ä¿æŠ¤ã€æ­¢æŸéªŒè¯ã€çˆ†ä»“é£é™©) |

---

## æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Magellan Trading System v3.0                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                       Trigger Layer (è§¦å‘å±‚)                         â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚TriggerSchedulerâ”‚ â”‚ TriggerAgent â”‚ â”‚ NewsCrawler â”‚ â”‚TACalculatorâ”‚ â”‚    â”‚
â”‚  â”‚  â”‚  (å®šæ—¶æ£€æŸ¥)   â”‚ â”‚  (LLMåˆ†æ)   â”‚ â”‚  (æ–°é—»æŠ“å–) â”‚ â”‚ (æŠ€æœ¯æŒ‡æ ‡) â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â”‚                          â”‚                                          â”‚    â”‚
â”‚  â”‚                    TriggerLock (çŠ¶æ€æœº)                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚ (è§¦å‘æ—¶è°ƒç”¨)                           â”‚
â”‚                                     â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    Orchestration Layer (ç¼–æ’å±‚)                      â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚    â”‚
â”‚  â”‚  â”‚  TradingGraph   â”‚â”€â”€â”‚     7 Nodes     â”‚â”€â”€â”‚   TradingState  â”‚     â”‚    â”‚
â”‚  â”‚  â”‚   (LangGraph)   â”‚  â”‚ (å·¥ä½œæµèŠ‚ç‚¹)     â”‚  â”‚   (çŠ¶æ€ç®¡ç†)    â”‚     â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚                                        â”‚
â”‚                                     â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         Agent Layer (åˆ†æå±‚)                         â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚ TA_Analyst  â”‚ â”‚ Fund_Analystâ”‚ â”‚Chain_Analystâ”‚ â”‚ Macro_Expertâ”‚  â”‚    â”‚
â”‚  â”‚  â”‚  (æŠ€æœ¯åˆ†æ) â”‚ â”‚  (èµ„é‡‘æµ)   â”‚ â”‚ (é“¾ä¸Šæ•°æ®)  â”‚ â”‚  (å®è§‚)     â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚                                        â”‚
â”‚                                     â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                       Execution Layer (æ‰§è¡Œå±‚)                       â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚                    ExecutorAgent                              â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ 7 Tools: open_long, open_short, close_position, hold,  â”‚ â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚          add_to_long, add_to_short, reduce_position    â”‚ â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ Safety: _validate_stop_loss, _get_available_margin,    â”‚ â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚         MIN_ADD_AMOUNT=10, SAFETY_BUFFER=50             â”‚ â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚                                        â”‚
â”‚                                     â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                        Trading Layer (äº¤æ˜“å±‚)                        â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚    â”‚
â”‚  â”‚  â”‚      PaperTrader         â”‚    â”‚       OKX API            â”‚      â”‚    â”‚
â”‚  â”‚  â”‚   (æ¨¡æ‹Ÿäº¤æ˜“/å›æµ‹)        â”‚    â”‚   (å®ç›˜/æ¨¡æ‹Ÿç›˜)          â”‚      â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚                                        â”‚
â”‚                                     â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                        Memory Layer (è®°å¿†å±‚)                         â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚ ReflectionMemory â”‚ â”‚  AgentWeights    â”‚ â”‚ TradingDecision  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚    (Redis)       â”‚ â”‚    (Redis)       â”‚ â”‚  Store (Redis)   â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç›®å½•ç»“æ„

```
backend/services/report_orchestrator/app/core/trading/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ trading_meeting.py          # ä¸»å…¥å£ (å…¼å®¹æ—§ç‰ˆ + LangGraph)
â”œâ”€â”€ executor_agent.py           # â­ æ‰§è¡Œå™¨ Agent (7 å·¥å…· + å®‰å…¨é€»è¾‘)
â”œâ”€â”€ executor.py                 # æ—§ç‰ˆ TradeExecutor
â”‚
â”œâ”€â”€ trigger/                    # â­ è§¦å‘å™¨ç³»ç»Ÿ (ä¸‰å±‚æ¶æ„)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ fast_monitor.py        # ğŸ†• Layer 1: ç¡¬æ¡ä»¶æ£€æµ‹ (æ—  LLM)
â”‚   â”œâ”€â”€ agent.py               # Layer 2: TriggerAgent (LLM é©±åŠ¨)
â”‚   â”œâ”€â”€ scheduler.py           # TriggerScheduler (å®šæ—¶æ£€æŸ¥)
â”‚   â”œâ”€â”€ lock.py                # TriggerLock (çŠ¶æ€æœº)
â”‚   â”œâ”€â”€ news_crawler.py        # æ–°é—»æŠ“å–
â”‚   â”œâ”€â”€ ta_calculator.py       # æŠ€æœ¯æŒ‡æ ‡è®¡ç®—
â”‚   â”œâ”€â”€ scorer.py              # è§„åˆ™è¯„åˆ†å™¨ (å¤‡ç”¨)
â”‚   â””â”€â”€ prompts.py             # LLM æç¤ºè¯
â”‚
â”œâ”€â”€ orchestration/             # â­ LangGraph ç¼–æ’
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ graph.py               # TradingGraph ä¸»å…¥å£
â”‚   â”œâ”€â”€ nodes.py               # 7 ä¸ªå·¥ä½œæµèŠ‚ç‚¹
â”‚   â””â”€â”€ state.py               # TradingState å®šä¹‰
â”‚
â”œâ”€â”€ domain/                    # é¢†åŸŸæ¨¡å‹
â”‚   â”œâ”€â”€ unified_position.py    # ç»Ÿä¸€ä»“ä½æ¨¡å‹
â”‚   â””â”€â”€ account.py             # è´¦æˆ·ä¿¡æ¯
â”‚
â”œâ”€â”€ safety/                    # å®‰å…¨æ§åˆ¶
â”‚   â””â”€â”€ guards.py              # SafetyGuard
â”‚
â””â”€â”€ reflection/                # åæ€å­¦ä¹ 
    â””â”€â”€ engine.py              # ReflectionEngine
```

---

## äº¤æ˜“ç³»ç»Ÿè¯¦è§£

### äº¤æ˜“å†³ç­–æµç¨‹

```
å¸‚åœºå˜åŒ– â†’ TriggerAgent åˆ¤æ–­ â†’ è§¦å‘åˆ†æ?
                                   â”‚ YES
                                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         LangGraph Workflow               â”‚
        â”‚                                          â”‚
        â”‚  market_analysis_node                    â”‚
        â”‚         â†“                                â”‚
        â”‚  signal_generation_node (Agents æŠ•ç¥¨)   â”‚
        â”‚         â†“                                â”‚
        â”‚  risk_assessment_node (å®‰å…¨æ£€æŸ¥)         â”‚
        â”‚         â†“                                â”‚
        â”‚  consensus_node (è¾¾æˆå…±è¯†)               â”‚
        â”‚         â†“                                â”‚
        â”‚  execution_node â†’ ExecutorAgent         â”‚
        â”‚         â†“                                â”‚
        â”‚  reflection_node (è®°å½•åæ€)              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
            äº¤æ˜“ä¿¡å·ç”Ÿæˆ â†’ PaperTrader/OKX æ‰§è¡Œ
```

### Agent æŠ•ç¥¨æœºåˆ¶

æ¯ä¸ªåˆ†æ Agent è¿”å›æŠ•ç¥¨ç»“æœï¼š

```python
{
    "agent_id": "technical_analyst",
    "direction": "long",      # long/short/hold
    "confidence": 75,         # 0-100
    "key_factors": ["RSI oversold", "Golden cross"],
    "reasoning": "æŠ€æœ¯é¢çœ‹æ¶¨..."
}
```

å…±è¯†è®¡ç®—è§„åˆ™ï¼š

- åŠ æƒå¹³å‡å„ Agent æŠ•ç¥¨
- åŠ¨æ€æƒé‡åŸºäºå†å²å‡†ç¡®ç‡
- ä¿¡å¿ƒåº¦ä½äºé˜ˆå€¼åˆ™ HOLD

---

## è§¦å‘å™¨ç³»ç»Ÿ (TriggerAgent)

### è®¾è®¡ç›®æ ‡

é¿å…åœ¨æ— å˜åŒ–çš„å¸‚åœºä¸­é¢‘ç¹è°ƒç”¨ LLM åˆ†æï¼ŒèŠ‚çœ API æˆæœ¬ã€‚

### ç»„ä»¶è¯´æ˜

| ç»„ä»¶ | èŒè´£ |
|------|------|
| `TriggerScheduler` | æ¯ 5 åˆ†é’Ÿæ‰§è¡Œå®šæ—¶æ£€æŸ¥ |
| `TriggerAgent` | ä½¿ç”¨ LLM åˆ†ææ˜¯å¦åº”è¯¥è§¦å‘ä¸»åˆ†æ |
| `TriggerLock` | çŠ¶æ€æœºï¼Œé˜²æ­¢å¹¶å‘è§¦å‘å’Œä¸»åˆ†æå†²çª |
| `NewsCrawler` | æŠ“å–åŠ å¯†è´§å¸ç›¸å…³æ–°é—» |
| `TACalculator` | è®¡ç®— RSIã€MACDã€æˆäº¤é‡ç­‰æŠ€æœ¯æŒ‡æ ‡ |

### çŠ¶æ€æœº (TriggerLock)

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  idle   â”‚ â† åˆå§‹çŠ¶æ€
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚ acquire() è§¦å‘æ£€æŸ¥
                         â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚checking â”‚ â† TriggerAgent è¿è¡Œä¸­
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚ release_check()
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚               â”‚
    should_trigger   not_trigger    error
         â”‚               â”‚               â”‚
         â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚analyzingâ”‚    â”‚ cooldown â”‚    â”‚  idle   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚ (5 åˆ†é’Ÿåè¿‡æœŸ)
         â”‚              â–¼
         â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â””â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  idle   â”‚
   release()       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»“ä½æ„ŸçŸ¥èƒ½åŠ›

TriggerAgent ç°åœ¨å¯ä»¥æ„ŸçŸ¥å½“å‰ä»“ä½çŠ¶æ€ï¼š

```python
# TriggerContext æ–°å¢å­—æ®µ
has_position: bool = False
position_direction: str = "none"
position_pnl_percent: float = 0.0
position_size_usd: float = 0.0
```

è¿™ä½¿ TriggerAgent å¯ä»¥åšå‡ºä»“ä½ç›¸å…³å†³ç­–ï¼š

- æŒä»“æµ®äº >10%? â†’ å¯èƒ½éœ€è¦æ­¢æŸåˆ†æ
- æŒä»“æµ®ç›ˆ >15%? â†’ è€ƒè™‘æ˜¯å¦é”å®šåˆ©æ¶¦

### ä¸‰å±‚è§¦å‘å™¨æ¶æ„ (FastMonitor + TriggerAgent)

ä¸ºäº†æ›´é«˜æ•ˆåœ°å“åº”å¸‚åœºå˜åŒ–ï¼Œç³»ç»Ÿé‡‡ç”¨ä¸‰å±‚è§¦å‘æ¶æ„ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¸‰å±‚è§¦å‘å™¨æ¶æ„                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Layer 1: FastMonitor (æ¯ 5 åˆ†é’Ÿï¼Œæ—  LLM è°ƒç”¨)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ç¡¬æ¡ä»¶æ£€æµ‹ - çº¯è§„åˆ™è®¡ç®—ï¼Œé›¶ API æˆæœ¬                               â”‚ â”‚
â”‚  â”‚  - ä»·æ ¼æ€¥æ¶¨æ€¥è·Œ (1m/5m/15m)                                        â”‚ â”‚
â”‚  â”‚  - æˆäº¤é‡å¼‚å¸¸æ”¾å¤§                                                  â”‚ â”‚
â”‚  â”‚  - èµ„é‡‘è´¹ç‡æç«¯/çªå˜                                               â”‚ â”‚
â”‚  â”‚  - æŒä»“é‡å¼‚å¸¸å˜åŒ–                                                  â”‚ â”‚
â”‚  â”‚  - RSI æç«¯è¶…ä¹°/è¶…å–                                               â”‚ â”‚
â”‚  â”‚  - EMA ä»·æ ¼åç¦»                                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚ ä»»ä¸€æ¡ä»¶è§¦å‘                               â”‚
â”‚                            â–¼                                            â”‚
â”‚  Layer 2: TriggerAgent (æ¡ä»¶è§¦å‘æ—¶ï¼ŒLLM åˆ†æ)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  LLM æ·±åº¦åˆ†æ                                                      â”‚ â”‚
â”‚  â”‚  - ç»¼åˆæ–°é—» + æŠ€æœ¯æŒ‡æ ‡                                             â”‚ â”‚
â”‚  â”‚  - è€ƒè™‘å½“å‰ä»“ä½çŠ¶æ€                                                â”‚ â”‚
â”‚  â”‚  - è¾“å‡º should_trigger + confidence                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                            â”‚ should_trigger=True && confidence>60       â”‚
â”‚                            â–¼                                            â”‚
â”‚  Layer 3: Full Analysis (å®Œæ•´å¤š Agent åˆ†æ)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  5 Agent æŠ•ç¥¨ â†’ Leader å…±è¯† â†’ ExecutorAgent æ‰§è¡Œ                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### FastMonitor ç¡¬æ¡ä»¶æŒ‡æ ‡ (6 ç±»)

| æŒ‡æ ‡ | é˜ˆå€¼ | ç´§æ€¥åº¦ | OKX API |
|------|------|--------|---------|
| ä»·æ ¼æ€¥å˜ (1m) | Â±1.5% | high | `/market/candles` |
| ä»·æ ¼æ€¥å˜ (5m) | Â±2.5% | high | `/market/candles` |
| ä»·æ ¼æ€¥å˜ (15m) | Â±4.0% | critical | `/market/candles` |
| æˆäº¤é‡å¼‚å¸¸ (1m) | >5x å‡å€¼ | high | `/market/candles` |
| æˆäº¤é‡å¼‚å¸¸ (5m) | >3x å‡å€¼ | medium | `/market/candles` |
| èµ„é‡‘è´¹ç‡æç«¯ | >0.1% | high | `/public/funding-rate` |
| èµ„é‡‘è´¹ç‡çªå˜ | >0.05% | medium | `/public/funding-rate` |
| æŒä»“é‡å˜åŒ– | >3% (15min) | medium | `/public/open-interest` |
| RSI è¶…ä¹° | >85 | medium | è®¡ç®—è‡ª K çº¿ |
| RSI è¶…å– | <15 | medium | è®¡ç®—è‡ª K çº¿ |
| EMA åç¦» | >5% vs EMA20 | medium | è®¡ç®—è‡ª K çº¿ |

### FastMonitor é…ç½®

```python
class FastMonitorConfig:
    # ä»·æ ¼æ€¥å˜
    PRICE_SPIKE_1M = 1.5       # 1åˆ†é’Ÿå˜åŠ¨ Â±1.5%
    PRICE_SPIKE_5M = 2.5       # 5åˆ†é’Ÿå˜åŠ¨ Â±2.5%
    PRICE_SPIKE_15M = 4.0      # 15åˆ†é’Ÿå˜åŠ¨ Â±4.0%
    
    # æˆäº¤é‡å¼‚å¸¸
    VOLUME_SPIKE_5M = 3.0      # 5åˆ†é’Ÿæˆäº¤é‡ > 3x å‡å€¼
    VOLUME_SPIKE_1M = 5.0      # 1åˆ†é’Ÿæˆäº¤é‡ > 5x å‡å€¼
    
    # èµ„é‡‘è´¹ç‡
    FUNDING_RATE_EXTREME = 0.1     # èµ„é‡‘è´¹ç‡ > 0.1%
    FUNDING_RATE_CHANGE = 0.05     # èµ„é‡‘è´¹ç‡å˜åŒ– > 0.05%
    
    # æŒä»“é‡
    OI_CHANGE_15M = 3.0        # 15åˆ†é’Ÿ OI å˜åŒ– > 3%
    
    # æŠ€æœ¯æŒ‡æ ‡
    RSI_OVERBOUGHT = 85        # RSI > 85 æç«¯è¶…ä¹°
    RSI_OVERSOLD = 15          # RSI < 15 æç«¯è¶…å–
    EMA_DEVIATION = 5.0        # ä»·æ ¼ vs EMA20 åç¦» > 5%
```

### ç¯å¢ƒå˜é‡

```bash
# å¯ç”¨/ç¦ç”¨ FastMonitor
FAST_MONITOR_ENABLED=true   # é»˜è®¤å¯ç”¨

# æ£€æŸ¥é—´éš” (åˆ†é’Ÿ)
TRIGGER_INTERVAL_MINUTES=5  # é»˜è®¤ 5 åˆ†é’Ÿ
```

### æˆæœ¬èŠ‚çœæ•ˆæœ

| åœºæ™¯ | åŸæ¶æ„ | ä¸‰å±‚æ¶æ„ |
|------|--------|----------|
| å¸‚åœºå¹³é™ | æ¯æ¬¡è°ƒç”¨ LLM | ä»… FastMonitor (0 API è°ƒç”¨) |
| è½»å¾®æ³¢åŠ¨ | è°ƒç”¨ LLM | FastMonitor + TriggerAgent |
| å‰§çƒˆæ³¢åŠ¨ | è°ƒç”¨å®Œæ•´åˆ†æ | 3 å±‚å…¨éƒ¨æ‰§è¡Œ |
| é¢„ä¼°èŠ‚çœ | - | 60-80% LLM è°ƒç”¨ |

---

## æ‰§è¡Œç³»ç»Ÿ (ExecutorAgent)

### 7 ä¸ªäº¤æ˜“å·¥å…·

| å·¥å…· | ç”¨é€” | ç›´æ¥è°ƒç”¨ |
|------|------|----------|
| `open_long` | å¼€å¤šä»“ (å«åå‘é€»è¾‘) | âœ… paper_trader.open_long() |
| `open_short` | å¼€ç©ºä»“ (å«åå‘é€»è¾‘) | âœ… paper_trader.open_short() |
| `hold` | è§‚æœ›ä¸æ“ä½œ | æ— äº¤æ˜“è°ƒç”¨ |
| `close_position` | å®Œå…¨å¹³ä»“ | âœ… paper_trader.close_position() |
| `add_to_long` | åŠ å¤šä»“ | âœ… paper_trader.open_long() (å°ä»“) |
| `add_to_short` | åŠ ç©ºä»“ | âœ… paper_trader.open_short() (å°ä»“) |
| `reduce_position` | éƒ¨åˆ†å¹³ä»“ | âœ… paper_trader.close_position(partial) |

### åœºæ™¯é€»è¾‘ (open_long ç¤ºä¾‹)

```
LLM å†³å®š LONG
     â”‚
     â–¼
å½“å‰ä»“ä½æ£€æŸ¥
     â”‚
     â”œâ”€â”€â”€ å·²æŒæœ‰ LONG â”€â”€â†’ åŠ ä»“æˆ–ç»´æŒ
     â”‚
     â”œâ”€â”€â”€ å·²æŒæœ‰ SHORT â”€â”€â†’ å…ˆå¹³ç©ºï¼Œå†å¼€å¤š (åå‘æ“ä½œ)
     â”‚
     â””â”€â”€â”€ æ— ä»“ä½ â”€â”€â†’ æ–°å¼€å¤šä»“
```

### å®‰å…¨æœºåˆ¶

```python
# å®‰å…¨å¸¸é‡
MIN_ADD_AMOUNT = 10.0   # æœ€å°åŠ ä»“é‡‘é¢ (USDT)
SAFETY_BUFFER = 50.0    # ä¿è¯é‡‘å®‰å…¨ç¼“å†² (USDT)

# å®‰å…¨æ–¹æ³•
_get_position_info()      # è·å–å½“å‰ä»“ä½
_get_available_margin()   # çœŸå®å¯ç”¨ä¿è¯é‡‘ (å«æœªå®ç°ç›ˆäº)
_validate_stop_loss()     # éªŒè¯æ­¢æŸä»·æ ¼ä¸ä½äºçˆ†ä»“ä»·æ ¼
```

### æ­¢æŸéªŒè¯é€»è¾‘

```python
def _validate_stop_loss(direction, entry_price, sl_price, leverage, margin):
    """
    ç¡®ä¿æ­¢æŸè§¦å‘åœ¨çˆ†ä»“ä¹‹å‰
    çˆ†ä»“æ¡ä»¶: äºæŸè¾¾åˆ°ä¿è¯é‡‘çš„ 80%
    """
    liquidation_loss = margin * 0.8
    size = (margin * leverage) / entry_price
    
    if direction == "long":
        liquidation_price = entry_price - (liquidation_loss / size)
        if sl_price <= liquidation_price:
            safe_sl = liquidation_price * 1.05  # 5% å®‰å…¨è¾¹é™…
            return False, f"SL below liquidation", safe_sl
    # ...
```

---

## èµ„é‡‘è´¹ç‡æ„ŸçŸ¥ç³»ç»Ÿ (Funding Fee System)

### è®¾è®¡ç›®æ ‡

ä¼ ç»Ÿçš„äº¤æ˜“ç³»ç»Ÿå¾€å¾€å¿½è§†èµ„é‡‘è´¹ç‡ï¼ˆFunding Feeï¼‰çš„å½±å“ï¼Œå¯¼è‡´é•¿æœŸæŒä»“æˆæœ¬è¿‡é«˜ã€‚æœ¬ç³»ç»Ÿå¼•å…¥äº†å®Œæ•´çš„èµ„é‡‘è´¹ç‡æ„ŸçŸ¥æ¨¡å—ï¼Œæ—¨åœ¨ï¼š

1. **è§„é¿é«˜æ˜‚æˆæœ¬**: è‡ªåŠ¨è¯†åˆ«å¹¶è§„é¿éœ€è¦æ”¯ä»˜é«˜é¢èµ„é‡‘è´¹çš„æ—¶æ®µã€‚
2. **æ•æ‰å¥—åˆ©æœºä¼š**: è¯†åˆ«è´Ÿè´¹ç‡ï¼ˆæˆ–åå‘æ­£è´¹ç‡ï¼‰æœºä¼šï¼Œé€šè¿‡æŒä»“â€œèººèµšâ€è´¹ç‡ã€‚
3. **é˜²æ­¢åˆ©æ¶¦ä¾µèš€**: å®æ—¶ç›‘æ§èµ„é‡‘è´¹å¯¹åˆ©æ¶¦çš„ä¾µèš€æ¯”ä¾‹ï¼Œå¿…è¦æ—¶å¼ºåˆ¶å¹³ä»“ã€‚

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ |
|------|------|
| `FundingDataService` | å¯¹æ¥ OKX APIï¼Œè·å–å®æ—¶è´¹ç‡ã€ä¸‹ä¸€æ¬¡ç»“ç®—æ—¶é—´ã€å†å²å¹³å‡å€¼ã€‚ |
| `FundingCostCalculator` | è®¡ç®—æŒæœ‰æˆæœ¬ã€ç›ˆäºå¹³è¡¡ç‚¹ã€äº¤æ˜“å¯è¡Œæ€§ï¼ˆViabilityï¼‰ã€‚ |
| `EntryTimingController` | **å…¥åœºæ—¶æœºä¼˜åŒ–**ï¼šå»ºè®®â€œç«‹å³å…¥åœºâ€è¿˜æ˜¯â€œç­‰å¾…ç»“ç®—åå…¥åœºâ€ã€‚ |
| `HoldingTimeManager` | **åŠ¨æ€ä¹…æœŸç®¡ç†**ï¼šåŸºäºè´¹ç‡é«˜ä½ï¼ŒåŠ¨æ€è®¡ç®—å»ºè®®çš„æœ€å¤§æŒä»“æ—¶é—´ã€‚ |
| `FundingImpactMonitor` | **å®æ—¶ç›‘æ§ä¸å¼ºå¹³**ï¼šåå°ä»»åŠ¡ï¼Œç›‘æ§èµ„é‡‘è´¹/åˆ©æ¶¦å æ¯”ï¼Œè§¦å‘é£æ§ã€‚ |

### å…³é”®ç­–ç•¥é€»è¾‘

#### 1. æ™ºèƒ½å…¥åœº (Entry Timing)

- **æ”¯ä»˜æ–¹ (Paying)**: å¦‚æœè·ç¦»ç»“ç®— < 30åˆ†é’Ÿï¼Œä¸”è´¹ç‡è¾ƒé«˜ï¼Œç³»ç»Ÿä¼šå»ºè®® **å»¶è¿Ÿå…¥åœº** (Delay)ï¼Œç­‰å¾…ç»“ç®—å®Œæˆåå†å¼€ä»“ï¼ŒèŠ‚çœä¸€æ¬¡è´¹ç”¨ã€‚
- **æ”¶å–æ–¹ (Receiving)**: å¦‚æœè·ç¦»ç»“ç®— < 30åˆ†é’Ÿï¼Œç³»ç»Ÿä¼šå»ºè®® **ç«‹å³å…¥åœº** (Enter Now)ï¼Œä»¥æ•è·å³å°†åˆ°æ¥çš„è´¹ç‡æ”¶å…¥ã€‚

#### 2. åŠ¨æ€æŒä»“é™åˆ¶ (Dynamic Holding Limit)

ç³»ç»Ÿä¸å†ä½¿ç”¨å›ºå®šçš„æŒä»“æ—¶é—´é™åˆ¶ï¼Œè€Œæ˜¯åŸºäºè´¹ç‡åŠ¨æ€è®¡ç®— `optimal_holding_hours`ï¼š

- **å…¬å¼**: `æœ€å¤§æŒä»“æ—¶é—´ = (é¢„æœŸåˆ©æ¶¦ * å…è®¸æŸè€—æ¯”) / å•ä½æ—¶é—´è´¹ç‡æˆæœ¬`
- **æ•ˆæœ**: è´¹ç‡è¶Šé«˜ï¼Œå…è®¸æŒä»“çš„æ—¶é—´è¶ŠçŸ­ã€‚è¿«ä½¿ Agent è¿½æ±‚èµ„æœ¬æ•ˆç‡ã€‚

#### 3. åˆ©æ¶¦ä¿æŠ¤ä¸å¼ºå¹³ (Force Close)

- **ç›‘æ§æŒ‡æ ‡**: `è´¹ç‡å½±å“æ¯” (Impact %)` = `ç´¯è®¡å·²ä»˜èµ„é‡‘è´¹` / `å½“å‰æœªå®ç°åˆ©æ¶¦`
- **é˜ˆå€¼é€»è¾‘**:
  - **Impact > 30%**: å‘å‡º WARNING è­¦å‘Šã€‚
  - **Impact > 50%**: è§¦å‘ **CRITICAL å¼ºåˆ¶å¹³ä»“**ã€‚å³ä½¿è´¦é¢å¾®åˆ©ï¼Œä¹Ÿå› ä¸ºè´¹ç‡æŸè€—è¿‡å¤§è€Œå¼ºåˆ¶æ­¢æŸã€‚

### Agent æ•´åˆ

èµ„é‡‘è´¹ç‡ä¿¡æ¯è¢«ç›´æ¥æ³¨å…¥åˆ° `ExecutorAgent` çš„ Prompt ä¸­ï¼š

- **âš ï¸ CRITICAL è­¦å‘Š**: æ˜ç¡®å‘ŠçŸ¥å½“å‰æ˜¯æ”¯ä»˜æ–¹è¿˜æ˜¯æ”¶å–æ–¹ã€‚
- **æˆæœ¬é¢„ä¼°è¡¨**: å±•ç¤ºæŒä»“ 8h/24h çš„é¢„è®¡ç»å¯¹æˆæœ¬ã€‚
- **ç›ˆäºå¹³è¡¡ç‚¹**: å‘ŠçŸ¥ä»·æ ¼éœ€è¦è·‘èµ¢å¤šå°‘æ‰èƒ½è¦†ç›–è´¹ç‡ã€‚
- **æ—¶æœºå»ºè®®**: æ˜ç¡®å»ºè®® "Wait for settlement" æˆ– "Enter now"ã€‚

---

## LangGraph å·¥ä½œæµ

### 7 ä¸ªèŠ‚ç‚¹

```python
workflow_nodes = [
    "market_analysis_node",    # å¸‚åœºæ•°æ®æ”¶é›†
    "signal_generation_node",  # Agent æŠ•ç¥¨
    "risk_assessment_node",    # é£é™©è¯„ä¼°
    "consensus_node",          # å…±è¯†è¾¾æˆ
    "execution_node",          # æ‰§è¡Œäº¤æ˜“ (ExecutorAgent)
    "reflection_node",         # åæ€è®°å½•
    "react_fallback_node"      # é”™è¯¯æ¢å¤
]
```

### æ¡ä»¶è¾¹

```python
# æ˜¯å¦æ‰§è¡Œäº¤æ˜“
def should_execute_or_fallback(state):
    if state.get("error"):
        return "react_fallback"
    return "execution"

# æ˜¯å¦è¿›è¡Œåæ€
def should_reflect(state):
    signal = state.get("final_signal", {})
    if signal.get("direction") in ["long", "short"]:
        return "reflection"
    return END
```

### TradingState ç»“æ„

```python
class TradingState(TypedDict):
    # è¾“å…¥
    position_context: Dict[str, Any]
    market_snapshot: Dict[str, Any]
    
    # ä¸­é—´çŠ¶æ€
    agent_votes: List[Dict]
    leader_summary: str
    risk_assessment: Dict
    
    # è¾“å‡º
    final_signal: Dict
    execution_success: bool
    
    # å…ƒæ•°æ®
    current_node: str
    completed_nodes: List[str]
    node_timings: Dict[str, float]
    error: Optional[str]
```

---

## é‡æ„å˜æ›´è®°å½•

### v2.0 â†’ v3.0 ä¸»è¦å˜æ›´

| å˜æ›´é¡¹ | v2.0 (æ—§) | v3.0 (æ–°) |
|--------|----------|----------|
| **ç¼–æ’æ–¹å¼** | trading_meeting.py å•æ–‡ä»¶ | LangGraph å·¥ä½œæµ |
| **æ‰§è¡Œå™¨** | TradeExecutor (ä¿¡å·ç”Ÿæˆ) | ExecutorAgent (ç›´æ¥äº¤æ˜“) |
| **è§¦å‘å™¨** | å®šæ—¶è½®è¯¢ | TriggerAgent + LLM åˆ†æ |
| **ä»“ä½ç®¡ç†** | open_long_tool å†…éƒ¨åœºæ™¯ | 7 ä¸ªç‹¬ç«‹å·¥å…· |
| **ä»£ç è¡Œæ•°** | ~4,000 è¡Œå•æ–‡ä»¶ | æ¨¡å—åŒ–åˆ†å¸ƒ |

### ç§»é™¤çš„èƒ½åŠ›

| èƒ½åŠ› | åŸå®ç° | çŠ¶æ€ | æ›¿ä»£æ–¹æ¡ˆ |
|------|--------|------|----------|
| **Embedding æœç´¢** | Chroma å‘é‡åº“ | âŒ å·²ç§»é™¤ | ç›´æ¥ API æœç´¢ |
| **RAG çŸ¥è¯†åº“** | embedding + æ£€ç´¢ | âŒ å·²ç§»é™¤ | æ—  |
| **è¯­ä¹‰ç›¸ä¼¼æœç´¢** | å‘é‡ç›¸ä¼¼åº¦ | âŒ å·²ç§»é™¤ | å…³é”®è¯åŒ¹é… |

### ä¿ç•™çš„èƒ½åŠ›

| èƒ½åŠ› | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ­¢æŸéªŒè¯ | âœ… å®Œæ•´ | `_validate_stop_loss()` |
| ä¿è¯é‡‘ç®¡ç† | âœ… å®Œæ•´ | `_get_available_margin()` å«æœªå®ç°ç›ˆäº |
| åå‘æ“ä½œ | âœ… å®Œæ•´ | open_long/short è‡ªåŠ¨å¤„ç† |
| åŠ ä»“å‡ä»“ | âœ… å®Œæ•´ | add_to_long/short, reduce_position |
| Agent æƒé‡ | âœ… å®Œæ•´ | åŠ¨æ€è°ƒæ•´ |
| åæ€å­¦ä¹  | âœ… å®Œæ•´ | ReflectionEngine |

---

## æœªå®ç°ä¸ç§»é™¤çš„èƒ½åŠ›

### 1. Embedding/RAG æœç´¢ (å·²ç§»é™¤)

**åŸå› **: ç»´æŠ¤æˆæœ¬é«˜ï¼Œæ•ˆæœä¸æ˜æ˜¾

**å½±å“**:

- æ— æ³•è¿›è¡Œè¯­ä¹‰ç›¸ä¼¼æœç´¢
- å†å²åˆ†ææŠ¥å‘Šæ— æ³•ä½œä¸ºçŸ¥è¯†åº“

**æ›¿ä»£æ–¹æ¡ˆ**:

- ä½¿ç”¨ Perplexity API å®æ—¶æœç´¢
- å…³é”®è¯åŒ¹é…å†å²è®°å½•

### 2. å¤šäº¤æ˜“å¯¹æ”¯æŒ (æœªå®ç°)

**å½“å‰**: ä»…æ”¯æŒ BTC-USDT-SWAP

**æ‰©å±•æ–¹å‘**:

- æ·»åŠ  ETH-USDT-SWAP
- symbol å‚æ•°åŒ–

### 3. è‡ªåŠ¨æ­¢ç›ˆæ­¢æŸè°ƒæ•´ (éƒ¨åˆ†å®ç°)

**å½“å‰**: ä½¿ç”¨å›ºå®šç™¾åˆ†æ¯” (TP 8%, SL 3%)

**æ”¹è¿›æ–¹å‘**:

- åŸºäº ATR åŠ¨æ€è®¡ç®—
- ç§»åŠ¨æ­¢æŸ (trailing stop)

---

## æ”¹è¿›å»ºè®®ä¸æœªæ¥è§„åˆ’

### âš¡ ä¼˜å…ˆçº§ P0: Agent å¹¶è¡Œæ‰§è¡Œ (ä¸‹ä¸€é˜¶æ®µé‡ç‚¹)

**å½“å‰é—®é¢˜**:

- `signal_generation_node` ä½¿ç”¨å ä½ç¬¦æŠ•ç¥¨
- Agents é¡ºåºæ‰§è¡Œï¼Œæ€»æ—¶é—´ = Î£(å„Agentæ—¶é—´)
- å®é™…å¹¶è¡Œæ³¨é‡Š: "In real implementation, call agents here"

**æ”¹è¿›æ–¹æ¡ˆ**:

```python
# æ”¹è¿›åçš„ signal_generation_node
async def signal_generation_node(state: TradingState) -> Dict[str, Any]:
    """å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰åˆ†æ Agents"""
    agent_configs = [
        ("technical_analyst", TAConfig),
        ("fundamental_analyst", FundConfig),
        ("onchain_analyst", ChainConfig),
        ("macro_analyst", MacroConfig),
        ("sentiment_analyst", SentimentConfig),
    ]
    
    # å¹¶è¡Œåˆ›å»ºå’Œæ‰§è¡Œæ‰€æœ‰ Agents
    tasks = []
    for agent_id, config in agent_configs:
        agent = create_agent(agent_id, config)
        tasks.append(agent.analyze(state.get("market_data")))
    
    # ç­‰å¾…æ‰€æœ‰ Agents å®Œæˆ
    results = await asyncio.gather(*tasks, return_exceptions=True)
    
    # æ”¶é›†æœ‰æ•ˆæŠ•ç¥¨
    votes = []
    for result in results:
        if isinstance(result, Exception):
            logger.error(f"Agent failed: {result}")
        else:
            votes.append(result)
    
    return {"agent_votes": votes}
```

**é¢„æœŸæ”¶ç›Š**:

- 5 ä¸ª Agents Ã— 10s æ¯ä¸ª â†’ ä» 50s é™åˆ° ~15s
- æ›´å¿«çš„äº¤æ˜“å†³ç­–å“åº”
- æ›´å¥½çš„å¸‚åœºæœºä¼šæ•æ‰

**å®ç°æ­¥éª¤**:

1. å°† Agent åˆå§‹åŒ–ç§»åˆ° LangGraph å¤–éƒ¨
2. åœ¨ `signal_generation_node` ä½¿ç”¨ `asyncio.gather()`
3. æ·»åŠ è¶…æ—¶æ§åˆ¶ (å• Agent timeout 30s)
4. æ·»åŠ é”™è¯¯éš”ç¦» (å• Agent å¤±è´¥ä¸å½±å“å…¶ä»–)

---

### çŸ­æœŸ (1-2 å‘¨)

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|------|
| **Agent å¹¶è¡Œæ‰§è¡Œ** | P0 | asyncio.gather å¹¶å‘è°ƒç”¨ |
| é›†æˆæµ‹è¯• | P1 | ç«¯åˆ°ç«¯æµ‹è¯• LangGraph å·¥ä½œæµ |
| è¶…æ—¶å¤„ç† | P1 | å• Agent è¶…æ—¶ä¸é˜»å¡æ•´ä½“ |
| æ—¥å¿—å¢å¼º | P2 | ç»“æ„åŒ–æ—¥å¿— + è¿½è¸ª ID |

### ä¸­æœŸ (1-2 æœˆ)

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|------|
| ATR åŠ¨æ€æ­¢æŸ | P1 | åŸºäºæ³¢åŠ¨ç‡è°ƒæ•´æ­¢æŸè·ç¦» |
| å¤šæ—¶é—´æ¡†æ¶åˆ†æ | P2 | 1h + 4h + 1d ç»¼åˆåˆ¤æ–­ |
| äº‹ä»¶é©±åŠ¨è§¦å‘ | P2 | ç›‘å¬é“¾ä¸Šå¤§é¢è½¬è´¦ |
| Agent æƒé‡è‡ªå­¦ä¹  | P2 | åŸºäºå†å²è¡¨ç°è‡ªåŠ¨è°ƒæ•´ |

### ğŸ›ï¸ äººåœ¨ç¯è·¯ (Human-in-the-Loop) æ¨¡å¼è®¾è®¡

ç³»ç»Ÿæ”¯æŒä¸‰ç§äº¤æ˜“æ¨¡å¼ï¼Œæ»¡è¶³ä¸åŒç”¨æˆ·çš„é£é™©åå¥½å’Œå‚ä¸ç¨‹åº¦ï¼š

#### æ¨¡å¼ 1: å…¨è‡ªåŠ¨æ¨¡å¼ (Full Auto)

**ç‰¹ç‚¹**: å®Œå…¨æ‰˜ç®¡ç»™ç³»ç»Ÿï¼Œæ— éœ€äººå·¥å¹²é¢„

| åŠŸèƒ½ | è¡Œä¸º |
|------|------|
| è§¦å‘åˆ†æ | âœ… è‡ªåŠ¨ (TriggerAgent) |
| å¼€ä»“å†³ç­– | âœ… è‡ªåŠ¨ (ExecutorAgent) |
| ä»“ä½ç®¡ç† | âœ… è‡ªåŠ¨ (åŠ ä»“/å‡ä»“/æ­¢æŸ) |
| å¹³ä»“æ‰§è¡Œ | âœ… è‡ªåŠ¨ (è§¦å‘ TP/SL æˆ–ä¿¡å·åè½¬) |
| ç”¨æˆ·å¹²é¢„ | âŒ æ— éœ€ |

**é€‚ç”¨åœºæ™¯**: é«˜ä¿¡ä»»åº¦ç”¨æˆ·ã€å°èµ„é‡‘è¯•æ°´ã€é•¿æœŸç­–ç•¥éªŒè¯

```python
# é…ç½®ç¤ºä¾‹
TRADING_MODE = "full_auto"
REQUIRE_CONFIRMATION = False
AUTO_EXECUTE_TRADES = True
```

---

#### æ¨¡å¼ 2: åŠè‡ªåŠ¨æ¨¡å¼ (Semi-Auto)

**ç‰¹ç‚¹**: ç³»ç»Ÿæä¾›å»ºè®®ï¼Œç”¨æˆ·ç¡®è®¤æˆ–ä¿®æ”¹åæ‰§è¡Œ

| åŠŸèƒ½ | è¡Œä¸º |
|------|------|
| è§¦å‘åˆ†æ | âœ… è‡ªåŠ¨ |
| å¼€ä»“å†³ç­– | âš ï¸ ç³»ç»Ÿå»ºè®® â†’ ç”¨æˆ·ç¡®è®¤/ä¿®æ”¹ |
| ä»“ä½ç®¡ç† | âš ï¸ ç³»ç»Ÿå»ºè®® â†’ ç”¨æˆ·ç¡®è®¤ |
| å¹³ä»“æ‰§è¡Œ | âš ï¸ ç³»ç»Ÿå»ºè®® â†’ ç”¨æˆ·ç¡®è®¤ |
| ç”¨æˆ·å¹²é¢„ | âœ… æœ€ç»ˆå®¡æ‰¹æƒ |

**äº¤äº’æµç¨‹**:

```
ç³»ç»Ÿåˆ†æå®Œæˆ
     â†“
ç”Ÿæˆäº¤æ˜“å»ºè®® (æ–¹å‘/æ æ†/æ­¢ç›ˆæ­¢æŸ)
     â†“
æ¨é€é€šçŸ¥ç»™ç”¨æˆ· (Telegram/WebSocket/App)
     â†“
ç”¨æˆ·æ“ä½œ:
  â”œâ”€â”€ âœ… ç¡®è®¤æ‰§è¡Œ â†’ ç³»ç»Ÿä¸‹å•
  â”œâ”€â”€ âœï¸ ä¿®æ”¹å‚æ•° â†’ ç³»ç»ŸæŒ‰ä¿®æ”¹åå‚æ•°ä¸‹å•
  â”œâ”€â”€ âŒ æ‹’ç» â†’ ä¸æ‰§è¡Œ
  â””â”€â”€ â° è¶…æ—¶ (å¯é…ç½®) â†’ è‡ªåŠ¨å–æ¶ˆæˆ–è‡ªåŠ¨æ‰§è¡Œ
```

**é…ç½®é€‰é¡¹**:

```python
# é…ç½®ç¤ºä¾‹
TRADING_MODE = "semi_auto"
REQUIRE_CONFIRMATION = True
CONFIRMATION_TIMEOUT_SECONDS = 300  # 5åˆ†é’Ÿè¶…æ—¶
TIMEOUT_ACTION = "cancel"  # cancel / auto_execute
NOTIFICATION_CHANNELS = ["telegram", "websocket"]
```

**UI äº¤äº’ç¤ºä¾‹**:

```json
{
  "signal_id": "sig_20260103_001",
  "type": "trade_suggestion",
  "suggestion": {
    "direction": "long",
    "leverage": 5,
    "amount_percent": 20,
    "tp_percent": 8.0,
    "sl_percent": 3.0,
    "confidence": 78
  },
  "reasoning": "æŠ€æœ¯é¢RSIè¶…å–+èµ„é‡‘è´¹ç‡ä¸ºè´Ÿï¼Œçœ‹æ¶¨ä¿¡å·æ˜ç¡®",
  "actions": ["confirm", "modify", "reject"],
  "expires_at": "2026-01-03T17:05:00Z"
}
```

---

#### æ¨¡å¼ 3: æ‰‹åŠ¨æ¨¡å¼ (Manual)

**ç‰¹ç‚¹**: ç”¨æˆ·å®Œå…¨è‡ªä¸»äº¤æ˜“ï¼Œç³»ç»Ÿä»…æä¾›åˆ†æå’Œå»ºè®®

| åŠŸèƒ½ | è¡Œä¸º |
|------|------|
| è§¦å‘åˆ†æ | âœ… è‡ªåŠ¨ (æˆ–ç”¨æˆ·æ‰‹åŠ¨è§¦å‘) |
| åˆ†ææŠ¥å‘Š | âœ… è‡ªåŠ¨ç”Ÿæˆå¹¶æ¨é€ |
| å¼€ä»“å†³ç­– | âŒ ç”¨æˆ·è‡ªè¡Œæ“ä½œ |
| ä»“ä½ç®¡ç† | âŒ ç”¨æˆ·è‡ªè¡Œæ“ä½œ |
| å¹³ä»“æ‰§è¡Œ | âŒ ç”¨æˆ·è‡ªè¡Œæ“ä½œ |
| ç”¨æˆ·å¹²é¢„ | âœ… å®Œå…¨æ§åˆ¶ |

**ç³»ç»Ÿæä¾›**:

- ğŸ“Š å®æ—¶å¸‚åœºåˆ†ææŠ¥å‘Š
- ğŸ“ˆ æŠ€æœ¯æŒ‡æ ‡å’Œè¶‹åŠ¿é¢„æµ‹
- ğŸ—³ï¸ å¤š Agent æŠ•ç¥¨ç»“æœå’Œå…±è¯†
- âš ï¸ é£é™©æç¤ºå’Œå»ºè®®æ­¢æŸä½
- ğŸ“° é‡å¤§æ–°é—»å’Œå¸‚åœºäº‹ä»¶æé†’

```python
# é…ç½®ç¤ºä¾‹
TRADING_MODE = "manual"
AUTO_EXECUTE_TRADES = False
PUSH_ANALYSIS_REPORTS = True
ANALYSIS_PUSH_CHANNELS = ["telegram", "email", "websocket"]
```

---

#### æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | å…¨è‡ªåŠ¨ | åŠè‡ªåŠ¨ | æ‰‹åŠ¨ |
|------|--------|--------|------|
| è‡ªåŠ¨å¼€ä»“ | âœ… | âŒ éœ€ç¡®è®¤ | âŒ |
| è‡ªåŠ¨å¹³ä»“ | âœ… | âŒ éœ€ç¡®è®¤ | âŒ |
| åˆ†ææŠ¥å‘Š | âœ… | âœ… | âœ… |
| äº¤æ˜“å»ºè®® | âœ… ç›´æ¥æ‰§è¡Œ | âœ… å¾…ç¡®è®¤ | âœ… ä»…ä¾›å‚è€ƒ |
| é£é™©ç­‰çº§ | é«˜ | ä¸­ | ä½ |
| å‚ä¸ç¨‹åº¦ | æ— éœ€å‚ä¸ | å®¡æ‰¹ç¡®è®¤ | å®Œå…¨å‚ä¸ |
| é€‚åˆç”¨æˆ· | é‡åŒ–äº¤æ˜“è€… | æœ‰ç»éªŒäº¤æ˜“è€… | å­¦ä¹ è€…/ä¿å®ˆå‹ |

---

#### å®ç°æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Trading Mode Manager                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              Signal Generation (é€šç”¨)                â”‚    â”‚
â”‚  â”‚  TriggerAgent â†’ LangGraph â†’ AgentæŠ•ç¥¨ â†’ å…±è¯†å»ºè®®     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                            â”‚                                 â”‚
â”‚                            â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Full Auto â”‚ Semi-Auto  â”‚         Manual             â”‚   â”‚
â”‚  â”‚            â”‚            â”‚                            â”‚   â”‚
â”‚  â”‚ ExecutorAgent           â”‚                            â”‚   â”‚
â”‚  â”‚ ç›´æ¥æ‰§è¡Œ   â”‚ æ¨é€å»ºè®®   â”‚         æ¨é€æŠ¥å‘Š           â”‚   â”‚
â”‚  â”‚            â”‚     â†“      â”‚                            â”‚   â”‚
â”‚  â”‚            â”‚ ç­‰å¾…ç”¨æˆ·   â”‚                            â”‚   â”‚
â”‚  â”‚            â”‚ ç¡®è®¤/ä¿®æ”¹  â”‚                            â”‚   â”‚
â”‚  â”‚            â”‚     â†“      â”‚                            â”‚   â”‚
â”‚  â”‚            â”‚ æ‰§è¡Œäº¤æ˜“   â”‚         ç”¨æˆ·è‡ªè¡Œäº¤æ˜“       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### é•¿æœŸ (3-6 æœˆ)

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|------|
| å¤šäº¤æ˜“å¯¹æ”¯æŒ | P1 | ETH, BNB ç­‰ä¸»æµå¸ |
| ç­–ç•¥æ¡†æ¶ | P2 | å¯é…ç½®çš„äº¤æ˜“ç­–ç•¥æ¨¡æ¿ |
| å›æµ‹ç³»ç»Ÿ | P2 | å†å²æ•°æ®å›æµ‹éªŒè¯ |
| é£æ§ä»ªè¡¨æ¿ | P3 | å¯è§†åŒ–ç›‘æ§é¢æ¿ |
| **äººåœ¨ç¯è·¯æ¨¡å¼** | P1 | å®ç°ä¸‰ç§äº¤æ˜“æ¨¡å¼åˆ‡æ¢ |

---

## å¿«é€Ÿå¼€å§‹æŒ‡å—

### æœ¬åœ°å¼€å‘

```bash
# 1. å¯åŠ¨ä¾èµ–æœåŠ¡
docker-compose up -d redis postgres llm_gateway

# 2. è¿è¡Œäº¤æ˜“æœåŠ¡
cd backend/services/report_orchestrator
uvicorn app.main:app --reload --port 8000

# 3. å¯åŠ¨å‰ç«¯ (å¯é€‰)
cd frontend
npm run dev
```

### é…ç½®æ–‡ä»¶

```bash
# .env å…³é”®é…ç½®
OKX_API_KEY=xxx
OKX_SECRET_KEY=xxx
OKX_PASSPHRASE=xxx
OKX_IS_DEMO=true          # true=æ¨¡æ‹Ÿç›˜, false=å®ç›˜

TRIGGER_CHECK_INTERVAL=300        # è§¦å‘å™¨æ£€æŸ¥é—´éš” (ç§’)
TRIGGER_CONFIDENCE_THRESHOLD=60   # è§¦å‘å™¨ä¿¡å¿ƒé˜ˆå€¼

REDIS_HOST=localhost
LLM_GATEWAY_URL=http://localhost:8003
```

### API ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/api/trading/status` | GET | è·å–ç³»ç»ŸçŠ¶æ€ |
| `/api/trading/start` | POST | å¯åŠ¨äº¤æ˜“ç³»ç»Ÿ |
| `/api/trading/stop` | POST | åœæ­¢äº¤æ˜“ç³»ç»Ÿ |
| `/api/trading/history` | GET | è·å–äº¤æ˜“å†å² |
| `/ws/trading/{session_id}` | WS | å®æ—¶äº¤æ˜“æ¨é€ |

---

## é™„å½•

### A. ä»£ç è§„èŒƒ

- æ‰€æœ‰äº¤æ˜“ç›¸å…³ä»£ç ä½¿ç”¨ `async/await`
- æ—¥å¿—æ ¼å¼: `[ModuleName] emoji æ¶ˆæ¯`
- é”™è¯¯å¤„ç†: æ•è·å¹¶è®°å½•ï¼Œè¿”å›é»˜è®¤å®‰å…¨å€¼

### B. ç›¸å…³æ–‡æ¡£

- [ARCHITECTURE.md](/docs/refactoring/ARCHITECTURE.md) - æ¨¡å—æ¶æ„
- [DEPLOY.md](/docs/refactoring/DEPLOY.md) - éƒ¨ç½²æŒ‡å—
- [REFACTORING_PLAN.md](/docs/refactoring/REFACTORING_PLAN.md) - é‡æ„è®¡åˆ’

---

## ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

### æ¨¡æ‹Ÿç›˜ vs å®ç›˜

ç³»ç»Ÿæ”¯æŒä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š

| æ¨¡å¼ | OKX_DEMO_MODE | è¯´æ˜ |
|------|---------------|------|
| æ¨¡æ‹Ÿç›˜ | `true` | ä½¿ç”¨ OKX æ¨¡æ‹Ÿäº¤æ˜“ APIï¼Œæ— çœŸå®èµ„é‡‘é£é™© |
| å®ç›˜ | `false` | ä½¿ç”¨ OKX çœŸå®äº¤æ˜“ APIï¼ŒçœŸé‡‘ç™½é“¶ |

### åˆ‡æ¢åˆ°æ­£å¼ç¯å¢ƒ

#### 1. ä¿®æ”¹ `.env` é…ç½®

```bash
# OKX æ­£å¼ç¯å¢ƒ API (âš ï¸ ä½¿ç”¨æ­£å¼ API Keyï¼Œä¸æ˜¯æ¨¡æ‹Ÿç›˜çš„)
OKX_API_KEY=ä½ çš„æ­£å¼ç¯å¢ƒAPI_KEY
OKX_SECRET_KEY=ä½ çš„æ­£å¼ç¯å¢ƒSECRET_KEY
OKX_PASSPHRASE=ä½ çš„æ­£å¼ç¯å¢ƒPASSPHRASE

# âš ï¸ å…³é”®é…ç½®ï¼šå¿…é¡»è®¾ä¸º false
OKX_DEMO_MODE=false
```

#### 2. é‡æ–°æ„å»ºå¹¶éƒ¨ç½²

```bash
cd trading-standalone
git pull origin dev
./stop.sh && docker compose up -d --build
```

#### 3. éªŒè¯æ­£å¼ç¯å¢ƒ

```bash
# æ£€æŸ¥æ—¥å¿—ç¡®è®¤æ˜¯ REAL æ¨¡å¼
docker logs trading-service 2>&1 | grep -E "REAL|demo"

# åº”è¯¥çœ‹åˆ°:
# OKX REAL account balance: $XXXX.XX
```

### å¤šæœåŠ¡å™¨éƒ¨ç½²

å¦‚æœåŒæ—¶è¿è¡Œæ¨¡æ‹Ÿç›˜å’Œå®ç›˜ï¼Œç¡®ä¿ï¼š

1. **ä½¿ç”¨ä¸åŒçš„æœåŠ¡å™¨æˆ–ç«¯å£**
2. **æ¯ä¸ªæœåŠ¡å™¨çš„ `.env` é…ç½®ç‹¬ç«‹**
3. **å‰ç«¯ä½¿ç”¨åŠ¨æ€ä¸»æœºæ£€æµ‹**ï¼ˆå·²åœ¨ `status.html` ä¸­å®ç°ï¼‰

---

## Bug ä¿®å¤è®°å½• (2026-01)

### ğŸ”§ OKX Demo Mode ç¯å¢ƒå˜é‡æ— æ•ˆ (2026-01-06)

**é—®é¢˜**ï¼šè®¾ç½® `OKX_DEMO_MODE=false` åï¼Œç³»ç»Ÿä»ç„¶è¿æ¥æ¨¡æ‹Ÿç›˜ã€‚

**æ ¹å› **ï¼š`okx_client.py` ä¸­ `__init__` çš„é»˜è®¤å‚æ•° `demo_mode=True` å¯¼è‡´ç¯å¢ƒå˜é‡è¢«å¿½ç•¥ã€‚

```python
# ä¿®å¤å‰ (Bug)
def __init__(self, demo_mode: bool = True):
    self.demo_mode = demo_mode or os.getenv("OKX_DEMO_MODE", "true")
    # demo_mode=Trueï¼Œæ‰€ä»¥ True or ... = True

# ä¿®å¤å
def __init__(self, demo_mode: Optional[bool] = None):
    if demo_mode is None:
        self.demo_mode = os.getenv("OKX_DEMO_MODE", "true").lower() == "true"
    else:
        self.demo_mode = demo_mode
```

**ç›¸å…³æ–‡ä»¶**ï¼š`backend/services/report_orchestrator/app/core/trading/okx_client.py`

---

### ğŸ”§ Insufficient Margin è¯¯æŠ¥ (2026-01-06)

**é—®é¢˜**ï¼šäº¤æ˜“å®é™…æˆåŠŸæ‰§è¡Œï¼Œä½†ä¿¡å·çš„ reasoning æ˜¾ç¤º `[insufficient_margin]`ã€‚

**æ ¹å› **ï¼šç³»ç»Ÿæœ‰**åŒé‡æ‰§è¡Œè·¯å¾„**ï¼š

1. `ExecutorAgent` å…ˆæ‰§è¡Œï¼Œè°ƒç”¨ `_get_available_margin()` è¿”å› 0ï¼ˆå› ä¸ºä½¿ç”¨äº† paper_traderï¼‰
2. `trading_routes.py` åæ‰§è¡Œï¼Œç”¨ `OKXTrader` æˆåŠŸå¼€ä»“
3. ä½† reasoning æ¥è‡ª ExecutorAgent çš„é”™è¯¯æ ‡ç­¾

**ä¿®å¤**ï¼šåœ¨ `trading_routes.py` ä¸­ï¼Œä¼˜å…ˆä½¿ç”¨ OKX `order_id` ä½œä¸ºæˆåŠŸçš„ç¡®å®šæ€§è¯æ®ï¼š

```python
# å¦‚æœæœ‰ OKX order_idï¼Œäº¤æ˜“ä¸€å®šæˆåŠŸäº†
if order_id and trade_success:
    trade_actually_executed = True
    # ä¿®å¤é”™è¯¯çš„ reasoning tag
    if signal and "[insufficient_margin]" in signal.reasoning:
        signal.reasoning = signal.reasoning.replace("[insufficient_margin]", "[new_long]")
```

**ç›¸å…³æ–‡ä»¶**ï¼š`backend/services/report_orchestrator/app/api/trading_routes.py`

---

### ğŸ”§ å‰ç«¯ Dashboard æœåŠ¡å™¨ URL ç¡¬ç¼–ç  (2026-01-06)

**é—®é¢˜**ï¼šè®¿é—®ä¸åŒæœåŠ¡å™¨çš„ Dashboard æ—¶ï¼Œæ•°æ®éƒ½æ¥è‡ªåŒä¸€ä¸ªæœåŠ¡å™¨ã€‚

**æ ¹å› **ï¼š`status.html` ä¸­ç¡¬ç¼–ç äº†æœåŠ¡å™¨ IPï¼š

```javascript
// ä¿®å¤å‰ (Bug)
const SERVER = 'http://45.76.159.149:9000';

// ä¿®å¤å
const SERVER = `http://${window.location.hostname}:9000`;
```

**ç›¸å…³æ–‡ä»¶**ï¼š`trading-standalone/status.html`

---

### ğŸ”§ ä¿è¯é‡‘è®¡ç®—ä½¿ç”¨é”™è¯¯æ•°æ®æº (2026-01-05)

**é—®é¢˜**ï¼š`_get_available_margin()` è¿”å› 0ï¼Œå¯¼è‡´æ‰€æœ‰äº¤æ˜“è¢«æ ‡è®°ä¸º insufficient_marginã€‚

**æ ¹å› **ï¼šå‡½æ•°ä½¿ç”¨ `self.paper_trader.get_status()` ä½† paper_trader æœªæ­£ç¡®é…ç½®ã€‚

**ä¿®å¤**ï¼šä¼˜å…ˆä½¿ç”¨ OKX çš„ `max_avail_size`ï¼š

```python
max_avail = status.get("max_avail_size", 0)  # OKX API è¿”å›çš„çœŸå®å¯ç”¨ä¿è¯é‡‘
if max_avail > 0:
    true_available = max_avail
else:
    true_available = available + max(unrealized_pnl, 0)
```

**ç›¸å…³æ–‡ä»¶**ï¼š`backend/services/report_orchestrator/app/core/trading/executor_agent.py`

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: äº¤æ˜“æˆåŠŸä½†çŠ¶æ€æ˜¾ç¤º "failed"

**æ£€æŸ¥**ï¼š

1. æŸ¥çœ‹æ—¥å¿—ä¸­çš„ `order_id`ï¼Œå¦‚æœå­˜åœ¨è¯´æ˜äº¤æ˜“æˆåŠŸ
2. æ£€æŸ¥ reasoning æ˜¯å¦æœ‰ `[insufficient_margin]` ç­‰é”™è¯¯æ ‡ç­¾
3. ç¡®è®¤å·²éƒ¨ç½²æœ€æ–°ä»£ç 

### Q2: OKX è¿æ¥å¤±è´¥

**æ£€æŸ¥**ï¼š

1. API Key æƒé™æ˜¯å¦åŒ…å« Trade
2. IP ç™½åå•æ˜¯å¦é…ç½®æ­£ç¡®
3. `OKX_DEMO_MODE` ä¸ API Key ç±»å‹æ˜¯å¦åŒ¹é…

```bash
# æµ‹è¯• OKX è¿æ¥
docker exec trading-service python3 -c "
import asyncio
from app.core.trading.okx_client import OKXClient

async def test():
    client = OKXClient()
    await client.initialize()
    balance = await client.get_account_balance()
    print(f'Demo Mode: {client.demo_mode}')
    print(f'Balance: \${balance.total_equity:.2f}')
    await client.close()

asyncio.run(test())
"
```

### Q3: å‰ç«¯æ˜¾ç¤ºå…¶ä»–æœåŠ¡å™¨çš„æ•°æ®

**è§£å†³**ï¼š

1. å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨ (Cmd+Shift+R)
2. ç¡®è®¤è®¿é—®çš„ URL æ˜¯æ­£ç¡®çš„æœåŠ¡å™¨ IP
3. æ£€æŸ¥ `status.html` æ˜¯å¦ä½¿ç”¨äº†åŠ¨æ€ä¸»æœºæ£€æµ‹

### Q4: æ—¥å¿—ä¸­çœ‹ä¸åˆ° ExecutorAgent ä¿¡æ¯

**æ£€æŸ¥**ï¼š

1. Docker é•œåƒæ˜¯å¦é‡æ–°æ„å»º (`docker compose up -d --build`)
2. æ£€æŸ¥å®¹å™¨å†…ä»£ç ç‰ˆæœ¬

```bash
docker exec trading-service cat /app/app/core/trading/executor_agent.py | head -20
```

---

## é™„å½•

### C. ç¯å¢ƒå˜é‡å®Œæ•´åˆ—è¡¨

```bash
# OKX API é…ç½®
OKX_API_KEY=                    # API Key
OKX_SECRET_KEY=                 # Secret Key
OKX_PASSPHRASE=                 # Passphrase
OKX_DEMO_MODE=true              # true=æ¨¡æ‹Ÿç›˜, false=å®ç›˜

# äº¤æ˜“å‚æ•°
DEFAULT_LEVERAGE=5              # é»˜è®¤æ æ†
MAX_LEVERAGE=20                 # æœ€å¤§æ æ†
DEFAULT_POSITION_PERCENT=20     # é»˜è®¤ä»“ä½æ¯”ä¾‹ (%)
MIN_POSITION_PERCENT=10         # æœ€å°ä»“ä½æ¯”ä¾‹ (%)
MAX_POSITION_PERCENT=30         # æœ€å¤§ä»“ä½æ¯”ä¾‹ (%)
DEFAULT_TP_PERCENT=8            # é»˜è®¤æ­¢ç›ˆ (%)
DEFAULT_SL_PERCENT=3            # é»˜è®¤æ­¢æŸ (%)

# è§¦å‘å™¨é…ç½®
TRIGGER_INTERVAL_SECONDS=300    # æ£€æŸ¥é—´éš” (ç§’)
TRIGGER_COOLDOWN_MINUTES=30     # å†·å´æ—¶é—´ (åˆ†é’Ÿ)
FAST_MONITOR_ENABLED=true       # å¿«é€Ÿç›‘æ§å¼€å…³

# LLM é…ç½®
GOOGLE_API_KEY=                 # Gemini API Key
DEEPSEEK_API_KEY=               # DeepSeek API Key

# æœåŠ¡é…ç½®
REDIS_HOST=redis                # Redis ä¸»æœº
LLM_GATEWAY_URL=http://llm_gateway:8003
```

### D. è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»é¡¹ç›®ç»´æŠ¤è€…æˆ–æäº¤ Issueã€‚

---

*æœ€åæ›´æ–°: 2026-01-06 by Antigravity AI Assistant*
