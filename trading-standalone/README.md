# Magellan Trading Standalone

轻量级自动交易服务，专为服务器后台运行设计。

## 特点

- **精简部署**: 仅运行 3 个 Docker 服务 (Redis + LLM Gateway + Trading Service)
- **完整交易能力**: 包含所有 AI 分析 Agent (技术分析师、宏观经济学家、量化策略师等)
- **配置文件驱动**: 所有参数通过 `config.yaml` 配置
- **邮件通知**: 交易决策时自动发送邮件
- **简单操作**: `start.sh` / `stop.sh` / `logs.sh`

## 架构说明

交易系统使用 Magellan 的圆桌会议 (Roundtable) 框架来进行多 Agent 协作分析：

```
交易分析流程:
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  技术分析师  │    │ 宏观经济学家 │    │ 情绪分析师  │
│ 趋势/指标分析│    │ 宏观环境分析 │    │ 市场情绪分析│
└──────┬──────┘    └──────┬──────┘    └──────┬──────┘
       │                  │                  │
       └──────────────────┼──────────────────┘
                          ▼
               ┌─────────────────────┐
               │    量化策略师       │
               │  综合各方观点投票   │
               └──────────┬──────────┘
                          ▼
               ┌─────────────────────┐
               │    风险评估师       │
               │  最终风控审批       │
               └──────────┬──────────┘
                          ▼
               ┌─────────────────────┐
               │   交易信号执行      │
               │  LONG/SHORT/HOLD   │
               └─────────────────────┘
```

**注意**: Trading Service 使用的是完整的 `report_orchestrator` 镜像，但只调用交易相关的 API。其他功能（DD分析、报告生成等）代码存在但不会被使用，不消耗额外资源。

## 快速开始

### 1. 配置环境变量

```bash
cp .env.example .env
# 编辑 .env 填入你的 API Keys
```

### 2. 调整配置

编辑 `config.yaml` 设置:
- 交易参数 (杠杆、仓位、止盈止损)
- 分析间隔
- LLM 模型选择
- 邮件通知设置

### 3. 启动服务

```bash
chmod +x *.sh
./start.sh
```

## 命令说明

| 命令 | 功能 |
|------|------|
| `./start.sh` | 启动所有服务并开始交易 |
| `./stop.sh` | 停止所有服务 |
| `./status.sh` | 查看当前状态 |
| `./logs.sh` | 查看日志 |
| `./logs.sh trading -f` | 实时跟踪交易日志 |
| `./logs.sh -n 50 llm` | 查看 LLM 服务最近 50 行日志 |

## 配置说明

### config.yaml 主要参数

```yaml
trading:
  symbol: "BTC-USDT-SWAP"    # 交易对
  leverage: 10               # 杠杆倍数
  position_size: 100         # 每次交易金额 (USDT)
  take_profit_percent: 5.0   # 止盈百分比
  stop_loss_percent: 3.0     # 止损百分比
  demo_mode: true            # 模拟盘模式

scheduler:
  interval_hours: 4          # 分析间隔 (小时)

llm:
  provider: "gemini"         # 模型提供商
```

### 邮件通知

配置 `email` 部分启用邮件通知:

```yaml
email:
  enabled: true
  smtp_server: "smtp.gmail.com"
  smtp_port: 587
  # ... 其他配置
  notify_on:
    - decision       # 每次决策
    - execution      # 交易执行
    - tp_hit         # 止盈触发
    - sl_hit         # 止损触发
    - error          # 系统错误
```

## 服务架构

```
┌─────────────────────────────────────────────────────────────┐
│                   trading-standalone                        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐      ┌─────────────────┐               │
│  │     Redis       │      │   LLM Gateway   │               │
│  │    (256MB)      │      │    (512MB)      │               │
│  │  - 状态存储     │      │  - Gemini       │               │
│  │  - 账户数据     │      │  - Kimi         │               │
│  │  - 持仓信息     │      │  - DeepSeek     │               │
│  │  - 交易历史     │      │  - Web Search   │               │
│  └────────┬────────┘      └────────┬────────┘               │
│           │                        │                        │
│           └────────────┬───────────┘                        │
│                        ▼                                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │          Trading Service (report_orchestrator)      │   │
│  │                     (768MB)                         │   │
│  │  ┌─────────────────────────────────────────────┐   │   │
│  │  │              交易 Agent 团队                 │   │   │
│  │  │  - 技术分析师 (K线/指标)                    │   │   │
│  │  │  - 宏观经济学家 (市场环境)                  │   │   │
│  │  │  - 情绪分析师 (新闻/社交)                   │   │   │
│  │  │  - 量化策略师 (投票/决策)                   │   │   │
│  │  │  - 风险评估师 (风控/审批)                   │   │   │
│  │  └─────────────────────────────────────────────┘   │   │
│  │  ┌──────────────────┐  ┌──────────────────┐       │   │
│  │  │  OKX Client      │  │  Position Monitor│       │   │
│  │  │  - Demo Trading  │  │  - TP/SL 监控    │       │   │
│  │  │  - API 调用      │  │  - PnL 追踪      │       │   │
│  │  └──────────────────┘  └──────────────────┘       │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘

内存使用: Redis(256MB) + LLM Gateway(512MB) + Trading(768MB) ≈ 1.5GB
```

## 服务器部署建议

### 推荐配置

- **内存**: 4GB (最低 2GB)
- **CPU**: 2 核
- **存储**: 20GB
- **地区**: 香港/新加坡 (访问 Gemini/Tavily)

### 云服务推荐

| 提供商 | 地区 | 配置 | 月费 |
|--------|------|------|------|
| 阿里云 | 香港 | 2C4G | ~$15 |
| 腾讯云 | 香港 | 2C4G | ~$15 |
| Vultr | 新加坡 | 2C4G | ~$20 |
| DigitalOcean | 新加坡 | 2C4G | ~$24 |

## 监控

### 查看状态

```bash
./status.sh
```

输出示例:
```
=== Trading Status ===
State: running
Next Run: 2024-12-02T08:00:00
Last Run: 2024-12-02T04:00:00

=== Current Position ===
Side: LONG
Size: 100 USDT
Entry: $95,000.00
PnL: +5.23 USDT (+0.52%)
```

### 查看日志

#### 推荐: 查看Agent讨论 (清爽模式)

```bash
# 只显示agent讨论和工具调用结果,过滤掉prompt/API等噪音
./view-agents.sh
```

**输出效果**:
- 带颜色高亮显示
- 只显示关键信息: agent讨论、工具调用、投票结果、最终决策
- 过滤掉: HTTP请求、LLM API调用、prompt构造、JSON dumps等

#### 其他日志查看方式

```bash
# 查看完整日志 (包含prompt、API调用等详细信息)
./view-logs.sh

# 简化日志
./logs.sh

# 实时跟踪交易日志
./logs.sh trading -f

# 查看最近 200 行
./logs.sh -n 200
```

**日志工具对比**:

| 工具 | 内容 | 适用场景 |
|------|------|----------|
| `view-agents.sh` | **仅Agent讨论和工具调用** (带颜色) | **日常监控、了解决策过程** ⭐ 推荐 |
| `view-logs.sh` | 全部日志:API调用、Prompt、响应、错误等 | 调试问题、查看完整流程 |
| `logs.sh` | 简化日志:核心事件 | 快速浏览 |

## 故障排除

### 服务无法启动

```bash
# 检查 Docker 状态
docker ps -a

# 查看详细日志
./logs.sh -n 200

# 重启服务
./stop.sh && ./start.sh
```

### 交易未执行

1. 检查 OKX API Keys 是否正确
2. 确认使用的是模拟盘 API
3. 查看日志中的错误信息

### 邮件发送失败

1. 确认 SMTP 配置正确
2. Gmail 需要开启 "应用专用密码"
3. 测试邮件: `python scripts/email_notifier.py test`

## 安全提示

1. **不要将 .env 文件提交到 Git**
2. 生产环境建议使用模拟盘先测试
3. 设置合理的止损避免过大损失
4. 定期检查系统运行状态
